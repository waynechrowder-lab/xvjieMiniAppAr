/* 
* version: 1.5.2-dev1
* buildTime: 2025/1/3 14:53:32
*/
(function(nt,P){typeof exports=="object"&&typeof module<"u"?P(exports):typeof define=="function"&&define.amd?define(["exports"],P):(nt=typeof globalThis<"u"?globalThis:nt||self,P(nt["tiny-ar-plugin"]={}))})(this,function(nt){"use strict";var P=(r=>(r[r.None=0]="None",r[r.Camera=1]="Camera",r[r.Dof3=2]="Dof3",r[r.Dof5=3]="Dof5",r[r.Dof6=4]="Dof6",r))(P||{}),Q=(r=>(r[r.ARSession=1]="ARSession",r[r.EasyAR=2]="EasyAR",r[r.VKSession=3]="VKSession",r[r.BaseCamera=4]="BaseCamera",r))(Q||{}),Mt=(r=>(r.WorldTracking="worldTracking",r.OrientationTracking="orientationTracking",r.CAMERA="camera",r))(Mt||{}),ne=(r=>(r[r.ERROR=0]="ERROR",r[r.WARN=1]="WARN",r[r.INFO=2]="INFO",r[r.DEBUG=3]="DEBUG",r))(ne||{});class ts{constructor(t=2){this.level=t}setLevel(t){this.level=t}_log(t=2,...e){if(t<=this.level)switch(t){case 0:console.error(`[ARManager:${ne[t]}]`,...e);break;case 1:console.warn(`[ARManager:${ne[t]}]`,...e);break;case 2:console.info(`[ARManager:${ne[t]}]`,...e);break;case 3:console.log(`[ARManager:${ne[t]}]`,...e);break}}error(...t){this._log(0,...t)}warn(...t){this._log(1,...t)}info(...t){this._log(2,...t)}log(...t){this._log(3,...t)}}const I=new ts(2);var At=(r=>(r.Wechat="Wechat",r))(At||{});const oe="2.0.12",le=function(r){function t(){}function e(l,h){if(l=l===void 0?"utf-8":l,h=h===void 0?{fatal:!1}:h,n.indexOf(l.toLowerCase())===-1)throw new RangeError("Failed to construct 'TextDecoder': The encoding label provided ('"+l+"') is invalid.");if(h.fatal)throw Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}function i(l){return Buffer.from(l.buffer,l.byteOffset,l.byteLength).toString("utf-8")}function s(l){var h=URL.createObjectURL(new Blob([l],{type:"text/plain;charset=UTF-8"}));try{var c=new XMLHttpRequest;return c.open("GET",h,!1),c.send(),c.responseText}catch{return a(l)}finally{URL.revokeObjectURL(h)}}function a(l){for(var h=0,c=Math.min(65536,l.length+1),m=new Uint16Array(c),d=[],g=0;;){var f=h<l.length;if(!f||g>=c-1){if(d.push(String.fromCharCode.apply(null,m.subarray(0,g))),!f)return d.join("");l=l.subarray(h),g=h=0}if(f=l[h++],(f&128)===0)m[g++]=f;else if((f&224)===192){var v=l[h++]&63;m[g++]=(f&31)<<6|v}else if((f&240)===224){v=l[h++]&63;var S=l[h++]&63;m[g++]=(f&31)<<12|v<<6|S}else if((f&248)===240){v=l[h++]&63,S=l[h++]&63;var C=l[h++]&63;f=(f&7)<<18|v<<12|S<<6|C,65535<f&&(f-=65536,m[g++]=f>>>10&1023|55296,f=56320|f&1023),m[g++]=f}}}if(r.TextEncoder&&r.TextDecoder)return!1;var n=["utf-8","utf8","unicode-1-1-utf-8"];Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),t.prototype.encode=function(l,h){if(h=h===void 0?{stream:!1}:h,h.stream)throw Error("Failed to encode: the 'stream' option is unsupported.");h=0;for(var c=l.length,m=0,d=Math.max(32,c+(c>>>1)+7),g=new Uint8Array(d>>>3<<3);h<c;){var f=l.charCodeAt(h++);if(55296<=f&&56319>=f){if(h<c){var v=l.charCodeAt(h);(v&64512)===56320&&(++h,f=((f&1023)<<10)+(v&1023)+65536)}if(55296<=f&&56319>=f)continue}if(m+4>g.length&&(d+=8,d*=1+h/l.length*2,d=d>>>3<<3,v=new Uint8Array(d),v.set(g),g=v),(f&4294967168)===0)g[m++]=f;else{if((f&4294965248)===0)g[m++]=f>>>6&31|192;else if((f&4294901760)===0)g[m++]=f>>>12&15|224,g[m++]=f>>>6&63|128;else if((f&4292870144)===0)g[m++]=f>>>18&7|240,g[m++]=f>>>12&63|128,g[m++]=f>>>6&63|128;else continue;g[m++]=f&63|128}}return g.slice?g.slice(0,m):g.subarray(0,m)},Object.defineProperty(e.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(e.prototype,"fatal",{value:!1}),Object.defineProperty(e.prototype,"ignoreBOM",{value:!1});var o=a;return typeof Buffer=="function"&&Buffer.from?o=i:typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function"&&(o=s),e.prototype.decode=function(l,h){if(h=h===void 0?{stream:!1}:h,h.stream)throw Error("Failed to decode: the 'stream' option is unsupported.");return l=l instanceof Uint8Array?l:l.buffer instanceof ArrayBuffer?new Uint8Array(l.buffer):new Uint8Array(l),o(l)},r.TextEncoder=t,r.TextDecoder=e,r}(typeof window<"u"?window:typeof global<"u"?global:globalThis),Le=class{static log(...r){!Le.flag||Le.platform==At.Wechat&&console.log(...r)}};let G=Le;G.flag=!1,G.platform=null;function hi(r){return(t,e=null)=>{let i=!1;r(s=>{if(!i)return i=!0,t.call(e,s)},null)}}function es(r){return new Promise(t=>hi(r)(t))}function is(r){const t=new lt;return r.then(e=>{t.fire(e)},()=>{t.fire(void 0)}),t.event}function Pe(r,t){return r(e=>t(e))}let ss=0;class ze{constructor(t){this.value=t,this.id=ss++}}class lt{constructor(){this._disposed=!1,this._size=0,this._deliveryQueue=new ui}dispose(){var t;this._disposed||(this._disposed=!0,((t=this._deliveryQueue)==null?void 0:t.current)===this&&this._deliveryQueue.reset(),this._listeners&&(this._listeners=void 0,this._size=0))}get event(){return this._event!=null||(this._event=(t,e)=>{if(this._disposed)return;e&&(t=t.bind(e));const i=new ze(t);this._listeners?this._listeners instanceof ze?(this._deliveryQueue!=null||(this._deliveryQueue=new ui),this._listeners=[this._listeners,i]):this._listeners.push(i):this._listeners=i,this._size++}),this._event}_deliver(t,e){if(t)try{t.value(e)}catch{}}_deliverQueue(t){const e=t.current._listeners;for(;t.i<t.end;)this._deliver(e[t.i++],t.value);t.reset()}fire(t){var e;if((e=this._deliveryQueue)!=null&&e.current&&this._deliverQueue(this._deliveryQueue),this._listeners)if(this._listeners instanceof ze)this._deliver(this._listeners,t);else{const i=this._deliveryQueue;i.enqueue(this,t,this._listeners.length),this._deliverQueue(i)}}hasListeners(){return this._size>0}}class ui{constructor(){this.i=-1,this.end=0}enqueue(t,e,i){this.i=0,this.end=i,this.current=t,this.value=e}reset(){this.i=this.end,this.current=void 0,this.value=void 0}}const Dt=Object.freeze(Object.defineProperty({__proto__:null,once:hi,toPromise:es,fromPromise:is,makeSubscription:Pe,Emitter:lt},Symbol.toStringTag,{value:"Module"}));class mi{static clamp01(t){let e=t;return e>1?1:e<0?0:e}static clamp(t,e,i){return t<e?e:t>i?i:t}}const St=class{get normalized(){return St.createByVec(this).normalize()}constructor(r,t,e){this.x=r||0,this.y=t||0,this.z=e||0}normalize(){let r=this.magnitude();return r>St.kEpsilon?this.div(r):(this.x=0,this.y=0,this.z=0),this}set(r,t,e){return this.x=r,this.y=t,this.z=e,this}setByArray(r){return this.x=r[0],this.y=r[1],this.z=r[2],this}setByVec(r){return this.x=r.x,this.y=r.y,this.z=r.z,this}clone(){return new St(this.x,this.y,this.z)}scale(r){return this.x*=r,this.y*=r,this.z*=r,this}add(r){return this.x+=r.x,this.y+=r.y,this.z+=r.z,this}sub(r){return this.x-=r.x,this.y-=r.y,this.z-=r.z,this}div(r){return this.x=this.x/r,this.y=this.y/r,this.z=this.z/r,this}sqrMagnitude(){return this.x*this.x+this.y*this.y+this.z*this.z}magnitude(){return Math.sqrt(this.sqrMagnitude())}equals(r){return this.x===r.x&&this.y===r.y&&this.z===r.z}static create(r,t,e){return new St().set(r,t,e)}static createByArray(r){return new St().setByArray(r)}static createByVec(r){return new St().setByVec(r)}static sub(r,t){return new St(r.x-t.x,r.y-t.y,r.z-t.z)}static subNum(r,t){return new St(r.x-t,r.y-t,r.z-t)}static add(r,t){return new St(r.x+t.x,r.y+t.y,r.z+t.z)}static addNum(r,t){return new St(r.x+t,r.y+t,r.z+t)}static scale(r,t){return this.create(r.x*t,r.y*t,r.z*t)}static div(r,t){return this.createByVec(r).div(t)}static sqrMagnitude(r){return r.x*r.x+r.y*r.y+r.z*r.z}static magnitude(r){return Math.sqrt(this.sqrMagnitude(r))}static cross(r,t){return this.create(r.y*t.z-r.z*t.y,r.z*t.x-r.x*t.z,r.x*t.y-r.y*t.x)}static dot(r,t){return r.x*t.x+r.y*t.y+r.z*t.z}static angle(r,t){let e=this.dot(r,t)/(this.magnitude(r)*this.magnitude(t));return Math.acos(e)*180/Math.PI}static clone(r){return this.create(r.x,r.y,r.z)}static distanceSq(r,t){let e=r.x-t.x,i=r.y-t.y,s=r.z-t.z;return e*e+i*i+s*s}static distance(r,t){return Math.sqrt(this.distanceSq(r,t))}static lerp(r,t,e){return e=mi.clamp01(e),this.create(r.x+(t.x-r.x)*e,r.y+(t.y-r.y)*e,r.z+(t.z-r.z)*e)}static lerpUnclamped(r,t,e){return this.create(r.x+(t.x-r.x)*e,r.y+(t.y-r.y)*e,r.z+(t.z-r.z)*e)}static toString(r){return`{ x: ${r.x}, y: ${r.y}, z: ${r.z}}`}};let et=St;et.kEpsilon=1e-5,et.kEpsilonNormalSqrt=1e-15,et.zero={x:0,y:0,z:0},et.one={x:1,y:1,z:1},et.half={x:.5,y:.5,z:.5},et.up={x:0,y:1,z:0},et.down={x:0,y:-1,z:0},et.left={x:-1,y:0,z:0},et.right={x:1,y:0,z:0},et.forward={x:0,y:0,z:1},et.backward={x:0,y:0,z:-1};class pt{constructor(){this.y180Array=[0,1,0,0],this.x=0,this.y=0,this.z=0,this.w=0}set(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}multiply(t){return this.multiplyQuaternions(this,t)}multiplyQuaternions(t,e){const i=t.x,s=t.y,a=t.z,n=t.w,o=e.x,l=e.y,h=e.z,c=e.w;return this.x=i*c+n*o+s*h-a*l,this.y=s*c+n*l+a*o-i*h,this.z=a*c+n*h+i*l-s*o,this.w=n*c-i*o-s*l-a*h,this}setFromMat4(t){let e=this,i,s,a,n,o,l,h,c,m,d,g,f,v,S,C;return i=t.data[0],s=t.data[1],a=t.data[2],n=t.data[4],o=t.data[5],l=t.data[6],h=t.data[8],c=t.data[9],m=t.data[10],v=i*i+s*s+a*a,v===0||(v=1/Math.sqrt(v),S=n*n+o*o+l*l,S===0)||(S=1/Math.sqrt(S),C=h*h+c*c+m*m,C===0)||(C=1/Math.sqrt(C),i*=v,s*=v,a*=v,n*=S,o*=S,l*=S,h*=C,c*=C,m*=C,d=i+o+m,d>=0?(g=Math.sqrt(d+1),e.w=g*.5,g=.5/g,e.x=(l-c)*g,e.y=(h-a)*g,e.z=(s-n)*g):i>o?i>m?(f=i-(o+m)+1,f=Math.sqrt(f),e.x=f*.5,f=.5/f,e.w=(l-c)*f,e.y=(s+n)*f,e.z=(a+h)*f):(f=m-(i+o)+1,f=Math.sqrt(f),e.z=f*.5,f=.5/f,e.w=(s-n)*f,e.x=(h+a)*f,e.y=(c+l)*f):o>m?(f=o-(m+i)+1,f=Math.sqrt(f),e.y=f*.5,f=.5/f,e.w=(h-a)*f,e.z=(l+c)*f,e.x=(n+s)*f):(f=m-(i+o)+1,f=Math.sqrt(f),e.z=f*.5,f=.5/f,e.w=(s-n)*f,e.x=(h+a)*f,e.y=(c+l)*f)),e}slerp(t,e,i){const s=t.x,a=t.y,n=t.z,o=t.w;let l=e.x,h=e.y,c=e.z,m=e.w,d=o*m+s*l+a*h+n*c;if(d<0&&(m=-m,l=-l,h=-h,c=-c,d=-d),Math.abs(d)>=1)return this.w=o,this.x=s,this.y=a,this.z=n,this;const g=Math.acos(d),f=Math.sqrt(1-d*d);if(Math.abs(f)<.001)return this.w=o*.5+m*.5,this.x=s*.5+l*.5,this.y=a*.5+h*.5,this.z=n*.5+c*.5,this;const v=Math.sin((1-i)*g)/f,S=Math.sin(i*g)/f;return this.w=o*v+m*S,this.x=s*v+l*S,this.y=a*v+h*S,this.z=n*v+c*S,this}}pt.identity={x:0,y:0,z:0,w:1};class K{constructor(){this.data=null;let t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t}get array(){return this.data?Array.from(this.data):null}set(t){for(let e=0;e<t.length;e++)this.data[e]=t[e];return this}clone(){let t=new K;return t.set(this.data),t}setTRS(t,e,i){var s,a,n,o,l,h,c,m,d,g,f,v,S,C,R,N,V,q,B,U,D,H,O;return s=t.x,a=t.y,n=t.z,o=e.x,l=e.y,h=e.z,c=e.w,m=i.x,d=i.y,g=i.z,f=o+o,v=l+l,S=h+h,C=o*f,R=o*v,N=o*S,V=l*v,q=l*S,B=h*S,U=c*f,D=c*v,H=c*S,O=this.data,O[0]=(1-(V+B))*m,O[1]=(R+H)*m,O[2]=(N-D)*m,O[3]=0,O[4]=(R-H)*d,O[5]=(1-(C+B))*d,O[6]=(q+U)*d,O[7]=0,O[8]=(N+D)*g,O[9]=(q-U)*g,O[10]=(1-(C+V))*g,O[11]=0,O[12]=s,O[13]=a,O[14]=n,O[15]=1,this}transpose(){let t=this.data,e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}getInverse(){let t=this.data,e=[],i=t[0],s=t[1],a=t[2],n=t[3],o=t[4],l=t[5],h=t[6],c=t[7],m=t[8],d=t[9],g=t[10],f=t[11],v=t[12],S=t[13],C=t[14],R=t[15],N=d*C*c-S*g*c+S*h*f-l*C*f-d*h*R+l*g*R,V=v*g*c-m*C*c-v*h*f+o*C*f+m*h*R-o*g*R,q=m*S*c-v*d*c+v*l*f-o*S*f-m*l*R+o*d*R,B=v*d*h-m*S*h-v*l*g+o*S*g+m*l*C-o*d*C,U=i*N+s*V+a*q+n*B;if(U<=Number.EPSILON)throw new Error("error!");let D=1/U;return e[0]=N*D,e[1]=(S*g*n-d*C*n-S*a*f+s*C*f+d*a*R-s*g*R)*D,e[2]=(l*C*n-S*h*n+S*a*c-s*C*c-l*a*R+s*h*R)*D,e[3]=(d*h*n-l*g*n-d*a*c+s*g*c+l*a*f-s*h*f)*D,e[4]=V*D,e[5]=(m*C*n-v*g*n+v*a*f-i*C*f-m*a*R+i*g*R)*D,e[6]=(v*h*n-o*C*n-v*a*c+i*C*c+o*a*R-i*h*R)*D,e[7]=(o*g*n-m*h*n+m*a*c-i*g*c-o*a*f+i*h*f)*D,e[8]=q*D,e[9]=(v*d*n-m*S*n-v*s*f+i*S*f+m*s*R-i*d*R)*D,e[10]=(o*S*n-v*l*n+v*s*c-i*S*c-o*s*R+i*l*R)*D,e[11]=(m*l*n-o*d*n-m*s*c+i*d*c+o*s*f-i*l*f)*D,e[12]=B*D,e[13]=(m*S*a-v*d*a+v*s*g-i*S*g-m*s*C+i*d*C)*D,e[14]=(v*l*a-o*S*a-v*s*h+i*S*h+o*s*C-i*l*C)*D,e[15]=(o*d*a-m*l*a+m*s*h-i*d*h-o*s*g+i*l*g)*D,this.data.set(e),this}determinant(){const t=this.data,e=t[0],i=t[4],s=t[8],a=t[12],n=t[1],o=t[5],l=t[9],h=t[13],c=t[2],m=t[6],d=t[10],g=t[14],f=t[3],v=t[7],S=t[11],C=t[15];return f*(+a*l*m-s*h*m-a*o*d+i*h*d+s*o*g-i*l*g)+v*(+e*l*g-e*h*d+a*n*d-s*n*g+s*h*c-a*l*c)+S*(+e*h*m-e*o*g-a*n*m+i*n*g+a*o*c-i*h*c)+C*(-s*o*c-e*l*m+e*o*d+s*n*m-i*n*d+i*l*c)}decompose(){const t=this.data;let e=new et(t[0],t[1],t[2]).magnitude(),i=new et(t[4],t[5],t[6]).magnitude(),s=new et(t[8],t[9],t[10]).magnitude();this.determinant()<0&&(e=-e);let a=new et(t[12],t[13],t[14]),n=new K;n.set(this.data);const o=1/e,l=1/i,h=1/s;n.data[0]*=o,n.data[1]*=o,n.data[2]*=o,n.data[4]*=l,n.data[5]*=l,n.data[6]*=l,n.data[8]*=h,n.data[9]*=h,n.data[10]*=h;let c=new et(e,i,s);return c.x=e,c.y=i,c.z=s,{position:a,rotation:n,scale:c}}mul2(t,e){const i=t.data,s=e.data,a=this.data,n=i[0],o=i[4],l=i[8],h=i[12],c=i[1],m=i[5],d=i[9],g=i[13],f=i[2],v=i[6],S=i[10],C=i[14],R=i[3],N=i[7],V=i[11],q=i[15],B=s[0],U=s[4],D=s[8],H=s[12],O=s[1],Z=s[5],Ct=s[9],ut=s[13],kt=s[2],bt=s[6],It=s[10],wt=s[14],Et=s[3],Ft=s[7],yt=s[11],vt=s[15];return a[0]=n*B+o*O+l*kt+h*Et,a[4]=n*U+o*Z+l*bt+h*Ft,a[8]=n*D+o*Ct+l*It+h*yt,a[12]=n*H+o*ut+l*wt+h*vt,a[1]=c*B+m*O+d*kt+g*Et,a[5]=c*U+m*Z+d*bt+g*Ft,a[9]=c*D+m*Ct+d*It+g*yt,a[13]=c*H+m*ut+d*wt+g*vt,a[2]=f*B+v*O+S*kt+C*Et,a[6]=f*U+v*Z+S*bt+C*Ft,a[10]=f*D+v*Ct+S*It+C*yt,a[14]=f*H+v*ut+S*wt+C*vt,a[3]=R*B+N*O+V*kt+q*Et,a[7]=R*U+N*Z+V*bt+q*Ft,a[11]=R*D+N*Ct+V*It+q*yt,a[15]=R*H+N*ut+V*wt+q*vt,this}mul(t){return this.mul2(this,t)}getPosition(){return new et(this.data[12],this.data[13],this.data[14])}getRotationEulerAngles(){let t=0,e=0,i=0;if(Math.abs(this.data[2]-1)>Number.EPSILON&&Math.abs(this.data[2]+1)>Number.EPSILON){e=-Math.asin(this.data[2]);const s=Math.cos(e);t=Math.atan2(this.data[6]/s,this.data[10]/s),i=Math.atan2(this.data[1]/s,this.data[0]/s)}else Math.abs(this.data[2]+1)<=Number.EPSILON?(e=Math.PI/2,t=Math.atan2(this.data[4],this.data[8])):(e=-Math.PI/2,t=Math.atan2(-this.data[4],-this.data[8]));return new et(t,e,i)}setFromEulerAngles(t,e,i){const s=Math.PI/180;t*=s,e*=s,i*=s;const a=Math.sin(-t),n=Math.cos(-t),o=Math.sin(-e),l=Math.cos(-e),h=Math.sin(-i),c=Math.cos(-i),m=this.data;return m[0]=l*c,m[1]=-l*h,m[2]=o,m[3]=0,m[4]=n*h+c*a*o,m[5]=n*c-a*o*h,m[6]=-l*a,m[7]=0,m[8]=a*h-n*c*o,m[9]=c*a+n*o*h,m[10]=n*l,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1,this}setFromEulerAnglesRad(t,e,i){const s=Math.sin(-t),a=Math.cos(-t),n=Math.sin(-e),o=Math.cos(-e),l=Math.sin(-i),h=Math.cos(-i),c=this.data;return c[0]=o*h,c[1]=-o*l,c[2]=n,c[3]=0,c[4]=a*l+h*s*n,c[5]=a*h-s*n*l,c[6]=-o*s,c[7]=0,c[8]=s*l-a*h*n,c[9]=h*s+a*n*l,c[10]=a*o,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}}var Gt=(r=>(r[r.NotTracking=0]="NotTracking",r[r.Limited=1]="Limited",r[r.Tracking=2]="Tracking",r))(Gt||{}),Y=(r=>(r[r.ZeroDof=0]="ZeroDof",r[r.ThreeDofRotOnly=1]="ThreeDofRotOnly",r[r.SixDof=2]="SixDof",r))(Y||{});const ye=4/3;function ve(r,t,e){return r/t>e-.003?r:t*e}function rs(r){const t=ve(.8,.6,ye)/ve(r.width,r.height,ye),e=r.fx*t,i=r.fy*t,s=r.cx*.8/r.width,a=r.cy*.6/r.height;return{width:.8,height:.6,fx:e,fy:i,cx:s,cy:a}}class ft{constructor(t,e,i,s,a,n,o){this._cameraOrientation=90,this._deviceRotation=0,this._width=t,this._height=e,this._fx=i,this._fy=s,this._cx=a,this._cy=n,this._deviceRotation=o}get width(){return this._width}get height(){return this._height}get fx(){return this._fx}get fy(){return this._fy}get cx(){return this._cx}get cy(){return this._cy}get cameraOrientation(){return this._cameraOrientation}set cameraOrientation(t){this._cameraOrientation=t}static createFromCalibData(t,e,i,s){if(!t)throw new Error("Try to create camera params from null calib data");const a=rs(t),n=ve(i,s,ye)/ve(a.width,a.height,ye),o=a.fx*n,l=a.fy*n,h=a.cx*i/a.width,c=a.cy*s/a.height;return new ft(i,s,o,l,h,c,e)}static createDefault(t,e,i,s){return new ft(t,e,i*.85,i*.85,t/2,e/2,s)}getProjectionMatrix(t,e){let i=new K;return i.data[0]=2*this._fx/this._width,i.data[1]=0,i.data[2]=0,i.data[3]=0,i.data[4]=0,i.data[5]=2*this._fy/this._height,i.data[6]=0,i.data[7]=0,i.data[8]=1-2*this._cx/this._width,i.data[9]=-1+2*this._cy/this._height,i.data[10]=-(t+e)/(t-e),i.data[11]=-1,i.data[12]=0,i.data[13]=0,i.data[14]=-2*t*e/(t-e),i.data[15]=0,i}getImageOrientation(){return(this._cameraOrientation+(360-this._deviceRotation))%360}getParamString(){return"["+this._fx+","+this._fy+","+this._cx+","+this._cy+"]"}getSize(){return[`${this._width}`,`${this._height}`]}getParam(){return[`${this._fx}`,`${this._fy}`,`${this._cx}`,`${this._cy}`]}}var rt=(r=>(r[r.UnknownError=0]="UnknownError",r[r.Found=1]="Found",r[r.NotFound=2]="NotFound",r[r.RequestTimeout=3]="RequestTimeout",r[r.RequestIntervalTooLow=4]="RequestIntervalTooLow",r[r.QpsLimitExceeded=5]="QpsLimitExceeded",r[r.WakingUp=6]="WakingUp",r))(rt||{});class fi{constructor(t,e,i,s){this.acce=t,this.geoLocation=e,this.proximity=i,this.blockIds=s}}class Nt{constructor(t,e,i){this._blockId="",this._name="",this._pose=null,this._blockId=t,this._name=e,this._pose=i}get blockId(){return this._blockId}get name(){return this._name}get pose(){return this._pose}static fromBlockLocalizationResult(t){return new Nt(t.mapId,t.name,new K().set(t.pose).transpose())}static fromLandmarkLocalizationResult(t){return new Nt(t.blockId,t.name,new K().set(t.pose).transpose())}}function di(r,t,e,i,s,a){if(r==Y.ZeroDof)return null;if(!i)return G.log("Null input frame camera transform matrix in mode: ",Y[r]),null;const n=i.clone().decompose(),o=n.position,l=new pt().setFromMat4(n.rotation);return`${t},${e},${o.x},${o.y},${o.z},${l.x},${l.y},${l.z},${l.w},${s.x},${s.y},${s.z},${a}`}function pi(r,t,e){if(r==Y.ZeroDof)return null;if(!e)return G.log("Null input frame camera transform matrix in mode: ",Y[r]),null;const i=e.clone().decompose(),s=i.position,a=new pt().setFromMat4(i.rotation);return`${t},${s.x},${s.y},${s.z},${a.x},${a.y},${a.z},${a.w}`}const Be="requestArgs",Ue="clsResponse",Oe="nativePoses",ce=class{constructor(){this._totalRecord={},this._recordingDataFlag=!1,this._platform=null,this._totalRecord[Be]=[],this._totalRecord[Ue]=[],this._totalRecord[Oe]=[]}get isRecordingData(){return this._recordingDataFlag}set isRecordingData(r){this._recordingDataFlag=r}get platform(){return this._platform}set platform(r){this._platform=r}static getInstance(){return ce.instance||(ce.instance=new ce),ce.instance}makeDateString(){let r=new Date,t=r.getFullYear()-2e3,e=r.getMonth()+1>=10?r.getMonth()+1:"0"+(r.getMonth()+1),i=r.getDate()>=10?r.getDate():"0"+r.getDate(),s=r.getHours()>=10?r.getHours():"0"+r.getHours(),a=r.getMinutes()>=10?r.getMinutes():"0"+r.getMinutes(),n=r.getSeconds()>=10?r.getSeconds():"0"+r.getSeconds();return`${t}-${e}-${i}_${s}-${a}-${n}`}clear(){this._totalRecord={},this._totalRecord[Be]=[],this._totalRecord[Ue]=[],this._totalRecord[Oe]=[]}recordRequestArgs(r){this._totalRecord[Be].push(r)}recordClsResponse(r){this._totalRecord[Ue].push(r)}recordNativePose(r){this._totalRecord[Oe].push(r)}preserveRequest(){let r=null,t=null;return this._platform?(this._platform==At.Wechat&&(r=`EasyAR_WX_${this.makeDateString()}.json`,t=`${wx.env.USER_DATA_PATH}/${r}`,wx.getFileSystemManager().writeFileSync(t,JSON.stringify(this._totalRecord),"utf8"),this.clear()),t):null}};let j=ce;j.instance=null;for(var Lt=[],gt=[],as=typeof Uint8Array<"u"?Uint8Array:Array,Ne="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Zt=0,ns=Ne.length;Zt<ns;++Zt)Lt[Zt]=Ne[Zt],gt[Ne.charCodeAt(Zt)]=Zt;gt["-".charCodeAt(0)]=62,gt["_".charCodeAt(0)]=63;function os(r){var t=r.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=r.indexOf("=");e===-1&&(e=t);var i=e===t?0:4-e%4;return[e,i]}function ls(r,t,e){return(t+e)*3/4-e}function cs(r){var t,e=os(r),i=e[0],s=e[1],a=new as(ls(r,i,s)),n=0,o=s>0?i-4:i,l;for(l=0;l<o;l+=4)t=gt[r.charCodeAt(l)]<<18|gt[r.charCodeAt(l+1)]<<12|gt[r.charCodeAt(l+2)]<<6|gt[r.charCodeAt(l+3)],a[n++]=t>>16&255,a[n++]=t>>8&255,a[n++]=t&255;return s===2&&(t=gt[r.charCodeAt(l)]<<2|gt[r.charCodeAt(l+1)]>>4,a[n++]=t&255),s===1&&(t=gt[r.charCodeAt(l)]<<10|gt[r.charCodeAt(l+1)]<<4|gt[r.charCodeAt(l+2)]>>2,a[n++]=t>>8&255,a[n++]=t&255),a}function hs(r){return Lt[r>>18&63]+Lt[r>>12&63]+Lt[r>>6&63]+Lt[r&63]}function us(r,t,e){for(var i,s=[],a=t;a<e;a+=3)i=(r[a]<<16&16711680)+(r[a+1]<<8&65280)+(r[a+2]&255),s.push(hs(i));return s.join("")}function ms(r){for(var t,e=r.length,i=e%3,s=[],a=16383,n=0,o=e-i;n<o;n+=a)s.push(us(r,n,n+a>o?o:n+a));return i===1?(t=r[e-1],s.push(Lt[t>>2]+Lt[t<<4&63]+"==")):i===2&&(t=(r[e-2]<<8)+r[e-1],s.push(Lt[t>>10]+Lt[t>>4&63]+Lt[t<<2&63]+"=")),s.join("")}const qe=function(){var r={},t=function(i,s,a){var n={exports:{},_tempexports:{}};r[i]={status:0,func:s,req:a,m:n}},e=function(i,s){if(!r[i])return require(s);if(!r[i].status){var a=r[i].m;a._exports=a._tempexports;var n=Object.getOwnPropertyDescriptor(a,"exports");n&&n.configurable&&Object.defineProperty(a,"exports",{set:function(o){typeof o=="object"&&o!==a._exports&&(a._exports.__proto__=o.__proto__,Object.keys(o).forEach(function(l){a._exports[l]=o[l]})),a._tempexports=o},get:function(){return a._tempexports}}),r[i].status=1,r[i].func(r[i].req,a,a.exports)}return r[i].m.exports};return t(1658745339199,function(i,s,a){(function(n,o){typeof a=="object"&&typeof s<"u"?s.exports=o():typeof define=="function"&&define.amd?define(o):(n=typeof globalThis<"u"?globalThis:n||self).jsSHA=o()})(this,function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function o(w,u,_,y){var A,p,k,b=u||[0],E=(_=_||0)>>>3,M=y===-1?3:0;for(A=0;A<w.length;A+=1)p=(k=A+E)>>>2,b.length<=p&&b.push(0),b[p]|=w[A]<<8*(M+y*(k%4));return{value:b,binLen:8*w.length+_}}function l(w,u,_){switch(u){case"UTF8":case"UTF16BE":case"UTF16LE":break;default:throw new Error("encoding must be UTF8, UTF16BE, or UTF16LE")}switch(w){case"HEX":return function(y,A,p){return function(k,b,E,M){var z,T,L,$;if(k.length%2!=0)throw new Error("String of HEX type must be in byte increments");var F=b||[0],J=(E=E||0)>>>3,W=M===-1?3:0;for(z=0;z<k.length;z+=2){if(T=parseInt(k.substr(z,2),16),isNaN(T))throw new Error("String of HEX type contains invalid characters");for(L=($=(z>>>1)+J)>>>2;F.length<=L;)F.push(0);F[L]|=T<<8*(W+M*($%4))}return{value:F,binLen:4*k.length+E}}(y,A,p,_)};case"TEXT":return function(y,A,p){return function(k,b,E,M,z){var T,L,$,F,J,W,X,st,Ot=0,dt=E||[0],Rt=(M=M||0)>>>3;if(b==="UTF8")for(X=z===-1?3:0,$=0;$<k.length;$+=1)for(L=[],128>(T=k.charCodeAt($))?L.push(T):2048>T?(L.push(192|T>>>6),L.push(128|63&T)):55296>T||57344<=T?L.push(224|T>>>12,128|T>>>6&63,128|63&T):($+=1,T=65536+((1023&T)<<10|1023&k.charCodeAt($)),L.push(240|T>>>18,128|T>>>12&63,128|T>>>6&63,128|63&T)),F=0;F<L.length;F+=1){for(J=(W=Ot+Rt)>>>2;dt.length<=J;)dt.push(0);dt[J]|=L[F]<<8*(X+z*(W%4)),Ot+=1}else for(X=z===-1?2:0,st=b==="UTF16LE"&&z!==1||b!=="UTF16LE"&&z===1,$=0;$<k.length;$+=1){for(T=k.charCodeAt($),st===!0&&(T=(F=255&T)<<8|T>>>8),J=(W=Ot+Rt)>>>2;dt.length<=J;)dt.push(0);dt[J]|=T<<8*(X+z*(W%4)),Ot+=2}return{value:dt,binLen:8*Ot+M}}(y,u,A,p,_)};case"B64":return function(y,A,p){return function(k,b,E,M){var z,T,L,$,F,J,W=0,X=b||[0],st=(E=E||0)>>>3,Ot=M===-1?3:0,dt=k.indexOf("=");if(k.search(/^[a-zA-Z0-9=+/]+$/)===-1)throw new Error("Invalid character in base-64 string");if(k=k.replace(/=/g,""),dt!==-1&&dt<k.length)throw new Error("Invalid '=' found in base-64 string");for(z=0;z<k.length;z+=4){for($=k.substr(z,4),L=0,T=0;T<$.length;T+=1)L|=n.indexOf($.charAt(T))<<18-6*T;for(T=0;T<$.length-1;T+=1){for(F=(J=W+st)>>>2;X.length<=F;)X.push(0);X[F]|=(L>>>16-8*T&255)<<8*(Ot+M*(J%4)),W+=1}}return{value:X,binLen:8*W+E}}(y,A,p,_)};case"BYTES":return function(y,A,p){return function(k,b,E,M){var z,T,L,$,F=b||[0],J=(E=E||0)>>>3,W=M===-1?3:0;for(T=0;T<k.length;T+=1)z=k.charCodeAt(T),L=($=T+J)>>>2,F.length<=L&&F.push(0),F[L]|=z<<8*(W+M*($%4));return{value:F,binLen:8*k.length+E}}(y,A,p,_)};case"ARRAYBUFFER":try{new ArrayBuffer(0)}catch{throw new Error("ARRAYBUFFER not supported by this environment")}return function(y,A,p){return function(k,b,E,M){return o(new Uint8Array(k),b,E,M)}(y,A,p,_)};case"UINT8ARRAY":try{new Uint8Array(0)}catch{throw new Error("UINT8ARRAY not supported by this environment")}return function(y,A,p){return o(y,A,p,_)};default:throw new Error("format must be HEX, TEXT, B64, BYTES, ARRAYBUFFER, or UINT8ARRAY")}}function h(w,u,_,y){switch(w){case"HEX":return function(A){return function(p,k,b,E){var M,z,T="",L=k/8,$=b===-1?3:0;for(M=0;M<L;M+=1)z=p[M>>>2]>>>8*($+b*(M%4)),T+="0123456789abcdef".charAt(z>>>4&15)+"0123456789abcdef".charAt(15&z);return E.outputUpper?T.toUpperCase():T}(A,u,_,y)};case"B64":return function(A){return function(p,k,b,E){var M,z,T,L,$,F="",J=k/8,W=b===-1?3:0;for(M=0;M<J;M+=3)for(L=M+1<J?p[M+1>>>2]:0,$=M+2<J?p[M+2>>>2]:0,T=(p[M>>>2]>>>8*(W+b*(M%4))&255)<<16|(L>>>8*(W+b*((M+1)%4))&255)<<8|$>>>8*(W+b*((M+2)%4))&255,z=0;z<4;z+=1)F+=8*M+6*z<=k?n.charAt(T>>>6*(3-z)&63):E.b64Pad;return F}(A,u,_,y)};case"BYTES":return function(A){return function(p,k,b){var E,M,z="",T=k/8,L=b===-1?3:0;for(E=0;E<T;E+=1)M=p[E>>>2]>>>8*(L+b*(E%4))&255,z+=String.fromCharCode(M);return z}(A,u,_)};case"ARRAYBUFFER":try{new ArrayBuffer(0)}catch{throw new Error("ARRAYBUFFER not supported by this environment")}return function(A){return function(p,k,b){var E,M=k/8,z=new ArrayBuffer(M),T=new Uint8Array(z),L=b===-1?3:0;for(E=0;E<M;E+=1)T[E]=p[E>>>2]>>>8*(L+b*(E%4))&255;return z}(A,u,_)};case"UINT8ARRAY":try{new Uint8Array(0)}catch{throw new Error("UINT8ARRAY not supported by this environment")}return function(A){return function(p,k,b){var E,M=k/8,z=b===-1?3:0,T=new Uint8Array(M);for(E=0;E<M;E+=1)T[E]=p[E>>>2]>>>8*(z+b*(E%4))&255;return T}(A,u,_)};default:throw new Error("format must be HEX, B64, BYTES, ARRAYBUFFER, or UINT8ARRAY")}}var c=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],m=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428],d=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],g="Chosen SHA variant is not supported";function f(w,u){var _,y,A=w.binLen>>>3,p=u.binLen>>>3,k=A<<3,b=4-A<<3;if(A%4!=0){for(_=0;_<p;_+=4)y=A+_>>>2,w.value[y]|=u.value[_>>>2]<<k,w.value.push(0),w.value[y+1]|=u.value[_>>>2]>>>b;return(w.value.length<<2)-4>=p+A&&w.value.pop(),{value:w.value,binLen:w.binLen+u.binLen}}return{value:w.value.concat(u.value),binLen:w.binLen+u.binLen}}function v(w){var u={outputUpper:!1,b64Pad:"=",outputLen:-1},_=w||{},y="Output length must be a multiple of 8";if(u.outputUpper=_.outputUpper||!1,_.b64Pad&&(u.b64Pad=_.b64Pad),_.outputLen){if(_.outputLen%8!=0)throw new Error(y);u.outputLen=_.outputLen}else if(_.shakeLen){if(_.shakeLen%8!=0)throw new Error(y);u.outputLen=_.shakeLen}if(typeof u.outputUpper!="boolean")throw new Error("Invalid outputUpper formatting option");if(typeof u.b64Pad!="string")throw new Error("Invalid b64Pad formatting option");return u}function S(w,u,_,y){var A=w+" must include a value and format";if(!u){if(!y)throw new Error(A);return y}if(u.value===void 0||!u.format)throw new Error(A);return l(u.format,u.encoding||"UTF8",_)(u.value)}var C=function(){function w(u,_,y){var A=y||{};if(this.t=_,this.i=A.encoding||"UTF8",this.numRounds=A.numRounds||1,isNaN(this.numRounds)||this.numRounds!==parseInt(this.numRounds,10)||1>this.numRounds)throw new Error("numRounds must a integer >= 1");this.o=u,this.u=[],this.s=0,this.h=!1,this.v=0,this.A=!1,this.l=[],this.H=[]}return w.prototype.update=function(u){var _,y=0,A=this.S>>>5,p=this.p(u,this.u,this.s),k=p.binLen,b=p.value,E=k>>>5;for(_=0;_<E;_+=A)y+this.S<=k&&(this.m=this.R(b.slice(_,_+A),this.m),y+=this.S);this.v+=y,this.u=b.slice(y>>>5),this.s=k%this.S,this.h=!0},w.prototype.getHash=function(u,_){var y,A,p=this.U,k=v(_);if(this.T){if(k.outputLen===-1)throw new Error("Output length must be specified in options");p=k.outputLen}var b=h(u,p,this.C,k);if(this.A&&this.F)return b(this.F(k));for(A=this.K(this.u.slice(),this.s,this.v,this.B(this.m),p),y=1;y<this.numRounds;y+=1)this.T&&p%32!=0&&(A[A.length-1]&=16777215>>>24-p%32),A=this.K(A,p,0,this.L(this.o),p);return b(A)},w.prototype.setHMACKey=function(u,_,y){if(!this.g)throw new Error("Variant does not support HMAC");if(this.h)throw new Error("Cannot set MAC key after calling update");var A=l(_,(y||{}).encoding||"UTF8",this.C);this.k(A(u))},w.prototype.k=function(u){var _,y=this.S>>>3,A=y/4-1;if(this.numRounds!==1)throw new Error("Cannot set numRounds with MAC");if(this.A)throw new Error("MAC key already set");for(y<u.binLen/8&&(u.value=this.K(u.value,u.binLen,0,this.L(this.o),this.U));u.value.length<=A;)u.value.push(0);for(_=0;_<=A;_+=1)this.l[_]=909522486^u.value[_],this.H[_]=1549556828^u.value[_];this.m=this.R(this.l,this.m),this.v=this.S,this.A=!0},w.prototype.getHMAC=function(u,_){var y=v(_);return h(u,this.U,this.C,y)(this.Y())},w.prototype.Y=function(){var u;if(!this.A)throw new Error("Cannot call getHMAC without first setting MAC key");var _=this.K(this.u.slice(),this.s,this.v,this.B(this.m),this.U);return u=this.R(this.H,this.L(this.o)),u=this.K(_,this.U,this.S,u,this.U)},w}(),R=function(w,u){return(R=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(_,y){_.__proto__=y}||function(_,y){for(var A in y)Object.prototype.hasOwnProperty.call(y,A)&&(_[A]=y[A])})(w,u)};function N(w,u){function _(){this.constructor=w}R(w,u),w.prototype=u===null?Object.create(u):(_.prototype=u.prototype,new _)}function V(w,u){return w<<u|w>>>32-u}function q(w,u){return w>>>u|w<<32-u}function B(w,u){return w>>>u}function U(w,u,_){return w^u^_}function D(w,u,_){return w&u^~w&_}function H(w,u,_){return w&u^w&_^u&_}function O(w){return q(w,2)^q(w,13)^q(w,22)}function Z(w,u){var _=(65535&w)+(65535&u);return(65535&(w>>>16)+(u>>>16)+(_>>>16))<<16|65535&_}function Ct(w,u,_,y){var A=(65535&w)+(65535&u)+(65535&_)+(65535&y);return(65535&(w>>>16)+(u>>>16)+(_>>>16)+(y>>>16)+(A>>>16))<<16|65535&A}function ut(w,u,_,y,A){var p=(65535&w)+(65535&u)+(65535&_)+(65535&y)+(65535&A);return(65535&(w>>>16)+(u>>>16)+(_>>>16)+(y>>>16)+(A>>>16)+(p>>>16))<<16|65535&p}function kt(w){return q(w,7)^q(w,18)^B(w,3)}function bt(w){return q(w,6)^q(w,11)^q(w,25)}function It(w){return[1732584193,4023233417,2562383102,271733878,3285377520]}function wt(w,u){var _,y,A,p,k,b,E,M=[];for(_=u[0],y=u[1],A=u[2],p=u[3],k=u[4],E=0;E<80;E+=1)M[E]=E<16?w[E]:V(M[E-3]^M[E-8]^M[E-14]^M[E-16],1),b=E<20?ut(V(_,5),D(y,A,p),k,1518500249,M[E]):E<40?ut(V(_,5),U(y,A,p),k,1859775393,M[E]):E<60?ut(V(_,5),H(y,A,p),k,2400959708,M[E]):ut(V(_,5),U(y,A,p),k,3395469782,M[E]),k=p,p=A,A=V(y,30),y=_,_=b;return u[0]=Z(_,u[0]),u[1]=Z(y,u[1]),u[2]=Z(A,u[2]),u[3]=Z(p,u[3]),u[4]=Z(k,u[4]),u}function Et(w,u,_,y){for(var A,p=15+(u+65>>>9<<4),k=u+_;w.length<=p;)w.push(0);for(w[u>>>5]|=128<<24-u%32,w[p]=4294967295&k,w[p-1]=k/4294967296|0,A=0;A<w.length;A+=16)y=wt(w.slice(A,A+16),y);return y}var Ft=function(w){function u(_,y,A){var p=this;if(_!=="SHA-1")throw new Error(g);var k=A||{};return(p=w.call(this,_,y,A)||this).g=!0,p.F=p.Y,p.C=-1,p.p=l(p.t,p.i,p.C),p.R=wt,p.B=function(b){return b.slice()},p.L=It,p.K=Et,p.m=[1732584193,4023233417,2562383102,271733878,3285377520],p.S=512,p.U=160,p.T=!1,k.hmacKey&&p.k(S("hmacKey",k.hmacKey,p.C)),p}return N(u,w),u}(C);function yt(w){return w=="SHA-224"?m.slice():d.slice()}function vt(w,u){var _,y,A,p,k,b,E,M,z,T,L,$,F=[];for(_=u[0],y=u[1],A=u[2],p=u[3],k=u[4],b=u[5],E=u[6],M=u[7],L=0;L<64;L+=1)F[L]=L<16?w[L]:Ct(q($=F[L-2],17)^q($,19)^B($,10),F[L-7],kt(F[L-15]),F[L-16]),z=ut(M,bt(k),D(k,b,E),c[L],F[L]),T=Z(O(_),H(_,y,A)),M=E,E=b,b=k,k=Z(p,z),p=A,A=y,y=_,_=Z(z,T);return u[0]=Z(_,u[0]),u[1]=Z(y,u[1]),u[2]=Z(A,u[2]),u[3]=Z(p,u[3]),u[4]=Z(k,u[4]),u[5]=Z(b,u[5]),u[6]=Z(E,u[6]),u[7]=Z(M,u[7]),u}var _r=function(w){function u(_,y,A){var p=this;if(_!=="SHA-224"&&_!=="SHA-256")throw new Error(g);var k=A||{};return(p=w.call(this,_,y,A)||this).F=p.Y,p.g=!0,p.C=-1,p.p=l(p.t,p.i,p.C),p.R=vt,p.B=function(b){return b.slice()},p.L=yt,p.K=function(b,E,M,z){return function(T,L,$,F,J){for(var W,X=15+(L+65>>>9<<4),st=L+$;T.length<=X;)T.push(0);for(T[L>>>5]|=128<<24-L%32,T[X]=4294967295&st,T[X-1]=st/4294967296|0,W=0;W<T.length;W+=16)F=vt(T.slice(W,W+16),F);return J==="SHA-224"?[F[0],F[1],F[2],F[3],F[4],F[5],F[6]]:F}(b,E,M,z,_)},p.m=yt(_),p.S=512,p.U=_==="SHA-224"?224:256,p.T=!1,k.hmacKey&&p.k(S("hmacKey",k.hmacKey,p.C)),p}return N(u,w),u}(C),x=function(w,u){this.N=w,this.I=u};function Ki(w,u){var _;return u>32?(_=64-u,new x(w.I<<u|w.N>>>_,w.N<<u|w.I>>>_)):u!==0?(_=32-u,new x(w.N<<u|w.I>>>_,w.I<<u|w.N>>>_)):w}function Pt(w,u){var _;return u<32?(_=32-u,new x(w.N>>>u|w.I<<_,w.I>>>u|w.N<<_)):(_=64-u,new x(w.I>>>u|w.N<<_,w.N>>>u|w.I<<_))}function Yi(w,u){return new x(w.N>>>u,w.I>>>u|w.N<<32-u)}function wr(w,u,_){return new x(w.N&u.N^~w.N&_.N,w.I&u.I^~w.I&_.I)}function yr(w,u,_){return new x(w.N&u.N^w.N&_.N^u.N&_.N,w.I&u.I^w.I&_.I^u.I&_.I)}function vr(w){var u=Pt(w,28),_=Pt(w,34),y=Pt(w,39);return new x(u.N^_.N^y.N,u.I^_.I^y.I)}function Tt(w,u){var _,y;_=(65535&w.I)+(65535&u.I);var A=(65535&(y=(w.I>>>16)+(u.I>>>16)+(_>>>16)))<<16|65535&_;return _=(65535&w.N)+(65535&u.N)+(y>>>16),y=(w.N>>>16)+(u.N>>>16)+(_>>>16),new x((65535&y)<<16|65535&_,A)}function Ar(w,u,_,y){var A,p;A=(65535&w.I)+(65535&u.I)+(65535&_.I)+(65535&y.I);var k=(65535&(p=(w.I>>>16)+(u.I>>>16)+(_.I>>>16)+(y.I>>>16)+(A>>>16)))<<16|65535&A;return A=(65535&w.N)+(65535&u.N)+(65535&_.N)+(65535&y.N)+(p>>>16),p=(w.N>>>16)+(u.N>>>16)+(_.N>>>16)+(y.N>>>16)+(A>>>16),new x((65535&p)<<16|65535&A,k)}function Sr(w,u,_,y,A){var p,k;p=(65535&w.I)+(65535&u.I)+(65535&_.I)+(65535&y.I)+(65535&A.I);var b=(65535&(k=(w.I>>>16)+(u.I>>>16)+(_.I>>>16)+(y.I>>>16)+(A.I>>>16)+(p>>>16)))<<16|65535&p;return p=(65535&w.N)+(65535&u.N)+(65535&_.N)+(65535&y.N)+(65535&A.N)+(k>>>16),k=(w.N>>>16)+(u.N>>>16)+(_.N>>>16)+(y.N>>>16)+(A.N>>>16)+(p>>>16),new x((65535&k)<<16|65535&p,b)}function _e(w,u){return new x(w.N^u.N,w.I^u.I)}function xr(w){var u=Pt(w,1),_=Pt(w,8),y=Yi(w,7);return new x(u.N^_.N^y.N,u.I^_.I^y.I)}function Cr(w){var u=Pt(w,14),_=Pt(w,18),y=Pt(w,41);return new x(u.N^_.N^y.N,u.I^_.I^y.I)}var kr=[new x(c[0],3609767458),new x(c[1],602891725),new x(c[2],3964484399),new x(c[3],2173295548),new x(c[4],4081628472),new x(c[5],3053834265),new x(c[6],2937671579),new x(c[7],3664609560),new x(c[8],2734883394),new x(c[9],1164996542),new x(c[10],1323610764),new x(c[11],3590304994),new x(c[12],4068182383),new x(c[13],991336113),new x(c[14],633803317),new x(c[15],3479774868),new x(c[16],2666613458),new x(c[17],944711139),new x(c[18],2341262773),new x(c[19],2007800933),new x(c[20],1495990901),new x(c[21],1856431235),new x(c[22],3175218132),new x(c[23],2198950837),new x(c[24],3999719339),new x(c[25],766784016),new x(c[26],2566594879),new x(c[27],3203337956),new x(c[28],1034457026),new x(c[29],2466948901),new x(c[30],3758326383),new x(c[31],168717936),new x(c[32],1188179964),new x(c[33],1546045734),new x(c[34],1522805485),new x(c[35],2643833823),new x(c[36],2343527390),new x(c[37],1014477480),new x(c[38],1206759142),new x(c[39],344077627),new x(c[40],1290863460),new x(c[41],3158454273),new x(c[42],3505952657),new x(c[43],106217008),new x(c[44],3606008344),new x(c[45],1432725776),new x(c[46],1467031594),new x(c[47],851169720),new x(c[48],3100823752),new x(c[49],1363258195),new x(c[50],3750685593),new x(c[51],3785050280),new x(c[52],3318307427),new x(c[53],3812723403),new x(c[54],2003034995),new x(c[55],3602036899),new x(c[56],1575990012),new x(c[57],1125592928),new x(c[58],2716904306),new x(c[59],442776044),new x(c[60],593698344),new x(c[61],3733110249),new x(c[62],2999351573),new x(c[63],3815920427),new x(3391569614,3928383900),new x(3515267271,566280711),new x(3940187606,3454069534),new x(4118630271,4000239992),new x(116418474,1914138554),new x(174292421,2731055270),new x(289380356,3203993006),new x(460393269,320620315),new x(685471733,587496836),new x(852142971,1086792851),new x(1017036298,365543100),new x(1126000580,2618297676),new x(1288033470,3409855158),new x(1501505948,4234509866),new x(1607167915,987167468),new x(1816402316,1246189591)];function Ji(w){return w==="SHA-384"?[new x(3418070365,m[0]),new x(1654270250,m[1]),new x(2438529370,m[2]),new x(355462360,m[3]),new x(1731405415,m[4]),new x(41048885895,m[5]),new x(3675008525,m[6]),new x(1203062813,m[7])]:[new x(d[0],4089235720),new x(d[1],2227873595),new x(d[2],4271175723),new x(d[3],1595750129),new x(d[4],2917565137),new x(d[5],725511199),new x(d[6],4215389547),new x(d[7],327033209)]}function Xi(w,u){var _,y,A,p,k,b,E,M,z,T,L,$,F,J,W,X,st=[];for(_=u[0],y=u[1],A=u[2],p=u[3],k=u[4],b=u[5],E=u[6],M=u[7],L=0;L<80;L+=1)L<16?($=2*L,st[L]=new x(w[$],w[$+1])):st[L]=Ar((F=st[L-2],J=void 0,W=void 0,X=void 0,J=Pt(F,19),W=Pt(F,61),X=Yi(F,6),new x(J.N^W.N^X.N,J.I^W.I^X.I)),st[L-7],xr(st[L-15]),st[L-16]),z=Sr(M,Cr(k),wr(k,b,E),kr[L],st[L]),T=Tt(vr(_),yr(_,y,A)),M=E,E=b,b=k,k=Tt(p,z),p=A,A=y,y=_,_=Tt(z,T);return u[0]=Tt(_,u[0]),u[1]=Tt(y,u[1]),u[2]=Tt(A,u[2]),u[3]=Tt(p,u[3]),u[4]=Tt(k,u[4]),u[5]=Tt(b,u[5]),u[6]=Tt(E,u[6]),u[7]=Tt(M,u[7]),u}var br=function(w){function u(_,y,A){var p=this;if(_!=="SHA-384"&&_!=="SHA-512")throw new Error(g);var k=A||{};return(p=w.call(this,_,y,A)||this).F=p.Y,p.g=!0,p.C=-1,p.p=l(p.t,p.i,p.C),p.R=Xi,p.B=function(b){return b.slice()},p.L=Ji,p.K=function(b,E,M,z){return function(T,L,$,F,J){for(var W,X=31+(L+129>>>10<<5),st=L+$;T.length<=X;)T.push(0);for(T[L>>>5]|=128<<24-L%32,T[X]=4294967295&st,T[X-1]=st/4294967296|0,W=0;W<T.length;W+=32)F=Xi(T.slice(W,W+32),F);return J==="SHA-384"?[(F=F)[0].N,F[0].I,F[1].N,F[1].I,F[2].N,F[2].I,F[3].N,F[3].I,F[4].N,F[4].I,F[5].N,F[5].I]:[F[0].N,F[0].I,F[1].N,F[1].I,F[2].N,F[2].I,F[3].N,F[3].I,F[4].N,F[4].I,F[5].N,F[5].I,F[6].N,F[6].I,F[7].N,F[7].I]}(b,E,M,z,_)},p.m=Ji(_),p.S=1024,p.U=_==="SHA-384"?384:512,p.T=!1,k.hmacKey&&p.k(S("hmacKey",k.hmacKey,p.C)),p}return N(u,w),u}(C),Ir=[new x(0,1),new x(0,32898),new x(2147483648,32906),new x(2147483648,2147516416),new x(0,32907),new x(0,2147483649),new x(2147483648,2147516545),new x(2147483648,32777),new x(0,138),new x(0,136),new x(0,2147516425),new x(0,2147483658),new x(0,2147516555),new x(2147483648,139),new x(2147483648,32905),new x(2147483648,32771),new x(2147483648,32770),new x(2147483648,128),new x(0,32778),new x(2147483648,2147483658),new x(2147483648,2147516545),new x(2147483648,32896),new x(0,2147483649),new x(2147483648,2147516424)],Er=[[0,36,3,41,18],[1,44,10,45,2],[62,6,43,15,61],[28,55,25,21,56],[27,20,39,8,14]];function oi(w){var u,_=[];for(u=0;u<5;u+=1)_[u]=[new x(0,0),new x(0,0),new x(0,0),new x(0,0),new x(0,0)];return _}function Fr(w){var u,_=[];for(u=0;u<5;u+=1)_[u]=w[u].slice();return _}function Re(w,u){var _,y,A,p,k,b,E,M,z,T=[],L=[];if(w!==null)for(y=0;y<w.length;y+=2)u[(y>>>1)%5][(y>>>1)/5|0]=_e(u[(y>>>1)%5][(y>>>1)/5|0],new x(w[y+1],w[y]));for(_=0;_<24;_+=1){for(p=oi(),y=0;y<5;y+=1)T[y]=(k=u[y][0],b=u[y][1],E=u[y][2],M=u[y][3],z=u[y][4],new x(k.N^b.N^E.N^M.N^z.N,k.I^b.I^E.I^M.I^z.I));for(y=0;y<5;y+=1)L[y]=_e(T[(y+4)%5],Ki(T[(y+1)%5],1));for(y=0;y<5;y+=1)for(A=0;A<5;A+=1)u[y][A]=_e(u[y][A],L[y]);for(y=0;y<5;y+=1)for(A=0;A<5;A+=1)p[A][(2*y+3*A)%5]=Ki(u[y][A],Er[y][A]);for(y=0;y<5;y+=1)for(A=0;A<5;A+=1)u[y][A]=_e(p[y][A],new x(~p[(y+1)%5][A].N&p[(y+2)%5][A].N,~p[(y+1)%5][A].I&p[(y+2)%5][A].I));u[0][0]=_e(u[0][0],Ir[_])}return u}function Qi(w){var u,_,y=0,A=[0,0],p=[4294967295&w,w/4294967296&2097151];for(u=6;u>=0;u--)(_=p[u>>2]>>>8*u&255)===0&&y===0||(A[y+1>>2]|=_<<8*(y+1),y+=1);return y=y!==0?y:1,A[0]|=y,{value:y+1>4?A:[A[0]],binLen:8+8*y}}function li(w){return f(Qi(w.binLen),w)}function Zi(w,u){var _,y=Qi(u),A=u>>>2,p=(A-(y=f(y,w)).value.length%A)%A;for(_=0;_<p;_++)y.value.push(0);return y.value}var Tr=function(w){function u(_,y,A){var p=this,k=6,b=0,E=A||{};if((p=w.call(this,_,y,A)||this).numRounds!==1){if(E.kmacKey||E.hmacKey)throw new Error("Cannot set numRounds with MAC");if(p.o==="CSHAKE128"||p.o==="CSHAKE256")throw new Error("Cannot set numRounds for CSHAKE variants")}switch(p.C=1,p.p=l(p.t,p.i,p.C),p.R=Re,p.B=Fr,p.L=oi,p.m=oi(),p.T=!1,_){case"SHA3-224":p.S=b=1152,p.U=224,p.g=!0,p.F=p.Y;break;case"SHA3-256":p.S=b=1088,p.U=256,p.g=!0,p.F=p.Y;break;case"SHA3-384":p.S=b=832,p.U=384,p.g=!0,p.F=p.Y;break;case"SHA3-512":p.S=b=576,p.U=512,p.g=!0,p.F=p.Y;break;case"SHAKE128":k=31,p.S=b=1344,p.U=-1,p.T=!0,p.g=!1,p.F=null;break;case"SHAKE256":k=31,p.S=b=1088,p.U=-1,p.T=!0,p.g=!1,p.F=null;break;case"KMAC128":k=4,p.S=b=1344,p.M(A),p.U=-1,p.T=!0,p.g=!1,p.F=p.X;break;case"KMAC256":k=4,p.S=b=1088,p.M(A),p.U=-1,p.T=!0,p.g=!1,p.F=p.X;break;case"CSHAKE128":p.S=b=1344,k=p.O(A),p.U=-1,p.T=!0,p.g=!1,p.F=null;break;case"CSHAKE256":p.S=b=1088,k=p.O(A),p.U=-1,p.T=!0,p.g=!1,p.F=null;break;default:throw new Error(g)}return p.K=function(M,z,T,L,$){return function(F,J,W,X,st,Ot,dt){var Rt,ci,Me=0,we=[],De=st>>>5,Rr=J>>>5;for(Rt=0;Rt<Rr&&J>=st;Rt+=De)X=Re(F.slice(Rt,Rt+De),X),J-=st;for(F=F.slice(Rt),J%=st;F.length<De;)F.push(0);for(F[(Rt=J>>>3)>>2]^=Ot<<Rt%4*8,F[De-1]^=2147483648,X=Re(F,X);32*we.length<dt&&(ci=X[Me%5][Me/5|0],we.push(ci.I),!(32*we.length>=dt));)we.push(ci.N),64*(Me+=1)%st==0&&(Re(null,X),Me=0);return we}(M,z,0,L,b,k,$)},E.hmacKey&&p.k(S("hmacKey",E.hmacKey,p.C)),p}return N(u,w),u.prototype.O=function(_,y){var A=function(E){var M=E||{};return{funcName:S("funcName",M.funcName,1,{value:[],binLen:0}),customization:S("Customization",M.customization,1,{value:[],binLen:0})}}(_||{});y&&(A.funcName=y);var p=f(li(A.funcName),li(A.customization));if(A.customization.binLen!==0||A.funcName.binLen!==0){for(var k=Zi(p,this.S>>>3),b=0;b<k.length;b+=this.S>>>5)this.m=this.R(k.slice(b,b+(this.S>>>5)),this.m),this.v+=this.S;return 4}return 31},u.prototype.M=function(_){var y=function(k){var b=k||{};return{kmacKey:S("kmacKey",b.kmacKey,1),funcName:{value:[1128353099],binLen:32},customization:S("Customization",b.customization,1,{value:[],binLen:0})}}(_||{});this.O(_,y.funcName);for(var A=Zi(li(y.kmacKey),this.S>>>3),p=0;p<A.length;p+=this.S>>>5)this.m=this.R(A.slice(p,p+(this.S>>>5)),this.m),this.v+=this.S;this.A=!0},u.prototype.X=function(_){var y=f({value:this.u.slice(),binLen:this.s},function(A){var p,k,b=0,E=[0,0],M=[4294967295&A,A/4294967296&2097151];for(p=6;p>=0;p--)(k=M[p>>2]>>>8*p&255)==0&&b===0||(E[b>>2]|=k<<8*b,b+=1);return E[(b=b!==0?b:1)>>2]|=b<<8*b,{value:b+1>4?E:[E[0]],binLen:8+8*b}}(_.outputLen));return this.K(y.value,y.binLen,this.v,this.B(this.m),_.outputLen)},u}(C);return function(){function w(u,_,y){if(u=="SHA-1")this.j=new Ft(u,_,y);else if(u=="SHA-224"||u=="SHA-256")this.j=new _r(u,_,y);else if(u=="SHA-384"||u=="SHA-512")this.j=new br(u,_,y);else{if(u!="SHA3-224"&&u!="SHA3-256"&&u!="SHA3-384"&&u!="SHA3-512"&&u!="SHAKE128"&&u!="SHAKE256"&&u!="CSHAKE128"&&u!="CSHAKE256"&&u!="KMAC128"&&u!="KMAC256")throw new Error(g);this.j=new Tr(u,_,y)}}return w.prototype.update=function(u){this.j.update(u)},w.prototype.getHash=function(u,_){return this.j.getHash(u,_)},w.prototype.setHMACKey=function(u,_,y){this.j.setHMACKey(u,_,y)},w.prototype.getHMAC=function(u,_){return this.j.getHMAC(u,_)},w}()})},function(i){var s={};return e(s[i],i)}),e(1658745339199)}();async function Ae(r,t,e,i,s,a){const n=Object.keys(e||{}),o=n.length?n.map(h=>`${h}=${encodeURIComponent(e[h])}`).join("&"):void 0,l=r+(o?`?${o}`:"");return new Promise((h,c)=>{wx.request({url:l,method:t,header:i,data:s,timeout:a,success:m=>{h(m.data)},fail:m=>{c(m)}})})}function he(r){let t=new qe("SHA-256","TEXT");return t.update(r),t.getHash("HEX")}function fs(r,t,e){let i;return function(...s){if(!i)return i=setTimeout(()=>i=null,t),r.apply(e,s)}}function jt(r){const t=new Uint8Array(r);return ms(t)}function Wt(r){return cs(r)}function ds(r){const t=/^(https?:\/\/)?([^\/]+)/,e=r.match(t);return e&&e[2]?e[2].split(".")[0]:null}const gi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ps=new Uint8Array(256);for(let r=0;r<gi.length;r++)ps[gi.charCodeAt(r)]=r;function gs(r){const t=new Array(r.length);for(let e=0;e<r.length;++e)t[e]=r[e];return t}function He(r){const t="abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";let e="";for(let i=0;i<r;++i)e+=t.charAt(Math.floor(Math.random()*t.length));return e}const _s="https://easyar-calib.easyar.com/intrinsics.json";async function ws(r){let t=null;r==At.Wechat&&(t=Ae);try{return await t(_s,"GET")}catch(e){throw e}}const Ve=Object.freeze(Object.defineProperty({__proto__:null,sha256:he,throttle:fs,data2base64:jt,base64ToArrayBuffer:Wt,extractUrlDomain:ds,copyArrayBufferToNumbers:gs,generateRandomString:He,fetchCalibIntrinsics:ws},Symbol.toStringTag,{value:"Module"}));class _i{constructor(){this.blockInstances=[]}}class ys{get blockServiceHandler(){return this._blockServiceHandler}constructor(t){this._blockServiceHandler=t}resolve(t,e,i,s,a){return new Promise((n,o)=>{t.length==0&&o(new Error("Request sequence is empty"));const l=this._blockServiceHandler.requestFrameCount;t.length!=l&&o(new Error(`Frame request sequences size should be ${l}, but it is currently ${t.length}`)),i.length!=l&&o(new Error(`DeviceAuxiliaryInfo request sequences size should be ${l}, but it is currently ${i.length}`)),s.length!=l&&o(new Error(`RecentFrameBuffer request sequences size should be ${l}, but it is currently ${s.length}`));for(const m of t)(!m.imageString||m.imageString.length==0)&&(!m.imageBuffer||m.imageBuffer.byteLength==0)&&o(new Error("Empty Image when resolving in localizer"));const h=new Date().getTime();let c={};if(e)try{c=JSON.parse(e)}catch{o(new Error("Fail to parse user message in localizer"))}c.startTime=h,a!=null&&(c.arSessionId=a),this._clsRequest(t,i,s,c).then(m=>{if(m instanceof Error&&o(m),j.getInstance().isRecordingData){let f=m;f.frameTimestamp=t[t.length-1].timestamp,f.appid=this._blockServiceHandler.config.appId,j.getInstance().recordClsResponse(f)}const d=new _i;d.inputFrame=t[t.length-1],m.arSessionId&&(d.arSessionId=m.arSessionId),d.extraInfo=m.extraInfo,d.exceptionInfo=m.msg;const g=new Date().getTime();d.serverResponseDuration=g-h,d.serverCalculationDuration=m.duration,m.statusCode!=0?m.statusCode==17?d.localizerStatus=rt.NotFound:m.statusCode==21?d.localizerStatus=rt.QpsLimitExceeded:m.statusCode==100017?d.localizerStatus=rt.WakingUp:d.localizerStatus=rt.UnknownError:(d.localizerStatus=rt.Found,m.result&&d.blockInstances.push(Nt.fromBlockLocalizationResult(m.result[0]))),n(d)})})}_clsRequest(t,e,i,s){const a=this._blockServiceHandler.composeRequestParams(t,e,i,s);if(j.getInstance().isRecordingData)if(t.length==1)t[0].imageString&&t[0].imageString.length>0?j.getInstance().recordRequestArgs({...JSON.parse(a.args),base64:t[0].imageString}):t[0].imageBuffer&&t[0].imageBuffer.byteLength>0?j.getInstance().recordRequestArgs({...JSON.parse(a.args),base64:jt(t[0].imageBuffer)}):j.getInstance().recordRequestArgs({...JSON.parse(a.args)});else{let n=null,o=null;t[0].imageString&&t[0].imageString.length>0?n=t[0].imageString:t[0].imageBuffer&&t[0].imageBuffer.byteLength>0&&(n=jt(t[0].imageBuffer)),t[1].imageString&&t[1].imageString.length>0?o=t[1].imageString:t[1].imageBuffer&&t[1].imageBuffer.byteLength>0&&(o=jt(t[1].imageBuffer)),n&&n.length>0?j.getInstance().recordRequestArgs({...JSON.parse(a.pres),base64:n}):j.getInstance().recordRequestArgs({...JSON.parse(a.pres)}),o&&o.length>0?j.getInstance().recordRequestArgs({...JSON.parse(a.args),base64:o}):j.getInstance().recordRequestArgs({...JSON.parse(a.args)})}if(t.length<=1){if(t[0].imageBuffer&&t[0].imageBuffer.byteLength>0)return this._blockServiceHandler.requestServiceSingleImage(a,t[0].imageBuffer,!1);if(t[0].imageString&&t[0].imageString.length>0)return this._blockServiceHandler.requestServiceSingleImage(a,t[0].imageString,!0);G.log("No image buffer nor string at block cls request")}return this._blockServiceHandler.requestService(a,t)}}class $e{constructor(){this._isTrial=!1,this._initFlag=!1}get isTrial(){return this._isTrial}get initFlag(){return this._initFlag}}var ue=(r=>(r[r.V6_And_Later=6]="V6_And_Later",r[r.V5=5]="V5",r[r.V4_And_Before=4]="V4_And_Before",r))(ue||{});function wi(r,t){let e=JSON.stringify(r);return qt("https://posefusion.easyar.com/pose/v1","POST",null,null,e).then(i=>t(i))}const vs=300,yi="https://uac.easyar.com";let qt=null;class Se extends $e{constructor(t,e){super(),this._pathPostfix="",this._fullPath="",this._clsHost=null,this._token="",this._tokenExpireTime=0,this._requestInterval=1e3,this._timeout=6e3,this._usingGstratFlag=!1,this._boundaryStr="THISISABOUNDARYASDEFAULT",this._versionTag=null,this._switchBlockService=new lt,this._clsConfig=t,this._boundaryStr=He(32),e==At.Wechat&&(qt=Ae)}get fullPath(){return this._fullPath}get clsHost(){return this._clsHost}get token(){return this._token}get config(){return this._clsConfig}get requestInterval(){return this._requestInterval}get requestTimeout(){return this._timeout}get switchBlockServiceEvent(){return this._switchBlockService.event}get versionTag(){return this._versionTag}get isUsingGstrat(){return this._usingGstratFlag}get requestFrameCount(){return this._usingGstratFlag?2:1}async initialize(){try{if(this._validateClsConfig(),this._clsHost=this._queryUrlHost(),await this.refreshToken(),await this._getClsInfo())this._checkUrl(),this._initFlag=!0;else throw new Error(`Fail to get CLS info from ${this._clsHost}/cls/client/mega/info`)}catch(t){throw t}}reset(){this._isTrial=!1,this._initFlag=!1,this._pathPostfix="",this._fullPath="",this._clsConfig=null,this._clsHost=null,this._token="",this._tokenExpireTime=0}setRequestConfig(t){if(t.requestInterval<300)throw new Error("Cannot set requestInterval less than 300ms");if(t.timeout<5e3)throw new Error("Cannot set timeout less than 5000ms");this._requestInterval=t.requestInterval,this._timeout=t.timeout}async refreshToken(){const t=vs,e=new Date().getTime()+t*1e3,i=`[{"service":"ecs:cls","effect":"Allow","resource":["${this._clsConfig.appId}"],"permission":["READ","WRITE"]}]`;let s={};s.expires=t.toString(),s.timestamp=e.toString(),s.apiKey=this._clsConfig.apiKey,s.acl=i;let a=Object.keys(s).sort().map(n=>`${n}${s[n]}`).concat(this._clsConfig.apiSecret).join("");s.signature=he(a);try{const n=await qt(`${yi}/token/v2`,"POST",null,null,s);if(n.statusCode==0)G.log("Block token refreshed"),this._token=n.result.token,this._tokenExpireTime=e;else throw new Error(`${n.msg} from ${yi}/token/v2`)}catch(n){throw n}}composeRequestParams(t,e,i,s){return this._versionTag<=4?this._composeRequestParamsLegacy(t[0],e[0],s):this._composeRequestParams(t,e,i,s)}async requestServiceSingleImage(t,e,i=!0){if(!e)return new Error("No image at cls request with single image");this._isTokenExpired()&&await this.refreshToken();let s=null;if(i===!0){if(e.length==0)return new Error("Empty image string at cls request with single image string");G.log("Block cls with single image from string"),s=Wt(e.substr(23))}else{if(e.byteLength==0)return new Error("Empty image buffer at cls request with single image buffer");G.log("Block cls with single image from buffer"),s=e}let a=Object.keys(t).map(g=>`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="${g}"\r
\r
`+t[g]).join("")+`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="image"; filename="image.jpg"\r
Content-Type: application/octet-stream\r
Content-Transfer-Encoding: binary\r
\r
`,n=`\r
--${this._boundaryStr}--`,o=new le.TextEncoder,l=o.encode(a),h=new Uint8Array(s),c=o.encode(n),m=new Uint8Array(l.length+h.length+c.length);m.set(l,0),m.set(h,l.length),m.set(c,l.length+h.length);const d={"content-type":"multipart/form-data; boundary="+this._boundaryStr,Authorization:this._token};return qt(this._fullPath,"POST",null,d,m.buffer,this._timeout)}async requestService(t,e){if(!e)return new Error("No frame datas at cls request");if(e.length<2)return new Error("No enough frame datas at cls request");if((!e[0].imageString||e[0].imageString.length==0)&&(!e[0].imageBuffer||e[0].imageBuffer.byteLength==0))return new Error("Pre frame lacks image at cls request");if((!e[1].imageString||e[1].imageString.length==0)&&(!e[1].imageBuffer||e[1].imageBuffer.byteLength==0))return new Error("Pre frame lacks image at cls request");this._isTokenExpired()&&await this.refreshToken();let i=null,s=null;e[0].imageString&&e[0].imageString.length>0?(i=Wt(e[0].imageString.substr(23)),G.log("Block cls with two images. The first image is from string")):(i=e[0].imageBuffer,G.log("Block cls with two images. The first image is from buffer")),e[1].imageString&&e[1].imageString.length>0?(s=Wt(e[1].imageString.substr(23)),G.log("Block cls with two images. The second image is from string")):(s=e[1].imageBuffer,G.log("Block cls with two images. The second image is from buffer"));let a=Object.keys(t).map(C=>`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="${C}"\r
\r
`+t[C]).join("")+`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="image"; filename="image.jpg"\r
Content-Type: application/octet-stream\r
Content-Transfer-Encoding: binary\r
\r
`,n=`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="preImage"; filename="preImage.jpg"\r
Content-Type: application/octet-stream\r
Content-Transfer-Encoding: binary\r
\r
`,o=`\r
--${this._boundaryStr}--`,l=new le.TextEncoder,h=l.encode(a),c=new Uint8Array(s),m=l.encode(n),d=new Uint8Array(i),g=l.encode(o),f=new Uint8Array(h.length+c.length+m.length+d.length+g.length),v=0;f.set(h,v),v+=h.length,f.set(c,v),v+=c.length,f.set(m,v),v+=m.length,f.set(d,v),v+=d.length,f.set(g,v),v+=g.length;const S={"content-type":"multipart/form-data; boundary="+this._boundaryStr,Authorization:this._token};return qt(this._fullPath,"POST",null,S,f.buffer,this._timeout)}async getEmaRawData(t){try{const e=await this._getEmaUrl(t);if(e.statusCode!=0)throw new Error("EMA request failed: "+e.msg);if(!e.result||!e.result.emaUrl||e.result.emaUrl.length==0)throw new Error("EMA request succeeded, but result url is empty");const i={"content-type":" "};return qt(e.result.emaUrl,"GET",null,i,null)}catch(e){throw e}}async switchBlockService(t){try{if(t==null)throw new Error("Empty block cls config at switching service.");G.log("Block service switched from: ",this._clsConfig.appId," ,to: ",t.appId),this.reset(),this._clsConfig=t,await this.initialize(),this._switchBlockService.fire()}catch(e){throw e}}_isTokenExpired(){return new Date().getTime()>this._tokenExpireTime}_getClsInfo(){let t={};return t.appId=this._clsConfig.appId,qt(`${this._clsHost}/cls/client/mega/info`,"GET",t,{Authorization:this._token},null).then(e=>{if(e.statusCode>0)return!1;if(e.config){const i=JSON.parse(e.config);i&&i.gstrat&&i.gstrat==1&&(G.log("CLS library gstrat is : "+i.gstrat),this._usingGstratFlag=!0)}return this._isTrial=e.trial,e.path&&(this._pathPostfix=e.path),!0})}_composeRequestParams(t,e,i,s){let a=null;if(t.length==1){let n=this._prepareRequestData(t[0],e[0],i[0]);a={appId:this._clsConfig.appId,apiKey:this._clsConfig.apiKey,clientSupplier:"wxmpp",clientVersion:oe,timestamp:Date.now(),args:JSON.stringify(n),...s},this._versionTag<6&&(a.cameraParam=t[0].cameraParams.getParamString())}else if(t.length>=2){let n=this._prepareRequestData(t[0],e[0],i[0]),o=this._prepareRequestData(t[1],e[1],i[1]);a={appId:this._clsConfig.appId,apiKey:this._clsConfig.apiKey,clientSupplier:"wxmpp",clientVersion:oe,timestamp:Date.now(),args:JSON.stringify(o),pres:JSON.stringify(n),...s}}return a}_prepareRequestData(t,e,i){let s={schema:"1.0",cameraSize:t.cameraParams.getSize(),cameraParam:t.cameraParams.getParam(),cameraOrientation:`${t.cameraParams.cameraOrientation}`};if(e.acce&&(s.acce=[`${e.acce.x}`,`${e.acce.y}`,`${e.acce.z}`]),e.geoLocation&&(s.location=e.geoLocation,Object.keys(e.geoLocation).forEach(a=>{s.location[a]=`${e.geoLocation[a]}`})),e.proximity){const a=Date.now()/1e3-e.proximity.timestamp;a<e.proximity.validTime&&(s.prior={xyz:[`${e.proximity.x}`,`${e.proximity.y}`,`${e.proximity.z}`],accuracy:`${e.proximity.accuracy}`,delay:`${a}`,is2d:e.proximity.is2d?"1":"0"})}if(e.blockIds&&e.blockIds.length>0&&(s.blockid=e.blockIds),s.frameTimestamp=`${t.timestamp}`,this._versionTag>=6&&t.cameraTransform){let a=pi(t.cameraTransformType,t.trackingStatus,t.cameraTransform);a&&a.length>0&&(s.cameraTransformParam=a,s.cameraTransformType=Y[t.cameraTransformType],s.recentFrames=i)}return s}_composeRequestParamsLegacy(t,e,i){let s={appId:this._clsConfig.appId,cameraParam:t.cameraParams.getParamString(),...i};return e.geoLocation&&(s.location=JSON.stringify(e.geoLocation)),s}async _getEmaUrl(t){let e={};return e.appId=this._clsConfig.appId,e.apiKey=this._clsConfig.apiKey,e.timestamp=`${Date.now()}`,e.signature=this._calcSignature(e),qt(`${this._clsHost}/cls/arannotation/${t}`,"GET",e,null,null)}_validateClsConfig(){var t,e,i;if(!this._clsConfig)throw new Error("CloudLocalizer.initialize: Empty Cloud Localization Service Config");if(!this._clsConfig.appId||this._clsConfig.appId.length==0)throw new Error("CloudLocalizer.initialize: AppId is empty");if(!this._clsConfig.apiKey||this._clsConfig.apiKey.length==0)throw new Error("CloudLocalizer.initialize: ApiKey is empty");if(!this._clsConfig.apiSecret||this._clsConfig.apiSecret.length==0)throw new Error("CloudLocalizer.initialize: ApiSecret is empty");if(!this._clsConfig.serverAddress||this._clsConfig.serverAddress.length==0)throw new Error("CloudLocalizer.initialize: ServerAddress is empty");this._trimClsConfig();const s="[0-9a-f]",a=new RegExp(s,"ig");if(((t=this._clsConfig.appId.match(a))==null?void 0:t.length)!==this._clsConfig.appId.length)throw new Error(`CloudLocalizer.initialize: AppId ${this._clsConfig.appId} is invalid`);if(((e=this._clsConfig.apiKey.match(a))==null?void 0:e.length)!==this._clsConfig.apiKey.length)throw new Error(`CloudLocalizer.initialize: ApiKey ${this._clsConfig.apiKey} is invalid`);if(((i=this._clsConfig.apiSecret.match(a))==null?void 0:i.length)!==this._clsConfig.apiSecret.length)throw new Error(`CloudLocalizer.initialize: ApiSecret ${this._clsConfig.apiSecret} is invalid`)}_trimClsConfig(){this._clsConfig.appId.trim(),this._clsConfig.apiKey.trim(),this._clsConfig.apiSecret.trim(),this._clsConfig.serverAddress.trim()}_checkUrl(){if(!this._pathPostfix||this._pathPostfix.length==0){this._fullPath=this._clsConfig.serverAddress.toLowerCase();return}this._fullPath=`${this._clsHost}/${this._pathPostfix}`;try{let t=!1,e=null;this._pathPostfix.includes("/ext")&&(t=!0);const i=this._pathPostfix.split("/");if(i.length==0)throw new Error("Invalid path post-fix: "+this._pathPostfix);if(e=parseInt(i[0].substring(1)),e>=6&&t)this._versionTag=6;else if(e==5&&!t)this._versionTag=5;else if(e<5&&!t)this._versionTag=4;else throw new Error("Invalid path post-fix combination: "+this._pathPostfix)}catch(t){throw t}}_queryUrlHost(){const t="(https?://)([^:^/]*)(:\\d*)?(.*)?",e=new RegExp(t,"ig");let i=this._clsConfig.serverAddress;if(!e.test(i))throw new Error(`Server Address ${i} is not valid.`);const s=i.split(e);return`${s[1]}${s[2]}${s[3]||""}`}_calcSignature(t){let e=Object.keys(t).sort().map(i=>`${i}${t[i]}`).concat(this._clsConfig.apiSecret).join("");return he(e)}}const As=3600,vi="https://uac.easyar.com",Ai="/vps/v1/ext/file/localize";let Kt=null;class Si extends $e{constructor(t,e){super(),this._landmarkHost=null,this._token="",this._requestInterval=1e3,this._timeout=6e3,this._usingGstratFlag=!1,this._boundaryStr="THISISABOUNDARYASDEFAULT",this._landmarkConfig=t,this._boundaryStr=He(32),e==At.Wechat&&(Kt=Ae)}get landmarkHost(){return this._landmarkHost}get token(){return this._token}get config(){return this._landmarkConfig}get requestInterval(){return this._requestInterval}get requestTimeout(){return this._timeout}get isUsingGstrat(){return this._usingGstratFlag}get requestFrameCount(){return this._usingGstratFlag?2:1}async initialize(){try{this._validateConfig(),await this.refreshToken(),this._landmarkHost=this._queryUrlHost().toLowerCase(),this._initFlag=!0}catch(t){throw t}}reset(){this._isTrial=!1,this._initFlag=!1,this._landmarkConfig=null,this._landmarkHost=null}setRequestConfig(t){if(t.requestInterval<300)throw new Error("Cannot set requestInterval less than 300ms");if(t.timeout<5e3)throw new Error("Cannot set timeout less than 5000ms");this._requestInterval=Math.max(t.requestInterval,300),this._timeout=t.timeout}async refreshToken(){const t=As,e=new Date().getTime()+t*1e3,i=`[{"service":"ecs:vps1","effect":"Allow","resource":["${this._landmarkConfig.appId}"],"permission":["READ","WRITE"]}]`;let s={};s.expires=t.toString(),s.timestamp=e.toString(),s.apiKey=this._landmarkConfig.apiKey,s.acl=i;let a=Object.keys(s).sort().map(n=>`${n}${s[n]}`).concat(this._landmarkConfig.apiSecret).join("");s.signature=he(a);try{const n=await Kt(`${vi}/token/v2`,"POST",null,null,s);if(n.statusCode==0)G.log("Landmark token refreshed"),this._token=n.result.token,this._tokenExpireTime=e;else throw new Error(`${n.msg} from ${vi}/token/v2`)}catch(n){throw n}}composeRequestParams(t,e,i,s){return this._composeRequestParams(t,e,i,s)}async requestGeoFilter(t){if(!t)return new Error("No gps at geo filtering");let e=null;t.altitude?e=`[${t.longitude}, ${t.latitude}, ${t.altitude}]`:e=`[${t.longitude}, ${t.latitude}]`;let i={};return i.appId=this._landmarkConfig.appId,i.apiKey=this._landmarkConfig.apiKey,i.gps=e,i.timestamp=`${Date.now()}`,i.signature=this._calcSignature(i),Kt(`${this._landmarkHost}/vps/v1/gps/filter`,"POST",i,null,null)}async requestServiceSingleImage(t,e,i){if(!e)return new Error("No image at landmark cls request");this._isTokenExpired()&&await this.refreshToken();let s=null;if(i===!0){if(e.length==0)return new Error("Empty image string at cls request with single image string");G.log("Landmark cls with single image from string"),s=Wt(e.substr(23))}else{if(e.byteLength==0)return new Error("Empty image buffer at cls request with single image buffer");G.log("Landmark cls with single image from buffer"),s=e}let a=Object.keys(t).map(f=>`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="${f}"\r
\r
`+t[f]).join("")+`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="image"; filename="image.jpg"\r
Content-Type: application/octet-stream\r
Content-Transfer-Encoding: binary\r
\r
`,n=`\r
--${this._boundaryStr}--`,o=new le.TextEncoder,l=o.encode(a),h=new Uint8Array(s),c=o.encode(n),m=new Uint8Array(l.length+h.length+c.length);m.set(l,0),m.set(h,l.length),m.set(c,l.length+h.length);let d=m.buffer;const g={"content-type":"multipart/form-data; boundary="+this._boundaryStr,Authorization:this._token};return Kt(this._landmarkHost+Ai,"POST",null,g,d,this._timeout)}async requestService(t,e){if(!e)return new Error("No frame datas at landmark cls request");if(e.length<2)return new Error("No enough frame datas at landmark cls request");if((!e[0].imageString||e[0].imageString.length==0)&&(!e[0].imageBuffer||e[0].imageBuffer.byteLength==0))return new Error("Pre frame lacks image at landmark cls request");if((!e[1].imageString||e[1].imageString.length==0)&&(!e[1].imageBuffer||e[1].imageBuffer.byteLength==0))return new Error("Pre frame lacks image at landmark cls request");this._isTokenExpired()&&await this.refreshToken();let i=null,s=null;e[0].imageString&&e[0].imageString.length>0?(i=Wt(e[0].imageString.substr(23)),G.log("Block cls with two images. The first image is from string")):(i=e[0].imageBuffer,G.log("Block cls with two images. The first image is from buffer")),e[1].imageString&&e[1].imageString.length>0?(s=Wt(e[1].imageString.substr(23)),G.log("Block cls with two images. The second image is from string")):(s=e[1].imageBuffer,G.log("Block cls with two images. The second image is from buffer"));let a=Object.keys(t).map(C=>`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="${C}"\r
\r
`+t[C]).join("")+`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="image"; filename="image.jpg"\r
Content-Type: application/octet-stream\r
Content-Transfer-Encoding: binary\r
\r
`,n=`\r
--${this._boundaryStr}\r
Content-Disposition: form-data;name="preImage"; filename="preImage.jpg"\r
Content-Type: application/octet-stream\r
Content-Transfer-Encoding: binary\r
\r
`,o=`\r
--${this._boundaryStr}--`,l=new le.TextEncoder,h=l.encode(a),c=new Uint8Array(s),m=l.encode(n),d=new Uint8Array(i),g=l.encode(o),f=new Uint8Array(h.length+c.length+m.length+d.length+g.length),v=0;f.set(h,v),v+=h.length,f.set(c,v),v+=c.length,f.set(m,v),v+=m.length,f.set(d,v),v+=d.length,f.set(g,v),v+=g.length;const S={"content-type":"multipart/form-data; boundary="+this._boundaryStr,Authorization:this._token};return Kt(this._landmarkHost+Ai,"POST",null,S,f.buffer,this._timeout)}async getEmaRawData(t){try{const e=await this._getEmaUrl(t);if(e.statusCode!=0)throw new Error("EMA request failed: "+e.msg);if(!e.result||!e.result.emaUrl||e.result.emaUrl.length==0)throw new Error("EMA request succeeded, but result url is empty");const i={"content-type":" "};return Kt(e.result.emaUrl,"GET",null,i,null)}catch(e){throw e}}_isTokenExpired(){return new Date().getTime()>this._tokenExpireTime}_composeRequestParams(t,e,i,s){let a=null;if(t.length==1){let n=this._prepareRequestData(t[0],e[0],i[0]);a={appId:this._landmarkConfig.appId,apiKey:this._landmarkConfig.apiKey,clientSupplier:"wxmpp",clientVersion:oe,timestamp:Date.now(),args:JSON.stringify(n),...s}}else if(t.length>=2){let n=this._prepareRequestData(t[0],e[0],i[0]),o=this._prepareRequestData(t[1],e[1],i[1]);a={appId:this._landmarkConfig.appId,apiKey:this._landmarkConfig.apiKey,clientSupplier:"wxmpp",clientVersion:oe,timestamp:Date.now(),args:JSON.stringify(o),pres:JSON.stringify(n),...s}}return a}_prepareRequestData(t,e,i){let s={schema:"1.0",cameraSize:t.cameraParams.getSize(),cameraParam:t.cameraParams.getParam(),cameraOrientation:`${t.cameraParams.cameraOrientation}`};if(e.acce&&(s.acce=[`${e.acce.x}`,`${e.acce.y}`,`${e.acce.z}`]),e.geoLocation&&(s.location=e.geoLocation,Object.keys(e.geoLocation).forEach(a=>{s.location[a]=`${e.geoLocation[a]}`})),e.proximity){const a=Date.now()/1e3-e.proximity.timestamp;a<e.proximity.validTime&&(s.prior={xyz:[`${e.proximity.x}`,`${e.proximity.y}`,`${e.proximity.z}`],accuracy:`${e.proximity.accuracy}`,delay:`${a}`,is2d:e.proximity.is2d?"1":"0"})}if(e.blockIds&&e.blockIds.length>0&&(s.blockid=e.blockIds),s.frameTimestamp=`${t.timestamp}`,t.cameraTransform){let a=pi(t.cameraTransformType,t.trackingStatus,t.cameraTransform);a&&a.length>0&&(s.cameraTransformParam=a,s.cameraTransformType=Y[t.cameraTransformType],s.recentFrames=i)}return s}async _getEmaUrl(t){let e={};return e.appId=this._landmarkConfig.appId,e.apiKey=this._landmarkConfig.apiKey,e.timestamp=`${Date.now()}`,e.signature=this._calcSignature(e),Kt(`${this._landmarkHost}/vps/arannotation/${t}`,"GET",e,null,null)}_validateConfig(){var t,e,i;if(!this._landmarkConfig)throw new Error("LandmarkLocalizer.initialize: Empty Service Config");if(!this._landmarkConfig.appId||this._landmarkConfig.appId.length==0)throw new Error("LandmarkLocalizer.initialize: AppId is empty");if(!this._landmarkConfig.apiKey||this._landmarkConfig.apiKey.length==0)throw new Error("LandmarkLocalizer.initialize: ApiKey is empty");if(!this._landmarkConfig.apiSecret||this._landmarkConfig.apiSecret.length==0)throw new Error("LandmarkLocalizer.initialize: ApiSecret is empty");if(!this._landmarkConfig.serverAddress||this._landmarkConfig.serverAddress.length==0)throw new Error("LandmarkLocalizer.initialize: ServerAddress is empty");this._trimConfig();const s="[0-9a-f]",a=new RegExp(s,"ig");if(((t=this._landmarkConfig.appId.match(a))==null?void 0:t.length)!==this._landmarkConfig.appId.length)throw new Error(`LandmarkLocalizer.initialize: AppId ${this._landmarkConfig.appId} is invalid`);if(((e=this._landmarkConfig.apiKey.match(a))==null?void 0:e.length)!==this._landmarkConfig.apiKey.length)throw new Error(`LandmarkLocalizer.initialize: ApiKey ${this._landmarkConfig.apiKey} is invalid`);if(((i=this._landmarkConfig.apiSecret.match(a))==null?void 0:i.length)!==this._landmarkConfig.apiSecret.length)throw new Error(`LandmarkLocalizer.initialize: ApiSecret ${this._landmarkConfig.apiSecret} is invalid`)}_trimConfig(){this._landmarkConfig.appId.trim(),this._landmarkConfig.apiKey.trim(),this._landmarkConfig.apiSecret.trim(),this._landmarkConfig.serverAddress.trim()}_queryUrlHost(){const t="(https?://)([^:^/]*)(:\\d*)?(.*)?",e=new RegExp(t,"ig");let i=this._landmarkConfig.serverAddress;if(!e.test(i))throw new Error(`Server Address ${i} is not valid.`);const s=i.split(e);return`${s[1]}${s[2]}${s[3]||""}`}_calcSignature(t){let e=Object.keys(t).sort().map(i=>`${i}${t[i]}`).concat(this._landmarkConfig.apiSecret).join("");return he(e)}}var Ht=(r=>(r[r.Accelerometer=1]="Accelerometer",r[r.GeoLocation=2]="GeoLocation",r[r.Attitute=4]="Attitute",r))(Ht||{});class Ge{constructor(){this._pauseFlag=!0,this._initFlag=!1,this._geoLocationInputMode="Onsite",this._simulatorGeoLocation=null,this._onError=new lt,this._blockLocalized=new lt,this._updateCameraTransform=new lt,this._onRequireImage=new lt}get initFlag(){return this._initFlag}get serviceType(){return this._serviceType}get geoLocationInputMode(){return this._geoLocationInputMode}get errorEvent(){return this._onError.event}get blockLocalizedEvent(){return this._blockLocalized.event}get updateCameraTransformEvent(){return this._updateCameraTransform.event}get requireImageEvent(){return this._onRequireImage.event}initialize(){try{this.start()}catch(t){throw new Error(t)}this._initFlag=!0}dispose(){var t;this.stop(),this._initFlag=!1,this._onError.dispose(),(t=this._onRequireImage)==null||t.dispose(),this._blockLocalized.dispose(),this._updateCameraTransform.dispose()}}const xe=class{constructor(r){this.element=r,this.next=xe.Undefined,this.prev=xe.Undefined}};let it=xe;it.Undefined=new xe(void 0);class xi{constructor(){this._first=it.Undefined,this._last=it.Undefined,this._size=0}get size(){return this._size}isEmpty(){return this._first===it.Undefined}clear(){let t=this._first;for(;t!==it.Undefined;){const e=t.next;t.prev=it.Undefined,t.next=it.Undefined,t=e}this._first=it.Undefined,this._last=it.Undefined,this._size=0}unshift(t){return this._insert(t,!1)}push(t){return this._insert(t,!0)}_insert(t,e){const i=new it(t);if(this._first===it.Undefined)this._first=i,this._last=i;else if(e){const a=this._last;this._last=i,i.prev=a,a.next=i}else{const a=this._first;this._first=i,i.next=a,a.prev=i}this._size+=1;let s=!1;return()=>{s||(s=!0,this._remove(i))}}shift(){if(this._first!==it.Undefined){const t=this._first.element;return this._remove(this._first),t}}pop(){if(this._last!==it.Undefined){const t=this._last.element;return this._remove(this._last),t}}_remove(t){if(t.prev!==it.Undefined&&t.next!==it.Undefined){const e=t.prev;e.next=t.next,t.next.prev=e}else t.prev===it.Undefined&&t.next===it.Undefined?(this._first=it.Undefined,this._last=it.Undefined):t.next===it.Undefined?(this._last=this._last.prev,this._last.next=it.Undefined):t.prev===it.Undefined&&(this._first=this._first.next,this._first.prev=it.Undefined);this._size-=1}*[Symbol.iterator](){let t=this._first;for(;t!==it.Undefined;)yield t.element,t=t.next}}class Ce{update(t,e){this._update(new K().mul2(e.clone().getInverse(),t.clone().getInverse()))}_update(t){this._TboTweenStart=this._TboInbetween?this._TboInbetween:this._TboTweenEnd,this._TboTweenEnd=t,this._isTweening=this._TboTweenStart&&this._TboTweenEnd&&!xs(this._TboTweenStart,this._TboTweenEnd),this._isTweenStarted=!1}getPose(t,e){if(!this._TboTweenEnd)return null;if(this._isTweenStarted||(this._tweenStartTime=e,this._isTweenStarted=!0),this._isTweening){const i=e-this._tweenStartTime,s=Math.min(1,i);this._TboInbetween=Cs(this._TboTweenStart,this._TboTweenEnd,s)}else this._TboInbetween=this._TboTweenEnd;return new K().mul2(this._TboInbetween.clone(),t.clone()).getInverse()}jump(){this._isTweening=!1}}class Ci extends Ce{constructor(){super(...arguments),this._dataCache=[],this._preResult=null}request(t,e,i){let s={localTwc:{data:t.clone().transpose().array},mapTcw:{data:e.clone().transpose().array},timestamp:i};this._dataCache.push(s);let a=0;for(;s.timestamp-this._dataCache[a].timestamp>90;)a++;return a>0&&(this._dataCache=this._dataCache.slice(a)),this._dataCache.length<1?Promise.reject("poseFusion empty"):wi(this._dataCache,n=>{this._preResult&&(n.result.status<this._preResult.status||n.result.timestamp<this._preResult.timestamp)||(this._preResult=n.result,this._update(new K().set(n.result.transform.data).transpose()))})}update(t,e){throw new Error("update not allowed in legacy mode")}getPose(t,e){let i=super.getPose(t,e);return i&&Ss(i),i}jump(){super.jump(),this._dataCache=[]}}class je{update(t,e){this._Tbo=new K().mul2(e.clone().getInverse(),t.clone().getInverse())}getPose(t){return new K().mul2(this._Tbo.clone(),t.clone()).getInverse()}}function Ss(r){const t=r.data;let e=1/new et(t[0],t[1],t[2]).magnitude();t[0]*=e,t[1]*=e,t[2]*=e,t[4]*=e,t[5]*=e,t[6]*=e,t[8]*=e,t[9]*=e,t[10]*=e,t[15]=1}function xs(r,t){const e=r.decompose(),i=t.decompose(),s=e.rotation.getInverse().mul(i.rotation).data;let a=(s[0]+s[5]+s[10]+s[15]-1.000001)/2;a>=1&&(a=1),a<=-1&&(a=-1);const n=Math.acos(a)*180/Math.PI,o={x:e.position.x-i.position.x,y:e.position.y-i.position.y,z:e.position.z-i.position.z};return Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z)>5||n>90}function Cs(r,t,e){const i=r.decompose(),s=t.decompose(),a=new pt().setFromMat4(r),n=new pt().setFromMat4(t),o={x:i.position.x*(1-e)+s.position.x*e,y:i.position.y*(1-e)+s.position.y*e,z:i.position.z*(1-e)+s.position.z*e},l={x:i.scale.x*(1-e)+s.scale.x*e,y:i.scale.y*(1-e)+s.scale.y*e,z:i.scale.z*(1-e)+s.scale.z*e},h=new pt().slerp(a,n,e);return new K().setTRS(o,h,l)}class ki{constructor(){this.lastFrameTs=0}detect(t,e){if(this.lastFrameTs===0||!this.lastVio)return this.lastFrameTs=e,this.lastVio=t,!1;const i=this.lastVio.getPosition(),s=t.getPosition(),a=et.sub(i,s).magnitude(),n=e-this.lastFrameTs;if(n<1e-7)return!1;let o=!1;return(a/n>6||a>3)&&(o=!0),this.lastFrameTs=e,this.lastVio=t.clone(),o}reset(){this.lastFrameTs=0,this.lastVio=null}}class We{constructor(t){this._instances=null,this._instances=t}get blockInstances(){return this._instances}}class bi{constructor(t){this.blockInstances=[],this.inputFrame=t.inputFrame,this.localizationStatus=t.localizerStatus,this.blockInstances=t.blockInstances,this.serverResponseDuration=t.serverResponseDuration,this.serverCalculationDuration=t.serverCalculationDuration,this.errorMessage=t.localizerStatus==rt.UnknownError?t.exceptionInfo:null,this.extraInfo=t.extraInfo}}let me=0;function ks(){me<1e4?me+=1:me=0}const bs=120;class Ii extends Ge{constructor(t){super(),this._recentFrames=[],this._serviceType="block",this._previousIntervals=new xi,this._onLegacyBlockService=new lt,this._onGeoLocationStatus=new lt,this._localizationResponse=new lt,this._continuousLocalization=!0,this._enableStabilization=!0,this._localizationOnly=!1,this._localizeOnceCallback=null,this._blockLocalizer=new ys(t),this._vioJumpDetector=new ki,this._requestFrameInterval=t.requestInterval,this._resetBuffer()}get localizationResponseEvent(){return this._localizationResponse.event}get geoLocationStatus(){return this._onGeoLocationStatus.event}get legacyBlockServiceEvent(){return this._onLegacyBlockService.event}dispose(){var t,e,i;super.dispose(),this._resetBuffer(),(t=this._accelerometer)==null||t.dispose(),(e=this._geoLocationProvider)==null||e.dispose(),(i=this._proximityLocationProvider)==null||i.dispose(),this._onLegacyBlockService.dispose(),this._onGeoLocationStatus.dispose(),this._localizationResponse.dispose()}stop(){var t;this._pauseFlag=!0,ks(),(t=this._accelerometer)==null||t.stop(),this._geoLocationProvider&&this._geoLocationProvider.stop(),this._proximityLocationProvider&&this._proximityLocationProvider.stop(),this.reset()}reset(){this._arSessionId=null,this._currentBlockId=null,this._currentBlockName=null,this._resetBuffer(),this._resetPoseFusion(),this._vioJumpDetector.reset(),this._recentFrames=[],this._lastLocalizeTimeMs=0}start(){const t=this._blockLocalizer.blockServiceHandler.versionTag;if(!t)throw new Error("Block service version invalid");if(t<ue.V6_And_Later&&this._onLegacyBlockService.fire(),this._resetPoseFusion(),this._accelerometer)try{this._accelerometer.start()}catch(e){throw new Error("Fail to start accelerometer: "+e.message)}if(this._geoLocationProvider)try{this._geoLocationInputMode=="Onsite"&&(this._geoLocationProvider.start(),this._onGeoLocationStatus.fire(!0))}catch(e){throw this._onGeoLocationStatus.fire(!1),this._geoLocationInputMode="Simulator",new Error("Fail to start GPS: "+e.message)}else this._onGeoLocationStatus.fire(!1),this._geoLocationInputMode="Simulator";if(this._proximityLocationProvider)try{this._proximityLocationProvider.start()}catch(e){throw new Error("Fail to start proximity location: "+e.message)}this._pauseFlag=!1}onFrameInput(t){if(this._pauseFlag==!0)return;!this._localizationOnly&&!t.cameraTransform&&(G.log("Localization-only due to no camera transform"),this._localizationOnly=!0),this._localizationOnly&&t.cameraTransform&&(t.cameraTransform=null),this._checkRequireImageCondition()&&this._onRequireImage.fire();const e=this._accelerometer.current,i=this._geoLocationInputMode=="Onsite"?this._geoLocationProvider.current:this._simulatorGeoLocation,s=this._proximityLocationProvider?this._proximityLocationProvider.current:null;if(t.imageString&&t.imageString.length>0||t.imageBuffer&&t.imageBuffer.byteLength>0){const c=new fi(e,i,s,this._priorBlockIds);G.log("Frame data's tracking mode is: ",Y[t.cameraTransformType]),this._frameDataBuffer.push(t),this._deviceAuxInfoBuffer.push(c),this._recentFrameBuffer.push(this._recentFrames);const m=this._blockLocalizer.blockServiceHandler.requestFrameCount,d=me;if(this._frameDataBuffer.length>=m){const g=this._frameDataBuffer,f=this._deviceAuxInfoBuffer,v=this._recentFrameBuffer;this._resetBuffer(),this._blockLocalizer.resolve(g,this._message,f,v,this._arSessionId).then(S=>{if(S instanceof Error){this._onError.fire(S),this._localizeOnceCallback&&(this._localizeOnceCallback(null),this._localizeOnceCallback=null);return}const C=f[f.length-1];if(this._localizeOnceCallback&&(this._localizeOnceCallback(this._makeLocalizationResponse(S,C)),this._localizeOnceCallback=null),d==me){if(S.arSessionId&&(this._arSessionId=S.arSessionId),S.localizerStatus!=rt.Found){this._handleLocalizationResult(S,C);return}if(S.blockInstances&&(this._currentBlockId=S.blockInstances[0].blockId,this._currentBlockName=S.blockInstances[0].name),this._localizationOnly){this._handleLocalizationOnly(S,C);return}if(this._poseHolder.update(S.inputFrame.cameraTransform,S.blockInstances[0].pose),this._poseFusion){if(this._poseFusion.update(S.inputFrame.cameraTransform,S.blockInstances[0].pose),j.getInstance().isRecordingData){const R=this._poseFusion.getPose(S.inputFrame.cameraTransform,S.inputFrame.timestamp).transpose().array.map(N=>`${N}`);j.getInstance().recordNativePose({pose:R,frameTimestamp:`${S.inputFrame.timestamp}`})}this._handleLocalizationResult(S,C)}else this._poseFusionLegacy&&this._poseFusionLegacy.request(S.inputFrame.cameraTransform,S.blockInstances[0].pose,S.inputFrame.timestamp).then(()=>{if(j.getInstance().isRecordingData){const R=this._poseFusionLegacy.getPose(S.inputFrame.cameraTransform,S.inputFrame.timestamp).transpose().array.map(N=>`${N}`);j.getInstance().recordNativePose({pose:R,timestamp:`${S.inputFrame.timestamp}`})}this._handleLocalizationResult(S,C)})}}),this._recentFrames=[]}}if(this._localizationOnly)return;this._vioJumpDetector.detect(t.cameraTransform,t.timestamp)&&(this._poseFusion?this._poseFusion.jump():this._poseFusionLegacy&&this._poseFusionLegacy.jump());let a=t.cameraParams.getImageOrientation();const n=this._blockLocalizer.blockServiceHandler.requestTimeout;if(this._blockLocalizer.blockServiceHandler.versionTag>=ue.V6_And_Later){const c=di(t.cameraTransformType,t.timestamp,t.trackingStatus,t.cameraTransform,e,a);c&&c.length>0&&this._updateRecentFrames(c,n)}let o=null;if(this._enableStabilization?this._poseFusion?o=this._poseFusion.getPose(t.cameraTransform,t.timestamp):this._poseFusionLegacy&&(o=this._poseFusionLegacy.getPose(t.cameraTransform,t.timestamp)):o=this._poseHolder.getPose(t.cameraTransform),!o){const c=new We(null);this._handleBlockTrackerResult(c,null);return}let l=[new Nt(this._currentBlockId,this._currentBlockName,o)];const h=new We(l);this._handleBlockTrackerResult(h,new K().setFromEulerAngles(0,0,-a))}setUserMessage(t){this._message=t}setGeoLocationInput(t,e){if(t!="Onsite"&&t!="Simulator")throw new Error("InputMode is Invalid: "+t);if(this._geoLocationInputMode=t,t=="Simulator"){if(e&&(!e.longitude||!e.latitude))throw new Error("Invalid Simulator GPS: "+JSON.stringify(e));this._simulatorGeoLocation=e,this._geoLocationProvider.stop()}else try{this._geoLocationProvider.start()}catch(i){throw this._onGeoLocationStatus.fire(!1),this._geoLocationInputMode="Simulator",this._simulatorGeoLocation=null,new Error("Fail to start GPS: "+i.message)}}setPriorBlockIds(t){if(!t){this._priorBlockIds=[];return}this._priorBlockIds=t.filter(e=>e!=="")}toggleContinuousLocalization(t){this._lastLocalizeTimeMs=null,this._previousIntervals.clear(),this._continuousLocalization=t}toggleLocalizationOnly(t){t&&(this._resetPoseFusion(),this._vioJumpDetector.reset(),this._recentFrames=[]),this._localizationOnly=t}toggleStablize(t){this._enableStabilization=t}async localizeOnce(){return this._onRequireImage.fire(),new Promise(t=>{this._localizeOnceCallback=t})}_resetBuffer(){this._frameDataBuffer=[],this._deviceAuxInfoBuffer=[],this._recentFrameBuffer=[]}_updateRecentFrames(t,e){if(!t||t.length==0)return;const i=Math.min(4*this._requestFrameInterval,e);let s=0;for(let n=0;n<this._recentFrames.length&&(Number(t.split(",")[0])-Number(this._recentFrames[n].split(",")[0]))*1e3>=i;++n)++s;s>0&&this._recentFrames.splice(0,s);const a=this._recentFrames.length-bs;a>0&&this._recentFrames.splice(0,a),this._recentFrames.push(t)}_handleLocalizationOnly(t,e){this._handleLocalizationResult(t,e);const i=t.inputFrame.cameraParams.getImageOrientation(),s=new K().setFromEulerAngles(0,0,-i),a=new K().mul2(t.blockInstances[0].pose.clone().getInverse(),s.clone().getInverse()).array;this._updateCameraTransform.fire(a)}_handleLocalizationResult(t,e){t.localizerStatus==rt.Found&&this._blockLocalized.fire(t.blockInstances[0]);const i=this._makeLocalizationResponse(t,e);this._localizationResponse.fire(i)}_handleBlockTrackerResult(t,e){if(t.blockInstances==null)return;const i=new K().mul2(t.blockInstances[0].pose.clone().getInverse(),e.clone().getInverse()).array;this._updateCameraTransform.fire(i)}_makeLocalizationResponse(t,e){const i=this._blockLocalizer.blockServiceHandler;let s=new bi(t);return s.acce=e.acce,s.geoLocation=e.geoLocation,s.proximityLocation=e.proximity,s.appId=i.config.appId,s.requestTimestamp=this._lastLocalizeTimeMs,s.requestInterval=i.requestInterval,s.server=i.clsHost,s}_checkRequireImageCondition(){if(!this._continuousLocalization)return!1;const t=new Date().getTime();if(this._lastLocalizeTimeMs==null)return this._lastLocalizeTimeMs=t,!0;this._syncRequestInterval();const e=t-this._lastLocalizeTimeMs;if(e<this._requestFrameInterval/2)return!1;let i=0,s=0;for(const a of this._previousIntervals)i+=(a-this._requestFrameInterval)*Math.exp(-s*.5),s+=1;return e<this._requestFrameInterval-i?!1:(this._previousIntervals.unshift(e),this._previousIntervals.size>10&&this._previousIntervals.pop(),this._lastLocalizeTimeMs=t,!0)}_syncRequestInterval(){let t=this._blockLocalizer.blockServiceHandler.requestInterval;this._blockLocalizer.blockServiceHandler.isUsingGstrat===!0&&(t=Math.min(t/2,500),t=Math.max(t,300)),this._requestFrameInterval=t}_resetPoseFusion(){const t=this._blockLocalizer.blockServiceHandler.versionTag;!t||(this._poseHolder=new je,this._poseFusion=null,this._poseFusionLegacy=null,t>=ue.V6_And_Later?this._poseFusion=new Ce:this._poseFusionLegacy=new Ci)}}class Ei{constructor(){this.blockInstances=[]}}class Is{get landmarkServiceHandler(){return this._landmarkServiceHandler}constructor(t){this._landmarkServiceHandler=t}geoFilter(t){const e={longitude:t.longitude,latitude:t.latitude,altitude:t.altitude};return this._landmarkServiceHandler.requestGeoFilter(e)}resolve(t,e,i,s,a,n){return new Promise((o,l)=>{t.length==0&&l(new Error("Request sequence is empty when resolving in landmark localizer"));const h=this._landmarkServiceHandler.requestFrameCount;t.length!=h&&l(new Error(`Frame request sequences size should be ${h}, but it is currently ${t.length}`)),i.length!=h&&l(new Error(`DeviceAuxiliaryInfo request sequences size should be ${h}, but it is currently ${i.length}`)),s.length!=h&&l(new Error(`RecentFrameBuffer request sequences size should be ${h}, but it is currently ${s.length}`)),a||l(new Error("Empty spotVersionId when resolving in landmark localizer"));for(const d of t)(!d.imageString||d.imageString.length==0)&&(!d.imageBuffer||d.imageBuffer.byteLength==0)&&l(new Error("Empty Image when resolving in landmark localizer"));const c=new Date().getTime();let m={};if(e)try{m=JSON.parse(e)}catch{l(new Error("Fail to parse user message in localizer"))}m.startTime=c,m.spotVersionId=a,n!=null&&(m.arSessionId=n),this._landmarkRequest(t,i,s,m).then(d=>{if(d instanceof Error&&l(d),j.getInstance().isRecordingData){let v=d;v.frameTimestamp=t[t.length-1].timestamp,v.appid=this._landmarkServiceHandler.config.appId,j.getInstance().recordClsResponse(v)}const g=new Ei;g.inputFrame=t[t.length-1],d.arSessionId&&(g.arSessionId=d.arSessionId),d.spotVersionId&&(g.spotVersionId=d.spotVersionId),g.extraInfo=d.extraInfo,g.exceptionInfo=d.msg;const f=new Date().getTime();g.serverResponseDuration=f-c,g.serverCalculationDuration=d.duration,d.statusCode!=0?d.statusCode==17?g.localizerStatus=rt.NotFound:d.statusCode==21?g.localizerStatus=rt.QpsLimitExceeded:d.statusCode==100017?g.localizerStatus=rt.WakingUp:g.localizerStatus=rt.UnknownError:(g.localizerStatus=rt.Found,d.result&&g.blockInstances.push(Nt.fromLandmarkLocalizationResult(d.result[0]))),o(g)})})}_landmarkRequest(t,e,i,s){const a=this._landmarkServiceHandler.composeRequestParams(t,e,i,s);if(j.getInstance().isRecordingData)if(t.length==1)t[0].imageString&&t[0].imageString.length>0?j.getInstance().recordRequestArgs({...JSON.parse(a.args),base64:t[0].imageString}):t[0].imageBuffer&&t[0].imageBuffer.byteLength>0?j.getInstance().recordRequestArgs({...JSON.parse(a.args),base64:jt(t[0].imageBuffer)}):j.getInstance().recordRequestArgs({...JSON.parse(a.args)});else{let n=null,o=null;t[0].imageString&&t[0].imageString.length>0?n=t[0].imageString:t[0].imageBuffer&&t[0].imageBuffer.byteLength>0&&(n=jt(t[0].imageBuffer)),t[1].imageString&&t[1].imageString.length>0?o=t[1].imageString:t[1].imageBuffer&&t[1].imageBuffer.byteLength>0&&(o=jt(t[1].imageBuffer)),n&&n.length>0?j.getInstance().recordRequestArgs({...JSON.parse(a.pres),base64:n}):j.getInstance().recordRequestArgs({...JSON.parse(a.pres)}),o&&o.length>0?j.getInstance().recordRequestArgs({...JSON.parse(a.args),base64:o}):j.getInstance().recordRequestArgs({...JSON.parse(a.args)})}if(t.length<=1){if(t[0].imageBuffer&&t[0].imageBuffer.byteLength>0)return this._landmarkServiceHandler.requestServiceSingleImage(a,t[0].imageBuffer,!1);if(t[0].imageString&&t[0].imageString.length>0)return this._landmarkServiceHandler.requestServiceSingleImage(a,t[0].imageString,!0);G.log("No image buffer nor string at landmark cls request")}return this._landmarkServiceHandler.requestService(a,t)}}class Ke{constructor(t){this._instances=null,this._instances=t}get blockInstances(){return this._instances}}class Fi{constructor(t){this.blockInstances=[],this.inputFrame=t.inputFrame,this.localizationStatus=t.localizerStatus,this.blockInstances=t.blockInstances,this.serverResponseDuration=t.serverResponseDuration,this.serverCalculationDuration=t.serverCalculationDuration,this.errorMessage=t.localizerStatus==rt.UnknownError?t.exceptionInfo:null,this.extraInfo=t.extraInfo}}let Yt=0;function Es(){Yt<1e4?Yt+=1:Yt=0}const Fs=120;class Ti extends Ge{constructor(t){super(),this._recentFrames=[],this._serviceType="landmark",this._previousIntervals=new xi,this._geoFilterIntervalMs=3e4,this._localizationResponse=new lt,this._continuousLocalization=!0,this._enableStabilization=!0,this._localizationOnly=!1,this._localizeOnceCallback=null,this._landmarkLocalizer=new Is(t),this._vioJumpDetector=new ki,this._requestFrameInterval=t.requestInterval,this._resetBuffer()}get localizationResponseEvent(){return this._localizationResponse.event}dispose(){var t,e,i;super.dispose(),this._resetBuffer(),(t=this._accelerometer)==null||t.dispose(),(e=this._geoLocationProvider)==null||e.dispose(),(i=this._proximityLocationProvider)==null||i.dispose(),this._localizationResponse.dispose()}stop(){var t,e;this._pauseFlag=!0,Es(),(t=this._accelerometer)==null||t.stop(),(e=this._geoLocationProvider)==null||e.stop(),this._proximityLocationProvider&&this._proximityLocationProvider.stop(),this.reset()}start(){if(this._resetPoseFusion(),this._accelerometer)try{this._accelerometer.start()}catch(t){throw new Error("Fail to start accelerometer: "+t.message)}if(this._geoLocationProvider)try{this._geoLocationInputMode=="Onsite"&&this._geoLocationProvider.start()}catch(t){throw this._geoLocationInputMode="Simulator",new Error("Fail to start GPS: "+t.message)}else this._geoLocationInputMode="Simulator";if(this._geoLocationInputMode=="Simulator"&&(!this._simulatorGeoLocation||!this._simulatorGeoLocation.latitude||!this._simulatorGeoLocation.longitude))throw new Error("Geo Location Input mode is now [Simulator] for landmark tracker; But the simulator GPS is invalid: "+JSON.stringify(this._simulatorGeoLocation));if(this._proximityLocationProvider)try{this._proximityLocationProvider.start()}catch(t){throw new Error("Fail to start proximity location: "+t.message)}this._pauseFlag=!1}onFrameInput(t){if(this._pauseFlag==!0)return;this._localizationOnly&&!t.cameraTransform&&(this._localizationOnly=!0),this._localizationOnly&&t.cameraTransform&&(t.cameraTransform=null);const e=this._accelerometer.current,i=this._geoLocationInputMode=="Onsite"?this._geoLocationProvider.current:this._simulatorGeoLocation,s=this._proximityLocationProvider?this._proximityLocationProvider.current:null;if(this._checkGeoFilterCondition()){const m=Yt;this._landmarkLocalizer.geoFilter(i).then(d=>{if(m==Yt){if(d instanceof Error){this._onError.fire(d);return}if(d.statusCode!=0||!d.result){this._onError.fire(new Error(d.msg));return}if(d.result.length==0){const g=`Landmark filter empty SpotVersion id for GPS: ${i.latitude}, ${i.longitude}, ${i.altitude}`;G.log(g),this._onError.fire(new Error(g));return}this._spotVersionId=d.result,G.log("Landmark SpotVersion id: ",this._spotVersionId)}})}if(this._checkRequireImageCondition()&&this._onRequireImage.fire(),t.imageString&&t.imageString.length>0||t.imageBuffer&&t.imageBuffer.byteLength>0){const m=new fi(e,i,s,this._priorBlockIds);G.log("Frame data's tracking mode is: ",Y[t.cameraTransformType]),this._frameDataBuffer.push(t),this._deviceAuxInfoBuffer.push(m),this._recentFrameBuffer.push(this._recentFrames);const d=this._landmarkLocalizer.landmarkServiceHandler.requestFrameCount,g=Yt;if(this._frameDataBuffer.length>=d){const f=this._frameDataBuffer,v=this._deviceAuxInfoBuffer,S=this._recentFrameBuffer;this._resetBuffer(),this._landmarkLocalizer.resolve(f,this._message,v,S,this._spotVersionId,this._arSessionId).then(C=>{if(C instanceof Error){this._onError.fire(C),this._localizeOnceCallback&&(this._localizeOnceCallback(null),this._localizeOnceCallback=null);return}const R=m;if(this._localizeOnceCallback&&(this._localizeOnceCallback(this._makeLocalizationResponse(C,R)),this._localizeOnceCallback=null),g==Yt){if(C.arSessionId&&(this._arSessionId=C.arSessionId),C.localizerStatus!=rt.Found){this._handleLocalizationResult(C,R);return}if(C.blockInstances&&(this._currentBlockId=C.blockInstances[0].blockId,this._currentBlockName=C.blockInstances[0].name),this._localizationOnly){this._handleLocalizationOnly(C,R);return}if(this._poseHolder.update(C.inputFrame.cameraTransform,C.blockInstances[0].pose),this._poseFusion){if(this._poseFusion.update(C.inputFrame.cameraTransform,C.blockInstances[0].pose),j.getInstance().isRecordingData){const N=this._poseFusion.getPose(C.inputFrame.cameraTransform,C.inputFrame.timestamp).transpose().array.map(V=>`${V}`);j.getInstance().recordNativePose({pose:N,frameTimestamp:`${C.inputFrame.timestamp}`})}this._handleLocalizationResult(C,R)}}}),this._recentFrames=[]}}if(this._localizationOnly)return;this._vioJumpDetector.detect(t.cameraTransform,t.timestamp)&&this._poseFusion&&this._poseFusion.jump();let a=t.cameraParams.getImageOrientation();const n=this._landmarkLocalizer.landmarkServiceHandler.requestTimeout,o=di(t.cameraTransformType,t.timestamp,t.trackingStatus,t.cameraTransform,e,a);o&&o.length>0&&this._updateRecentFrames(o,n);let l=null;if(this._enableStabilization?this._poseFusion&&(l=this._poseFusion.getPose(t.cameraTransform,t.timestamp)):l=this._poseHolder.getPose(t.cameraTransform),!l){const m=new Ke(null);this._handleLandmarkTrackerResult(m,null);return}let h=[new Nt(this._currentBlockId,this._currentBlockName,l)];const c=new Ke(h);this._handleLandmarkTrackerResult(c,new K().setFromEulerAngles(0,0,-a))}setUserMessage(t){this._message=t}setGeoLocationInput(t,e){if(t!="Onsite"&&t!="Simulator")throw new Error("InputMode is Invalid: "+t);if(this._geoLocationInputMode=t,t=="Simulator"){if(!e||!e.longitude||!e.latitude)throw new Error("Trying to use empty or invalid gps location for Simulator Input in Landmark Tracker: "+JSON.stringify(e));this._simulatorGeoLocation=e,this._geoLocationProvider.stop()}else try{this._geoLocationProvider.start()}catch(i){throw this._geoLocationInputMode="Simulator",this._simulatorGeoLocation=null,new Error("Fail to start GPS in landmark: "+i.message)}}setPriorBlockIds(t){if(!t){this._priorBlockIds=[];return}this._priorBlockIds=t.filter(e=>e!=="")}toggleContinuousLocalization(t){this._lastLocalizeTimeMs=null,this._previousIntervals.clear(),this._continuousLocalization=t}toggleLocalizationOnly(t){t&&(this._resetPoseFusion(),this._vioJumpDetector.reset(),this._recentFrames=[]),this._localizationOnly=t}toggleStablize(t){this._enableStabilization=t}localizeOnce(){const t=new Date().getTime();if(this._lastLocalizeTimeMs==null)this._lastLocalizeTimeMs=t;else{let e=this._landmarkLocalizer.landmarkServiceHandler.requestInterval;const i=t-this._lastLocalizeTimeMs;if(i<e)throw new Error("localizeOnce called too frequently, interval: "+i.toString())}return this._lastLocalizeTimeMs=t,this._onRequireImage.fire(),new Promise(e=>{this._localizeOnceCallback=e})}reset(){this._arSessionId=null,this._spotVersionId=null,this._currentBlockId=null,this._currentBlockName=null,this._resetBuffer(),this._resetPoseFusion(),this._vioJumpDetector.reset(),this._recentFrames=[],this._lastLocalizeTimeMs=0}_resetBuffer(){this._frameDataBuffer=[],this._deviceAuxInfoBuffer=[],this._recentFrameBuffer=[]}_updateRecentFrames(t,e){if(!t||t.length==0)return;const i=Math.min(4*this._requestFrameInterval,e);let s=0;for(let n=0;n<this._recentFrames.length&&(Number(t.split(",")[0])-Number(this._recentFrames[n].split(",")[0]))*1e3>=i;++n)++s;s>0&&this._recentFrames.splice(0,s);const a=this._recentFrames.length-Fs;a>0&&this._recentFrames.splice(0,a),this._recentFrames.push(t)}_handleLocalizationOnly(t,e){this._handleLocalizationResult(t,e);const i=t.inputFrame.cameraParams.getImageOrientation(),s=new K().setFromEulerAngles(0,0,-i),a=new K().mul2(t.blockInstances[0].pose.clone().getInverse(),s.clone().getInverse()).array;this._updateCameraTransform.fire(a)}_handleLocalizationResult(t,e){t.localizerStatus==rt.Found&&this._blockLocalized.fire(t.blockInstances[0]);const i=this._makeLocalizationResponse(t,e);this._localizationResponse.fire(i)}_handleLandmarkTrackerResult(t,e){if(t.blockInstances==null)return;const i=new K().mul2(t.blockInstances[0].pose.clone().getInverse(),e.clone().getInverse()).array;this._updateCameraTransform.fire(i)}_makeLocalizationResponse(t,e){const i=this._landmarkLocalizer.landmarkServiceHandler;let s=new Fi(t);return s.acce=e.acce,s.geoLocation=e.geoLocation,s.proximityLocation=e.proximity,s.appId=i.config.appId,s.spotVersionId=this._spotVersionId,s.requestTimestamp=this._lastLocalizeTimeMs,s.requestInterval=i.requestInterval,s.server=i.landmarkHost,s}_checkGeoFilterCondition(){if(this._geoLocationInputMode=="Onsite"&&(this._geoLocationProvider.current==null||this._geoLocationProvider.current==null))return!1;if(this._geoLocationInputMode=="Simulator"&&!this._simulatorGeoLocation)return G.log("Session running in [Simulator] while geo location not set"),!1;const t=new Date().getTime();return!this._lastGeoFilterTimeMs||t-this._lastGeoFilterTimeMs>this._geoFilterIntervalMs?(this._lastGeoFilterTimeMs=t,!0):!1}_checkRequireImageCondition(){if(!this._spotVersionId||this._spotVersionId.length==0||!this._continuousLocalization)return!1;const t=new Date().getTime();if(this._lastLocalizeTimeMs==null)return this._lastLocalizeTimeMs=t,!0;this._syncRequestInterval();const e=t-this._lastLocalizeTimeMs;if(e<this._requestFrameInterval/2)return!1;let i=0,s=0;for(const a of this._previousIntervals)i+=(a-this._requestFrameInterval)*Math.exp(-s*.5),s+=1;return e<this._requestFrameInterval-i?!1:(this._previousIntervals.unshift(e),this._previousIntervals.size>10&&this._previousIntervals.pop(),this._lastLocalizeTimeMs=t,!0)}_syncRequestInterval(){let t=this._landmarkLocalizer.landmarkServiceHandler.requestInterval;this._landmarkLocalizer.landmarkServiceHandler.isUsingGstrat===!0&&(t=Math.min(t/2,500),t=Math.max(t,300)),this._requestFrameInterval=t}_resetPoseFusion(){this._poseHolder=new je,this._poseFusion=null,this._poseFusion=new Ce}}class Ri{constructor(){this._handler=null,this._externalControlFlag=!1,this._onAcceUpdate=new lt}get current(){return this._currentAcce}get onAcceUpdate(){return this._onAcceUpdate.event}}class Mi{constructor(){this._handler=null,this._externalControlFlag=!1,this._onAttituteUpdate=new lt}get onAttituteUpdate(){return this._onAttituteUpdate.event}}class Di{constructor(){this._handler=null,this._externalControlFlag=!1,this._onGpsUpdate=new lt}get current(){return this._currentGeoLocation}get onGpsUpdate(){return this._onGpsUpdate.event}}class Li{constructor(){this._handler=null,this._externalControlFlag=!0,this._onProximityUpdate=new lt}get current(){return this._currentProximityLocation}get onProximityUpdate(){return this._onProximityUpdate.event}}class Vt{get trackingStatus(){return this._trackingStatus}get cameraTransformType(){return this._cameraTransformType}get cameraParams(){return this._cameraParms}get timestamp(){return this._timestamp}get cameraTransform(){return this._cameraTransform}get imageString(){return this._imageString}get imageBuffer(){return this._imageBuffer}set cameraTransform(t){this._cameraTransform=t}constructor(t,e,i,s,a,n=null,o=null){this._trackingStatus=t,this._cameraTransformType=e,this._cameraParms=i,this._timestamp=s,this._cameraTransform=a,this._imageString=n,this._imageBuffer=o,o&&o.byteLength>0&&(this._imageString=null)}}class ke{constructor(){this._onFrameInput=new lt,this._initFlag=!1,this._imageFlag=!1}get initFlag(){return this._initFlag}get onFrameInput(){return this._onFrameInput.event}onRequireImage(){this._imageFlag=!0}}class Pi{get frameSource(){return this._frameSource}get tracker(){return this._tracker}get isReady(){return this._tracker&&this._frameSource&&this._tracker.initFlag&&this._frameSource.initFlag}assemble(t,e){this._frameSource=t,this._tracker=e,this._assemble()}dispose(){this._frameSource!=null&&this._frameSource.dispose(),this._tracker!=null&&this._tracker.dispose()}initialize(){try{this._frameSource.initFlag||this._frameSource.initialize(),this._tracker.initFlag||this._tracker.initialize()}catch(t){throw t}}async onFrameUpdate(){try{this._frameSource.onFrameUpdate()}catch(t){throw t}}_assemble(){Pe(this._frameSource.onFrameInput,t=>this._tracker.onFrameInput(t)),Pe(this._tracker.requireImageEvent,()=>this._frameSource.onRequireImage())}}class Ye{constructor(t,e){this.rotation=t,this.timestamp=e}static copyConstruct(t){return new Ye(t.rotation.clone(),t.timestamp)}}const Ts=8,Rs=200,Ms=20;class Ds{constructor(){this._previousRotationPose=new K,this._rotationBuffer=[]}getRotationPose(t){let e=0;for(let s=0;s<this._rotationBuffer.length-1&&t-this._rotationBuffer[s].timestamp>=Ms*2;++s)++e;if(e>0&&this._rotationBuffer.splice(0,e),this._rotationBuffer.length==0)return this._previousRotationPose;const i=this._rotationBuffer[this._rotationBuffer.length-1];return t-i.timestamp>Rs?this._previousRotationPose:(this._previousRotationPose=i.rotation,i.rotation)}insertData(t){const e=new pt;e.set(t.x,t.y,t.z,t.w);const i=new K().setTRS({x:0,y:0,z:0},e,{x:1,y:1,z:1}),s=t.timestamp?t.timestamp:t.systemTimestamp;this._rotationBuffer.push({timestamp:s,rotation:i});const a=this._rotationBuffer.length-Ts;a>0&&this._rotationBuffer.splice(0,a)}}let zt=null;class Ls{constructor(t,e,i){this.displayTransform270=new Float32Array([0,1,0,-1,0,0,0,0,1]),this._glCanvas=null,this._glContext=null,this._glProgram=null,this._ext=null,this._vao=null,this._dt=null,this._yTexture=null,this._uvTexture=null,this._legacyFlag=!1,this._legacyFlag=i,this._createCanvas(t,e,i),this._glCanvas=zt,this._glContext=this._glCanvas.getContext("webgl"),this._initShader()}dispose(){const t=this._glContext;t.deleteProgram(this._glProgram),t.deleteTexture(this._yTexture),t.deleteTexture(this._uvTexture),t.deleteBuffer(this._vao.posBuffer),t.deleteBuffer(this._vao.texcoordBuffer),this._ext.deleteVertexArrayOES(this._vao),this._glProgram=null,this._glContext=null,this._glCanvas=null,this._ext=null,this._vao=null,this._yTexture=null,this._uvTexture=null}_initShader(){const t=this._glContext;let e=null;this._legacyFlag?e=`  attribute vec2 a_position;
                    attribute vec2 a_texCoord;
                    uniform mat3 displayTransform;
                    varying vec2 v_texCoord;
                    void main() {
                        vec3 p = displayTransform * vec3(a_position, 0);
                        gl_Position = vec4(p, 1);
                        v_texCoord = a_texCoord;
                    }`:e=`attribute vec2 a_position;
                    attribute vec2 a_texCoord;
                    uniform mat3 displayTransform;
                    varying vec2 v_texCoord;
                    void main() {
                        gl_Position = vec4(a_position, 0, 1);
                        v_texCoord = a_texCoord;
                    }`;const i=`precision highp float;
                    uniform sampler2D y_texture;
                    uniform sampler2D uv_texture;
                    varying vec2 v_texCoord;
                    void main() {
                        vec4 y_color = texture2D(y_texture, v_texCoord);
                        vec4 uv_color = texture2D(uv_texture, v_texCoord);

                        float Y, U, V;
                        float R ,G, B;
                        Y = y_color.r;
                        U = uv_color.r - 0.5;
                        V = uv_color.a - 0.5;

                        R = Y + 1.402 * V;
                        G = Y - 0.344 * U - 0.714 * V;
                        B = Y + 1.772 * U;

                        gl_FragColor = vec4(R, G, B, 1.0);
                    }`,s=t.createShader(t.VERTEX_SHADER);t.shaderSource(s,e),t.compileShader(s);const a=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(a,i),t.compileShader(a),this._glProgram=t.createProgram(),t.attachShader(this._glProgram,s),t.attachShader(this._glProgram,a),t.deleteShader(s),t.deleteShader(a),t.linkProgram(this._glProgram),t.useProgram(this._glProgram);const n=t.getUniformLocation(this._glProgram,"y_texture");t.uniform1i(n,0);const o=t.getUniformLocation(this._glProgram,"uv_texture");t.uniform1i(o,1),this._legacyFlag&&(this._dt=t.getUniformLocation(this._glProgram,"displayTransform")),this._ext=t.getExtension("OES_vertex_array_object"),this._vao=this._ext.createVertexArrayOES(),this._ext.bindVertexArrayOES(this._vao);const l=t.getAttribLocation(this._glProgram,"a_position"),h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),t.STATIC_DRAW),t.vertexAttribPointer(l,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(l),this._vao.posBuffer=h;const c=t.getAttribLocation(this._glProgram,"a_texCoord"),m=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,m),this._legacyFlag?t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,1,1,1,0,0,1,0]),t.STATIC_DRAW):t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c),this._vao.texcoordBuffer=m,this._yTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._yTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this._uvTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._uvTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}_createCanvas(t,e,i){i?(!zt||t!=zt.height||e!=zt.width)&&(zt=wx.createOffscreenCanvas({width:e,height:t,type:"webgl"})):(!zt||t!=zt.width||e!=zt.height)&&(zt=wx.createOffscreenCanvas({width:t,height:e,type:"webgl"}))}async drawImageAsync(t,e,i,s){const a=this._glContext;return a.disable(a.DEPTH_TEST),a.disable(a.BLEND),a.useProgram(this._glProgram),this._ext.bindVertexArrayOES(this._vao),this._legacyFlag&&a.uniformMatrix3fv(this._dt,!1,this.displayTransform270),a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this._yTexture),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE,i,s,0,a.LUMINANCE,a.UNSIGNED_BYTE,t),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this._uvTexture),a.texImage2D(a.TEXTURE_2D,0,a.LUMINANCE_ALPHA,i/2,s/2,0,a.LUMINANCE_ALPHA,a.UNSIGNED_BYTE,e),a.drawArrays(a.TRIANGLE_STRIP,0,4),a.flush(),new Promise(n=>{const o=this._glCanvas.toDataURL("image/jpeg",.7);n(o)})}}class Je extends Ri{constructor(t=!1){super(),this._externalControlFlag=t;const e=this._onAcceUpdate;this._handler=i=>{const s={x:-i.x*10,y:-i.y*10,z:i.z*10};e.fire(s),this._currentAcce=s}}start(){this._externalControlFlag||(wx.startAccelerometer({interval:"normal",fail:e=>{throw e}}),G.log("Wechat accelerometer started by easyar"));const t=this._handler;wx.onAccelerometerChange(t)}stop(){this._externalControlFlag||(wx.stopAccelerometer(),G.log("Wechat accelerometer stopped by easyar"));const t=this._handler;wx.offAccelerometerChange(t),this._currentAcce=null}dispose(){this.stop(),this._onAcceUpdate.dispose()}}var zi=(r=>(r[r.Android7x=0]="Android7x",r[r.Android=1]="Android",r[r.IOS=2]="IOS",r[r.Other=3]="Other",r[r.Unknown=4]="Unknown",r))(zi||{});const Ps=Math.PI/180;class zs extends Mi{constructor(t=!1){super(),this._tag=4,this._externalControlFlag=t;const e=this._onAttituteUpdate;this._tag=this._getWxVersionTagForAttitute();const i=this._tag;G.log("Wx platform tag: "+zi[i]),this._handler=s=>{const a=Bi(s,i),n={x:a.x,y:a.y,z:a.z,w:a.w,systemTimestamp:new Date().getTime()};e.fire(n)}}start(){if(this._tag==4)throw new Error("Wechat device motion Invalid on unspported device");if(this._tag==3)throw new Error("Wechat device motion invalid on current platform: "+wx.getSystemInfoSync().platform);this._externalControlFlag||wx.startDeviceMotionListening({interval:"game",fail:e=>{throw e}});const t=this._handler;wx.onDeviceMotionChange(t)}stop(){this._externalControlFlag||wx.stopDeviceMotionListening();const t=this._handler;wx.offDeviceMotionChange(t)}dispose(){this.stop(),this._onAttituteUpdate.dispose()}_getWxVersionTagForAttitute(){let t=wx.getSystemInfoSync();return!t||!t.platform?4:t.platform=="ios"?2:t.platform=="android"?t.version.startsWith("7.")?0:1:3}}function Bi(r,t){let e=null;if(t==0)e={alpha:-r.alpha,beta:-r.beta,gamma:-r.gamma};else if(t==1)e={alpha:-r.alpha,beta:-r.beta,gamma:r.gamma};else if(t==2)e={alpha:r.alpha,beta:r.beta,gamma:-r.gamma};else throw new Error("Device motion invalid on current platform: "+wx.getSystemInfoSync().platform);let[i,s,a]=[e.beta,e.alpha,e.gamma].map(f=>Ps*f),[n,o,l]=[i,s,a].map(f=>Math.cos(f/2)),[h,c,m]=[i,s,a].map(f=>Math.sin(f/2)),d=new pt;d.x=h*o*l+n*c*m,d.y=n*c*l-h*o*m,d.z=n*o*m-h*c*l,d.w=n*o*l+h*c*m;let g=new pt;return g.x=-Math.SQRT1_2,g.w=Math.SQRT1_2,d=d.multiply(g),d}class Xe extends Di{constructor(t=!1){super(),this._externalControlFlag=t;const e=this._onGpsUpdate;this._handler=i=>{const s={latitude:i.latitude,longitude:i.longitude,altitude:i.altitude,horizontalAccuracy:i.horizontalAccuracy,verticalAccuracy:i.verticalAccuracy};e.fire(s),this._currentGeoLocation=s}}start(){this._externalControlFlag||(wx.startLocationUpdate({type:"wgs84",success:()=>{},fail:e=>{throw e}}),G.log("Wechat geo location update started by easyar"));const t=this._handler;wx.onLocationChange(t)}stop(){this._externalControlFlag||(wx.stopLocationUpdate(),G.log("Wechat geo location update stopped by easyar"));const t=this._handler;wx.offLocationChange(t),this._currentGeoLocation=null}dispose(){this.stop(),this._onGpsUpdate.dispose()}}class Bs extends Ii{constructor(t,e=0,i=null){super(t);let s=(e&Ht.Accelerometer)!==0,a=(e&Ht.GeoLocation)!==0;this._accelerometer=new Je(s),this._geoLocationProvider=new Xe(a),this._proximityLocationProvider=i,G.log("Wechat block tracker created, external sensor control flag is: ",e)}}class Us extends Ti{constructor(t,e=0,i=null){super(t);let s=(e&Ht.Accelerometer)!==0,a=(e&Ht.GeoLocation)!==0;this._accelerometer=new Je(s),this._geoLocationProvider=new Xe(a),this._proximityLocationProvider=i,this._onRequireImage=new lt,G.log("Wechat landmark tracker created, external sensor control flag is: ",e)}}const Qe=Object.freeze(Object.defineProperty({__proto__:null,CanvasHandler:Ls,WxAccelerometer:Je,WxAttituteProvider:zs,convertWxDeviceMotionToAttitute:Bi,WxGeoLocationProvider:Xe,wxRequest:Ae,WxBlockTracker:Bs,WxLandmarkTracker:Us},Symbol.toStringTag,{value:"Module"})),Os={position:et.zero,rotation:pt.identity,scale:et.one},Ns=Object.freeze(Object.defineProperty({__proto__:null,TransformIdentity:Os},Symbol.toStringTag,{value:"Module"}));class Ui{constructor(t,e,i,s){if(this._major=0,this._minor=0,this._build=null,this._revision=null,typeof t=="string"){let a=t.split(".");if(a.length>=1&&a[0].length>0){let n=Number.parseInt(a[0]);this._major=isNaN(n)?0:n}if(a.length>=2&&a[1].length>0){let n=Number.parseInt(a[1]);this._minor=isNaN(n)?0:n}if(a.length>=3&&a[2].length>0){let n=Number.parseInt(a[2]);this._build=isNaN(n)?null:n}if(a.length>=4&&a[3].length>0){let n=Number.parseInt(a[3]);this._revision=isNaN(n)?null:n}}else typeof t=="number"&&(this._major=t|0,this._minor=e|0,this._build=i,this._revision=s)}get major(){return this._major}get minor(){return this._minor}get build(){return this._build}get revision(){return this._revision}toString(){return`${this.major}.${this.minor}`+(this.build!=null?`.${this.build}`:"")+(this.revision!=null?`.${this.revision}`:"")}}var Oi=(r=>(r.Block="block",r.World="world",r))(Oi||{});class Jt{static fromAnnotationJson(t){const e=new Jt;return e.id=t.id,e.type=t.type,e.timestamp=t.timestamp,t.featureTye&&(e.featureTye=t.featureTye),t.properties&&(e.properties=t.properties),e}get name(){return this.getProperty("name")}set name(t){this.setProperty("name",t)}set properties(t){this._properties=t}getProperty(t){if(!this._properties)return;const e=this._properties[t];if(e)return e}setProperty(t,e){if(e===void 0){if(!this._properties)return;this._properties[t]=void 0,Object.keys(this._properties).length==0&&(this._properties=void 0)}else this._properties||(this._properties={}),this._properties[t]=e}}class Ni extends Jt{static fromNodeJson(t){const e=Jt.fromAnnotationJson(t);if(e.geometry=t.geometry,e.parent=t.parent,e.geometry=="point")e.transform={position:t.transform.position,rotation:pt.identity,scale:et.one};else if(e.geometry=="cube")e.transform={position:t.transform.position,rotation:t.transform.rotation,scale:t.transform.scale};else throw new Error("Unknown annotation geometry: "+e.geometry);return e}}class qi extends Jt{get isDirected(){const t=this.getProperty("isDirected");return t===void 0?!0:t}set isDirected(t){this.setProperty("isDirected",t)}get category(){return this.getProperty("category")}set category(t){this.setProperty("category",t)}static fromRelationshipJson(t){const e=Jt.fromAnnotationJson(t);return e.members=t.members,e}}class be{get version(){return this._version}constructor(){this._version=new Ui(0,5,0)}static fromJson(t){if(t.version.major!=0||t.version.minor!=5)throw new Error("Trying to construct Ema v0.5 with data v"+t.version);let e=new be;e.generatedBy=t.generatedBy,t.extensions&&(e.extensions=t.extensions),e.blocks=t.blocks;let i=new Array;if(!t.annotations)return e.annotations=t.annotations,e;for(const s of t.annotations)if(s.type=="node"){const a=Ni.fromNodeJson(s);i.push(a)}else if(s.type=="relationship"){const a=qi.fromRelationshipJson(s);i.push(a)}return e.annotations=i,e}}function qs(r,t){if(!r||!t)throw new Error("Cannot compare undefined parent of ema");if(!r.type||!t.type)throw new Error("Cannot compare ema parent with Unknown type");if(r.type==="block")return r.id==t.id;if(r.type==="world"){const e=r,i=t;return!e.location.latitude||!i.location.latitude||!e.location.longitude||!i.location.longitude?!1:e.location.latitude==i.location.latitude&&e.location.longitude==i.location.longitude&&e.location.altitude==i.location.altitude}else throw new Error("Unknown parent type: "+r.type)}function Hs(r){try{if(!r.version)throw new Error("Fail to decode EMA without version info");const t=new Ui(r.version);if(r.version=t,t.major==0&&t.minor==5)return be.fromJson(r);throw new Error("Unsupported Ema version: "+t.toString())}catch(t){throw new Error(t)}}const Vs=Object.freeze(Object.defineProperty({__proto__:null,checkVersion:Hs,ParentType:Oi,Annotation:Jt,Node:Ni,Relationship:qi,Ema_05:be,isEquivalent:qs},Symbol.toStringTag,{value:"Module"}));console.log("use easyar-core v2.0.12");const $s=Object.freeze(Object.defineProperty({__proto__:null,ARAssembly:Pi,Accelerometer:Ri,AttituteProvider:Mi,BlockLocalizationResponse:bi,BlockLocalizerResult:_i,BlockServiceHandler:Se,BlockTracker:Ii,BlockTrackerResult:We,CameraParameters:ft,CameraTransformType:Y,CloudLocalizerBlockInstance:Nt,CloudLocalizerStatus:rt,CoreVersion:oe,Debug:G,ExternalControlSensor:Ht,FrameData:Vt,FrameSource:ke,GeoLocationProvider:Di,LandmarkLocalizationResponse:Fi,LandmarkLocalizerResult:Ei,LandmarkServiceHandler:Si,LandmarkTracker:Ti,LandmarkTrackerResult:Ke,Mat4:K,Mathf:mi,MotionTrackingStatus:Gt,Platform:At,PoseFusion:Ce,PoseFusionLegacy:Ci,PoseHolder:je,ProximityLocationProvider:Li,Quat:pt,Recorder:j,ServiceHandler:$e,ThreeDofHelper:Ds,TimeMatrix4d:Ye,Tracker:Ge,Vec3:et,VersionTag:ue,ema:Vs,event:Dt,getPoseFusion:wi,jsSHA:qe,text:le,tf:Ns,util:Ve,wx:Qe},Symbol.toStringTag,{value:"Module"})),Hi={PACM00:"PACT00"},Vi=class{constructor(){this._systemInfo=null,this._isAliPay=null,this._isWeChat=null,this._isBrowser=null,this._calibData=null,this._isWeChat=typeof wx<"u"&&!wx.isMy,this._isAliPay=typeof my<"u",this._isBrowser=typeof document<"u",this._updateSystemInfo()}static get instance(){return this._instance==null&&(this._instance=new Vi),this._instance}_updateSystemInfo(){if(this._isWeChat){let r=wx.getSystemInfoSync();this._systemInfo=r}else if(this._isAliPay){let r=my.getSystemInfoSync();this._systemInfo=r}else typeof document<"u"&&(this._systemInfo=null)}get isAliPay(){return this._isAliPay}get isWeChat(){return this._isWeChat}get isBrowser(){return this._isBrowser}get isIos(){if(this._isWeChat)return this._systemInfo.platform=="ios";if(this._isAliPay)return this._systemInfo.platform=="iOS"||this._systemInfo.platform=="iPhone OS";if(this._isBrowser)return navigator.userAgent.indexOf("iPhone")>-1}get isAndroid(){if(this._isWeChat)return this._systemInfo.platform=="android";if(this._isAliPay)return this._systemInfo.platform=="Android";if(this._isBrowser)return navigator.userAgent.indexOf("Android")>-1}get windowWidth(){return this._systemInfo.windowWidth}get windowHeight(){return this._systemInfo.windowHeight}get pixelRatio(){return this._systemInfo.pixelRatio}get version(){return this._systemInfo.version}loadPlugin(r){if(this._isAliPay)return my.loadPlugin(r);if(this._isWeChat)return I.warn("\u5FAE\u4FE1\u5E73\u53F0\u4E0D\u652F\u6301 loadPlugin \u64CD\u4F5C"),null}get sdkVersion(){if(this._isAliPay)return this._systemInfo.SDKVersion;if(this._isWeChat)return this._systemInfo.SDKVersion}isSDKVersionNotLess(r){let e=this.sdkVersion.split("."),i=r.split(".");for(let s=0;s<i.length;s++){let a=parseInt(e[s]),n=parseInt(i[s]);if(a>n)return!0;if(a<n)return!1}return!0}get deviceModel(){return Hi[this._systemInfo.model]?Hi[this._systemInfo.model]:this._systemInfo.model}get benchmarkLevel(){if(!this._isAliPay){if(this._isWeChat)return this._systemInfo.benchmarkLevel}}get system(){return this._systemInfo.system}get isSystemNotLessAndriod9(){return this.system.toLowerCase().indexOf("android")>-1&&Number(this.system.split(" ")[1].split(".")[0])>=9}async getCalibData(){if(this._calibData)return this._calibData;try{let t=(await Ve.fetchCalibIntrinsics(At.Wechat)).devices.find(e=>e.model.toUpperCase()==this.deviceModel.toUpperCase());if(t){let e={width:t.w,height:t.h,fx:t.f_x,fy:t.f_y,cx:t.c_x,cy:t.c_y};return this._calibData=e,Promise.resolve(e)}else return Promise.reject()}catch{return Promise.reject()}}};let tt=Vi;tt._instance=null;class te{constructor(t,e){this._worldMatrix=null,this._projectMatrix=null,this._textureProject=null,this._initialized=!1,this._startCallBack=null,this.pc=t,this.app=e,this._worldMatrix=new t.Mat4,this._projectMatrix=new t.Mat4,this._textureProject=new t.Mat4,this._viewWidth=e.graphicsDevice.canvas.width,this._viewHeight=e.graphicsDevice.canvas.height,this._near=.1,this._far=1e3}static canIUse(t=P.Dof6){console.warn("\u8BE5\u63A5\u53E3\u5DF2\u542F\u7528\uFF0C\u8BF7\u4F7F\u7528 queryARSupport \u4EE3\u66FF\uFF0C\u5E76\u4F9D\u636E\u8FD4\u56DE\u503C\u8FDB\u884C\u5224\u5B9A");let e=null;switch(t){case P.Camera:e=Mt.CAMERA;break;case P.Dof3:e=Mt.WorldTracking;break;case P.Dof6:e=Mt.WorldTracking;break;default:return Promise.resolve(!1)}return ARSession&&ARSession.isSupported({mode:e})?Promise.resolve(!0):Promise.resolve(!1)}static async queryARSupport(){return this.supportTrackMode=P.Dof6,Promise.resolve({arBaseMode:Q.ARSession,arTrackMode:P.Dof6})}create(t,e,i){const s=()=>{switch(this.trackMode=t.trackMode,this.trackMode){case P.Dof6:this._curTrackMode=Mt.WorldTracking;break;case P.Dof3:this._curTrackMode=Mt.WorldTracking;break;case P.Camera:this._curTrackMode=Mt.CAMERA;break}const a=this._curTrackMode;ARSession&&ARSession.isSupported({mode:a})?ARSession.createSession({mode:a,success:n=>{this.curARSession=n,e&&e()},fail:()=>{i&&i()}}):(I.error("\u4E0D\u652F\u6301:"+a),i&&i())};this._initialized?s():(tt.instance.isIos||tt.instance.loadPlugin("ARSession"),ARSession?(this._initialized=!0,s()):(I.error("\u652F\u4ED8\u5B9D\u7248\u672C\u6709\u8BEF,\u672A\u5305\u542BARSession !"),i&&i()))}update(){const t=this._curARFrame;if(t){switch(this.updateTexture(),this.trackMode){case P.Dof3:case P.Dof6:this.updatePosition(),ot.instance.clsClient&&ot.instance.clsClient.updateFrame(t);break}this.disposeFrame()}}start(t,e,i){let s=!1;if(this.curARSession){const a={vw:this._viewWidth,vh:this._viewHeight,needImuFilter:!0};switch(this._curTrackMode){case Mt.WorldTracking:s=this.curARSession.start(JSON.stringify(a));break;case Mt.OrientationTracking:s=this.curARSession.start(JSON.stringify(a));break;case Mt.CAMERA:s=this.curARSession.start(JSON.stringify(a));break}}else I.error("start\u5931\u8D25,\u8BF7\u68C0\u67E5\u662F\u5426\u521B\u5EFA\u5B9E\u4F8B");this._startCallBack=i,s?(this.app.xr.session||(I.info("\u5173\u95ED App3d \u81EA\u52A8\u5237\u65B0"),this.app.xr={session:{requestAnimationFrame:()=>{}},end:()=>{},destroy:()=>{}}),this.curARSession.onARFrame(a=>{this._curARFrame=a,this.app.tick()}),t&&t()):e&&e()}destroy(){ARSession.removeSession(),this.curARSession=null,this._bgMaterial&&(this._bgMaterial.destroy(),this._bgMaterial=null)}resume(){}pause(){}onShow(){}onHide(){}updatePosition(){const{_curARFrame:t}=this,{camera:e}=t;switch(e.transform[12]/=100,e.transform[13]/=100,e.transform[14]/=100,this.trackMode){case P.Dof6:e.trackingState==="normal"&&(this._worldMatrix.set(e.transform),this._projectMatrix.set(e.projection).transpose(),this._startCallBack&&(this._startCallBack(),this._startCallBack=null));break;case P.Dof3:if(e.trackingState==="normal"){const a=this._worldMatrix;a.set(e.transform),a.data[12]=a.data[13]=a.data[14]=0,this._projectMatrix.set(e.projection).transpose(),this._startCallBack&&(this._startCallBack(),this._startCallBack=null)}break}const{_near:i,_far:s}=this;this._projectMatrix.data[10]=(i+s)/(i-s),this._projectMatrix.data[14]=2*i*s/(i-s)}updateTexture(){const{capturedImage:t,width:e,height:i,capturedImageMatrix:s}=this._curARFrame;if(e*i>0&&t&&s){if(!this._textureY){this._textureY=new this.pc.Texture(this.app.graphicsDevice,{width:e,height:i,format:this.pc.PIXELFORMAT_A8,mipmaps:!1,addressU:this.pc.ADDRESS_CLAMP_TO_EDGE,addressV:this.pc.ADDRESS_CLAMP_TO_EDGE}),this._bgMaterial&&(this._bgMaterial.setParameter("u_frameY",this._textureY),this._bgMaterial.update()),this._textureUV=new this.pc.Texture(this.app.graphicsDevice,{width:e/2,height:i/2,format:this.pc.PIXELFORMAT_L8_A8,mipmaps:!1,addressU:this.pc.ADDRESS_CLAMP_TO_EDGE,addressV:this.pc.ADDRESS_CLAMP_TO_EDGE}),this._bgMaterial&&(this._bgMaterial.setParameter("u_frameUV",this._textureUV),this._bgMaterial.update()),this._scaleMatrix=new this.pc.Mat4;const l=this._viewWidth,h=this._viewHeight,c=i,m=e,d=l/h,g=c/m,f=d/g;f>1?(this._scaleMatrix.data[0]=1,this._scaleMatrix.data[5]=f):(this._scaleMatrix.data[0]=1/f,this._scaleMatrix.data[5]=1),this._bgMaterial&&(this._bgMaterial.setParameter("u_scaleMatrix",this._scaleMatrix.data),this._bgMaterial.update())}this._textureProject.set(s),this._bgMaterial&&(this._bgMaterial.setParameter("u_proMatrix",this._textureProject.data),this._bgMaterial.update());const a=t.byteLength,n=e*i;let o=this._textureY.lock();o.set(new Uint8Array(t,0,n)),this._textureY.unlock(),o=this._textureUV.lock(),o.set(new Uint8Array(t,n,a-n)),this._textureUV.unlock()}}getBackgroundMaterial(){if(this._bgMaterial)return this._bgMaterial;{const e=this.app.graphicsDevice,i=["attribute vec3 POSITION;","uniform mat4 u_proMatrix;","uniform mat4 u_scaleMatrix;","varying vec2 v_uv;","void main() {","v_uv = (u_proMatrix * vec4(POSITION.x * 0.5 + 0.5, POSITION.y * 0.5 + 0.5, 1.0, 1.0)).xy;","gl_Position = u_scaleMatrix * vec4( POSITION.xy, 1.0, 1.0);","gl_Position.z = gl_Position.w;","}"].join(`
`),s=[`precision ${e.precision} float;`,"uniform sampler2D u_frameY;","uniform sampler2D u_frameUV;","varying vec2 v_uv;","","void main() {","  vec2 cbcr = texture2D(u_frameUV, v_uv).ra - vec2(0.5, 0.5);","  vec3 ycbcr = vec3(texture2D(u_frameY, v_uv).a, cbcr);","  vec3 rgb = mat3(1.0, 1.0, 1.0,0.0, -0.344136, 1.772,1.402, -0.714136, 0.0) * ycbcr;","","  gl_FragColor = vec4(rgb, 1.0);","}"].join(`
`);return this._bgShader=new this.pc.Shader(e,{attributes:{POSITION:this.pc.SEMANTIC_POSITION},vshader:i,fshader:s}),this._bgMaterial=new this.pc.Material,this._bgMaterial.shader=this._bgShader,this._bgMaterial.depthTest=!1,this._bgMaterial.depthWrite=!1,this._bgMaterial.update(),this._bgMaterial}}disposeFrame(){this._curARFrame=null}}te.supportTrackMode=null,te.arBaseMode=Q.ARSession;var fe=(r=>(r.motionTrack="motionTrack",r.localizer="localizer",r.rtct="rtct",r.megaTrack="megaTrack",r))(fe||{}),Ze=(r=>(r.VIO="VIO",r.SLAM="SLAM",r.ANCHOR="ANCHOR",r.LARGE_SCALE="LARGE_SCALE",r))(Ze||{}),xt=(r=>(r[r.notInit=0]="notInit",r[r.enable=1]="enable",r[r.disable=2]="disable",r))(xt||{});const ct=class{constructor(r,t){this._worldMatrix=null,this._projectMatrix=null,this._textureProject=null,this.pc=r,this.app=t,this._worldMatrix=new r.Mat4,this._projectMatrix=new r.Mat4,this._textureProject=new r.Mat4,this._viewWidth=t.graphicsDevice.canvas.width,this._viewHeight=t.graphicsDevice.canvas.height,this._near=.1,this._far=1e3,this._rotationMatrix=new r.Mat4().set([0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1])}static canIUse(r=P.Dof6){console.warn("\u8BE5\u63A5\u53E3\u5DF2\u542F\u7528\uFF0C\u8BF7\u4F7F\u7528 queryARSupport \u4EE3\u66FF\uFF0C\u5E76\u4F9D\u636E\u8FD4\u56DE\u503C\u8FDB\u884C\u5224\u5B9A");let t=fe.megaTrack;return new Promise((e,i)=>{tt.instance.loadPlugin("ExpAR"),ExpARLoader?ExpARLoader.load({success:()=>{ExpAREngine.init({success:()=>{switch(ct.arSupportMap[t]){case xt.enable:e(!0);break;case xt.disable:e(!1);break;default:ExpAREngine.isSupported({mode:t,complete:a=>{if(a.isSupported)ct.arSupportMap[t]=xt.enable,e(!0);else try{ExpAREngine.downloadCalibration({complete:function(n){n.status==0?(this.arSupportMap[t]=xt.enable,e(!0)):(this.arSupportMap[t]=xt.disable,e(!1))}})}catch(n){i(n)}}});break}ct.initialized=!0},fail:()=>{e(!1)}})},fail:()=>{e(!1)}}):(I.info("[MY] onReady: expARLoader not defined"),e(!1))})}static async initializExpAREngine(){return new Promise((r,t)=>{if(I.log("\u5F00\u59CB\u52A0\u8F7D ExpARLoader"),ExpARLoader)r(null);else{if(tt.instance.loadPlugin("ExpAR"),!ExpARLoader){I.error("No ExpARLoader"),t("No ExpARLoader");return}r(null)}}).then(()=>(I.log("\u52A0\u8F7D ExpARLoader \u6210\u529F\uFF0C\u5F00\u59CBload ExpAREngine"),this._ExpARLoaderPromise?this._ExpARLoaderPromise:(this._ExpARLoaderPromise=new Promise((r,t)=>{ExpARLoader.load({success:()=>{r(null)},fail:()=>{I.error("ExpEngine load error"),t("ExpEngine load error")}})}),this._ExpARLoaderPromise))).then(()=>(I.log("\u52A0\u8F7D ExpAREngine \u6210\u529F\uFF0C\u5F00\u59CB\u521D\u59CB\u5316 ExpAREngine"),this._ExpAREngineInitPromise?this._ExpAREngineInitPromise:(this._ExpAREngineInitPromise=new Promise((r,t)=>{ExpAREngine.init({success:()=>{this.initialized=!0,r(null),I.log("Enging \u521D\u59CB\u5316\u6210\u529F")},fail:()=>{I.error("ExpAREngine init error"),t("ExpAREngine init error")}})}),this._ExpAREngineInitPromise)))}static async queryARSupport(){return this.initialized||await this.initializExpAREngine(),this._DownloadCalibrationPromise||(this._DownloadCalibrationPromise=new Promise((r,t)=>{ExpAREngine.downloadCalibration({complete:e=>{I.log("\u66F4\u65B0\u6807\u5B9A\u6570\u636E:",e.status),r(null)}})})),this._DownloadAREngineDeviceListPromise||(this._DownloadAREngineDeviceListPromise=new Promise(r=>{ExpAREngine.downloadAREngineDeviceList({complete:t=>{I.log("\u66F4\u65B0 AREngine \u673A\u578B\u9ED1\u540D\u5355\uFF1A",t.status),r(null)}})})),await Promise.all([this._DownloadAREngineDeviceListPromise,this._DownloadCalibrationPromise]),new Promise((r,t)=>{ExpAREngine.querySupport({complete:e=>{switch(e.support){case"6dof":ct.supportTrackMode=P.Dof6;break;case"3dof":ct.supportTrackMode=P.Dof3;break;case"0dof":ct.supportTrackMode=P.Camera;break}r({arBaseMode:Q.EasyAR,arTrackMode:ct.supportTrackMode})}})})}async create(r,t,e){this._config=r;const i=async()=>{this.trackMode=r.trackMode;let s=fe.megaTrack;Ze.LARGE_SCALE,ct.supportTrackMode==null&&(await ct.queryARSupport(),this.trackMode=ct.supportTrackMode,I.info("\u652F\u6301 AR \u529F\u80FD\u6A21\u5F0F\uFF1A"+s+" + "+P[ct.supportTrackMode]));const a={mode:fe.megaTrack,trackingMode:Ze.LARGE_SCALE,viewWidth:this._viewWidth,viewHeight:this._viewHeight,nearPlane:this._near,farPlane:this._far,deviceRotation:0};s==fe.megaTrack&&(a.apiKey=r.clsConfig.apiKey,a.apiSecret=r.clsConfig.apiSecret,a.appId=r.clsConfig.clsAppId,a.preferArEngine=!0),this.curARSession&&ExpAREngine.destroyInstance(this.curARSession);try{this.curARSession=ExpAREngine.createInstance(a),t&&t()}catch{e&&e()}};ct.initialized?i():ct.initializExpAREngine().then(()=>{i()}).catch(()=>{e&&e()})}start(r,t){try{this.curARSession&&this.curARSession.start(),r&&r()}catch{t&&t()}}update(){if(this.curARSession){const r=this._curARFrame=this.curARSession.peekFrame();r&&(this.updateTexture(),this.updatePosition(),ot.instance.clsClient&&ot.instance.clsClient.updateFrame(r),this.disposeFrame())}}destroy(){this._curARFrame&&(this.curARSession.disposeFrame(this._curARFrame),this._curARFrame=null),this.curARSession&&(ExpAREngine.destroyInstance(this.curARSession),this.curARSession=null),this._bgMaterial&&(this._bgMaterial.destroy(),this._bgMaterial=null)}_canIUse(r,t,e){switch(ct.arSupportMap[r]){case xt.enable:t();break;case xt.disable:e&&e();break;default:ExpAREngine.isSupported({mode:r,complete:s=>{if(s.isSupported)ct.arSupportMap[r]=xt.enable,t();else try{ExpAREngine.downloadCalibration({complete:function(a){a.status==0?(this.arSupportMap[r]=xt.enable,t()):(this.arSupportMap[r]=xt.disable,e&&e())}})}catch{e&&e()}}});break}}pause(){this.initialized&&ExpAREngine.pause()}resume(){this.initialized&&ExpAREngine.resume()}onShow(){this.resume()}onHide(){this.pause()}updatePosition(){const{camera:r,timestamp:t,results:e}=this._curARFrame;r.trackingStatus!=-1&&(this._worldMatrix.set(r.transform),this._worldMatrix.mul2(this._rotationMatrix,this._worldMatrix),this._worldMatrix.transpose(),this._projectMatrix.set(r.projection),this._projectMatrix.mul2(this._rotationMatrix,this._projectMatrix),this._projectMatrix.transpose())}updateTexture(){const{image:r}=this._curARFrame;if(r){const{pixelWidth:t,pixelHeight:e,rawData:i}=r;this._textureY||(this._textureY=new this.pc.Texture(this.app.graphicsDevice,{width:t,height:e,format:this.pc.PIXELFORMAT_A8,mipmaps:!1,addressU:this.pc.ADDRESS_CLAMP_TO_EDGE,addressV:this.pc.ADDRESS_CLAMP_TO_EDGE}),this._bgMaterial&&(this._bgMaterial.setParameter("u_frameY",this._textureY),this._bgMaterial.update()),this._textureUV=new this.pc.Texture(this.app.graphicsDevice,{width:t/2,height:e/2,format:this.pc.PIXELFORMAT_L8_A8,mipmaps:!1,addressU:this.pc.ADDRESS_CLAMP_TO_EDGE,addressV:this.pc.ADDRESS_CLAMP_TO_EDGE}),this._bgMaterial&&(this._bgMaterial.setParameter("u_frameUV",this._textureUV),this._bgMaterial.update())),this._textureProject.set(r.imageProjection).transpose(),this._bgMaterial&&(this._bgMaterial.setParameter("u_proMatrix",this._textureProject.data),this._bgMaterial.update());const s=i.byteLength,a=t*e;let n=this._textureY.lock();n.set(new Uint8Array(i,0,a)),this._textureY.unlock(),n=this._textureUV.lock(),n.set(new Uint8Array(i,a,s-a)),this._textureUV.unlock()}}getBackgroundMaterial(){if(this._bgMaterial)return this._bgMaterial;{const t=this.app.graphicsDevice,e=["attribute vec3 POSITION;","","uniform mat4 u_proMatrix;","varying vec2 v_uv;","","void main() {","  v_uv = POSITION.xy * 0.5 + 0.5;","  v_uv.y = 1.0 - v_uv.y;","  vec4 position =  u_proMatrix * vec4(POSITION.xy, 1.0, 1.0);","  position.z = position.w;","  gl_Position = position;","}"].join(`
`),i=[`precision ${t.precision} float;`,"uniform sampler2D u_frameY;","uniform sampler2D u_frameUV;","varying vec2 v_uv;","","void main() {","  vec2 cbcr = texture2D(u_frameUV, v_uv).ar - vec2(0.5, 0.5);","  vec3 ycbcr = vec3(texture2D(u_frameY, v_uv).a, cbcr);","  vec3 rgb = mat3(1, 1, 1, 0, -0.344, 1.772, 1.402, -0.714, 0) * ycbcr;","  gl_FragColor = vec4(rgb, 1.0);","}"].join(`
`);return this._bgShader=new this.pc.Shader(t,{attributes:{POSITION:this.pc.SEMANTIC_POSITION},vshader:e,fshader:i}),this._bgMaterial=new this.pc.Material,this._bgMaterial.shader=this._bgShader,this._bgMaterial.depthTest=!1,this._bgMaterial.depthWrite=!1,this._bgMaterial.update(),this._bgMaterial}}setClsConfig(r){this._config.clsConfig=r,this.start()}disposeFrame(){this._curARFrame&&this.curARSession.disposeFrame(this._curARFrame),this._curARFrame=null}};let _t=ct;_t.initialized=!1,_t.supportTrackMode=null,_t.arBaseMode=Q.EasyAR,_t.arSupportMap={},_t._ExpARLoaderPromise=null,_t._ExpAREngineInitPromise=null,_t._DownloadCalibrationPromise=null,_t._DownloadAREngineDeviceListPromise=null;function Gs(){Se.prototype.requestService=async function(r,t){if(!t)return new Error("No frame datas at cls request");if(t.length<2)return new Error("No enough frame datas at cls request");if((!t[0].imageString||t[0].imageString.length==0)&&(!t[0].imageBuffer||t[0].imageBuffer.byteLength==0))return new Error("Pre frame lacks image at cls request");if((!t[1].imageString||t[1].imageString.length==0)&&(!t[1].imageBuffer||t[1].imageBuffer.byteLength==0))return new Error("Pre frame lacks image at cls request");this._isTokenExpired()&&await this.refreshToken();let e=null,i=null;e=t[0].imageBuffer,G.log("Block cls with two images. The first image is from buffer"),i=t[1].imageBuffer,G.log("Block cls with two images. The second image is from buffer"),r.apiSecret=ot.instance.clsClient.config.apiSecret;const s=ot.instance.arCtrl._curARFrame,a=s.camera.intrinsics,n=a[0],o=a[4],l=a[6],h=a[7];return r.cameraParam=[n,o,l,h],delete r.startTime,new Promise((c,m)=>{ExpAREngine.localize({url:this._fullPath,image:i,preImage:e,params:JSON.stringify(r),width:s.width,height:s.height,complete:d=>{const g=JSON.parse(d),f=JSON.parse(g.data);g.data=f,g.status==200?c(f):m(f)}})})},Se.prototype.requestServiceSingleImage=async function(r,t,e=!1){if(!t)return new Error("No image at cls request with single image");this._isTokenExpired()&&await this.refreshToken();let i=null;if(t.byteLength==0)return new Error("Empty image buffer at cls request with single image buffer");G.log("Block cls with single image from buffer"),i=t,r.apiSecret=ot.instance.clsClient.config.apiSecret;const s=ot.instance.arCtrl._curARFrame,a=s.camera.intrinsics,n=a[0],o=a[4],l=a[6],h=a[7];return r.cameraParam=[n,o,l,h],delete r.startTime,new Promise((c,m)=>{ExpAREngine.localize({url:this._fullPath,params:JSON.stringify(r),image:i,width:s.width,height:s.height,complete:d=>{const g=JSON.parse(d),f=JSON.parse(g.data);g.data=f,g.status==200?c(f):m(f)}})})}}class Bt{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}set(t,e,i){this.x=t,this.y=e,this.z=i}clone(){return new Bt(this.x,this.y,this.z)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}getLength(){let t=this.x*this.x+this.y*this.y+this.z*this.z;return Math.sqrt(t)}getLengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}normalize(){let t=this.x*this.x+this.y*this.x+this.z*this.z;if(t>0){var e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}distance(t){return this.clone().sub(t).getLength()}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}getAngle(t){let i=this.dot(t)/(this.getLength()*t.getLength());return Math.acos(i)*180/Math.PI}}class ti{constructor(t,e,i,s){this.x=t||0,this.y=e||0,this.z=i||0,this.w=s||0}setFromMat4(t){let e=this,i,s,a,n,o,l,h,c,m,d,g,f,v,S,C;return i=t.data[0],s=t.data[4],a=t.data[8],n=t.data[1],o=t.data[5],l=t.data[9],h=t.data[2],c=t.data[6],m=t.data[10],v=i*i+s*s+a*a,v===0||(v=1/Math.sqrt(v),S=n*n+o*o+l*l,S===0)||(S=1/Math.sqrt(S),C=h*h+c*c+m*m,C===0)||(C=1/Math.sqrt(C),i*=v,s*=v,a*=v,n*=S,o*=S,l*=S,h*=C,c*=C,m*=C,d=i+o+m,d>=0?(g=Math.sqrt(d+1),e.w=g*.5,g=.5/g,e.x=(l-c)*g,e.y=(h-a)*g,e.z=(s-n)*g):i>o?i>m?(f=i-(o+m)+1,f=Math.sqrt(f),e.x=f*.5,f=.5/f,e.w=(l-c)*f,e.y=(s+n)*f,e.z=(a+h)*f):(f=m-(i+o)+1,f=Math.sqrt(f),e.z=f*.5,f=.5/f,e.w=(s-n)*f,e.x=(h+a)*f,e.y=(c+l)*f):o>m?(f=o-(m+i)+1,f=Math.sqrt(f),e.y=f*.5,f=.5/f,e.w=(h-a)*f,e.z=(l+c)*f,e.x=(n+s)*f):(f=m-(i+o)+1,f=Math.sqrt(f),e.z=f*.5,f=.5/f,e.w=(s-n)*f,e.x=(h+a)*f,e.y=(c+l)*f)),e}slerp(t,e,i){const s=t.x,a=t.y,n=t.z,o=t.w;let l=e.x,h=e.y,c=e.z,m=e.w,d=o*m+s*l+a*h+n*c;if(d<0&&(m=-m,l=-l,h=-h,c=-c,d=-d),Math.abs(d)>=1)return this.w=o,this.x=s,this.y=a,this.z=n,this;const g=Math.acos(d),f=Math.sqrt(1-d*d);if(Math.abs(f)<.001)return this.w=o*.5+m*.5,this.x=s*.5+l*.5,this.y=a*.5+h*.5,this.z=n*.5+c*.5,this;const v=Math.sin((1-i)*g)/f,S=Math.sin(i*g)/f;return this.w=o*v+m*S,this.x=s*v+l*S,this.y=a*v+h*S,this.z=n*v+c*S,this}mul(t){const e=this.x,i=this.y,s=this.z,a=this.w,n=t.x,o=t.y,l=t.z,h=t.w;return this.x=a*n+e*h+i*l-s*o,this.y=a*o+i*h+s*n-e*l,this.z=a*l+s*h+e*o-i*n,this.w=a*h-e*n-i*o-s*l,this}}class at{constructor(){let t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t}static fromArray(t){return new at().set(t)}set(t){for(let e=0;e<t.length;e++)this.data[e]=t[e];return this}clone(){let t=new at;return t.set(this.data),t}transpose(){let t=this.data,e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}getInverse(){let t=this.data,e=[],i=t[0],s=t[1],a=t[2],n=t[3],o=t[4],l=t[5],h=t[6],c=t[7],m=t[8],d=t[9],g=t[10],f=t[11],v=t[12],S=t[13],C=t[14],R=t[15],N=d*C*c-S*g*c+S*h*f-l*C*f-d*h*R+l*g*R,V=v*g*c-m*C*c-v*h*f+o*C*f+m*h*R-o*g*R,q=m*S*c-v*d*c+v*l*f-o*S*f-m*l*R+o*d*R,B=v*d*h-m*S*h-v*l*g+o*S*g+m*l*C-o*d*C,U=i*N+s*V+a*q+n*B;if(U===0)throw new Error("error!");let D=1/U;return e[0]=N*D,e[1]=(S*g*n-d*C*n-S*a*f+s*C*f+d*a*R-s*g*R)*D,e[2]=(l*C*n-S*h*n+S*a*c-s*C*c-l*a*R+s*h*R)*D,e[3]=(d*h*n-l*g*n-d*a*c+s*g*c+l*a*f-s*h*f)*D,e[4]=V*D,e[5]=(m*C*n-v*g*n+v*a*f-i*C*f-m*a*R+i*g*R)*D,e[6]=(v*h*n-o*C*n-v*a*c+i*C*c+o*a*R-i*h*R)*D,e[7]=(o*g*n-m*h*n+m*a*c-i*g*c-o*a*f+i*h*f)*D,e[8]=q*D,e[9]=(v*d*n-m*S*n-v*s*f+i*S*f+m*s*R-i*d*R)*D,e[10]=(o*S*n-v*l*n+v*s*c-i*S*c-o*s*R+i*l*R)*D,e[11]=(m*l*n-o*d*n-m*s*c+i*d*c+o*s*f-i*l*f)*D,e[12]=B*D,e[13]=(m*S*a-v*d*a+v*s*g-i*S*g-m*s*C+i*d*C)*D,e[14]=(v*l*a-o*S*a-v*s*h+i*S*h+o*s*C-i*l*C)*D,e[15]=(o*d*a-m*l*a+m*s*h-i*d*h-o*s*g+i*l*g)*D,this.data=new Float32Array(e),this}determinant(){const t=this.data,e=t[0],i=t[4],s=t[8],a=t[12],n=t[1],o=t[5],l=t[9],h=t[13],c=t[2],m=t[6],d=t[10],g=t[14],f=t[3],v=t[7],S=t[11],C=t[15];return f*(+a*l*m-s*h*m-a*o*d+i*h*d+s*o*g-i*l*g)+v*(+e*l*g-e*h*d+a*n*d-s*n*g+s*h*c-a*l*c)+S*(+e*h*m-e*o*g-a*n*m+i*n*g+a*o*c-i*h*c)+C*(-s*o*c-e*l*m+e*o*d+s*n*m-i*n*d+i*l*c)}decompose(){const t=this.data;let e=new Bt(t[0],t[1],t[2]).getLength(),i=new Bt(t[4],t[5],t[6]).getLength(),s=new Bt(t[8],t[9],t[10]).getLength();this.determinant()<0&&(e=-e);let n=new Bt(t[12],t[13],t[14]),o=new at;o.set(this.data);const l=1/e,h=1/i,c=1/s;o.data[0]*=l,o.data[1]*=l,o.data[2]*=l,o.data[4]*=h,o.data[5]*=h,o.data[6]*=h,o.data[8]*=c,o.data[9]*=c,o.data[10]*=c;let m=new Bt(e,i,s);return m.x=e,m.y=i,m.z=s,{position:n,rotation:o,scale:m}}compose(t,e,i){const s=this.data,a=e.x,n=e.y,o=e.z,l=e.w,h=a+a,c=n+n,m=o+o,d=a*h,g=a*c,f=a*m,v=n*c,S=n*m,C=o*m,R=l*h,N=l*c,V=l*m,q=i.x,B=i.y,U=i.z;return s[0]=(1-(v+C))*q,s[1]=(g+V)*q,s[2]=(f-N)*q,s[3]=0,s[4]=(g-V)*B,s[5]=(1-(d+C))*B,s[6]=(S+R)*B,s[7]=0,s[8]=(f+N)*U,s[9]=(S-R)*U,s[10]=(1-(d+v))*U,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,this}multiplyMatrices(t,e){const i=t.data,s=e.data,a=this.data,n=i[0],o=i[4],l=i[8],h=i[12],c=i[1],m=i[5],d=i[9],g=i[13],f=i[2],v=i[6],S=i[10],C=i[14],R=i[3],N=i[7],V=i[11],q=i[15],B=s[0],U=s[4],D=s[8],H=s[12],O=s[1],Z=s[5],Ct=s[9],ut=s[13],kt=s[2],bt=s[6],It=s[10],wt=s[14],Et=s[3],Ft=s[7],yt=s[11],vt=s[15];return a[0]=n*B+o*O+l*kt+h*Et,a[4]=n*U+o*Z+l*bt+h*Ft,a[8]=n*D+o*Ct+l*It+h*yt,a[12]=n*H+o*ut+l*wt+h*vt,a[1]=c*B+m*O+d*kt+g*Et,a[5]=c*U+m*Z+d*bt+g*Ft,a[9]=c*D+m*Ct+d*It+g*yt,a[13]=c*H+m*ut+d*wt+g*vt,a[2]=f*B+v*O+S*kt+C*Et,a[6]=f*U+v*Z+S*bt+C*Ft,a[10]=f*D+v*Ct+S*It+C*yt,a[14]=f*H+v*ut+S*wt+C*vt,a[3]=R*B+N*O+V*kt+q*Et,a[7]=R*U+N*Z+V*bt+q*Ft,a[11]=R*D+N*Ct+V*It+q*yt,a[15]=R*H+N*ut+V*wt+q*vt,this}makePerspective(t,e,i,s,a,n){n===void 0&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const o=this.data,l=2*a/(e-t),h=2*a/(i-s),c=(e+t)/(e-t),m=(i+s)/(i-s),d=-(n+a)/(n-a),g=-2*n*a/(n-a);return o[0]=l,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=h,o[9]=m,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=g,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,i,s,a,n){const o=this.data,l=1/(e-t),h=1/(i-s),c=1/(n-a),m=(e+t)*l,d=(i+s)*h,g=(n+a)*c;return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-m,o[1]=0,o[5]=2*h,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=-2*c,o[14]=-g,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}mul2(t,e){const i=t.data,s=e.data,a=this.data,n=i[0],o=i[1],l=i[2],h=i[3],c=i[4],m=i[5],d=i[6],g=i[7],f=i[8],v=i[9],S=i[10],C=i[11],R=i[12],N=i[13],V=i[14],q=i[15];let B,U,D,H;return B=s[0],U=s[1],D=s[2],H=s[3],a[0]=n*B+c*U+f*D+R*H,a[1]=o*B+m*U+v*D+N*H,a[2]=l*B+d*U+S*D+V*H,a[3]=h*B+g*U+C*D+q*H,B=s[4],U=s[5],D=s[6],H=s[7],a[4]=n*B+c*U+f*D+R*H,a[5]=o*B+m*U+v*D+N*H,a[6]=l*B+d*U+S*D+V*H,a[7]=h*B+g*U+C*D+q*H,B=s[8],U=s[9],D=s[10],H=s[11],a[8]=n*B+c*U+f*D+R*H,a[9]=o*B+m*U+v*D+N*H,a[10]=l*B+d*U+S*D+V*H,a[11]=h*B+g*U+C*D+q*H,B=s[12],U=s[13],D=s[14],H=s[15],a[12]=n*B+c*U+f*D+R*H,a[13]=o*B+m*U+v*D+N*H,a[14]=l*B+d*U+S*D+V*H,a[15]=h*B+g*U+C*D+q*H,this}mul(t){return this.mul2(this,t)}setTRS(t,e,i){var s,a,n,o,l,h,c,m,d,g,f,v,S,C,R,N,V,q,B,U,D,H,O;return s=t.x,a=t.y,n=t.z,o=e.x,l=e.y,h=e.z,c=e.w,m=i.x,d=i.y,g=i.z,f=o+o,v=l+l,S=h+h,C=o*f,R=o*v,N=o*S,V=l*v,q=l*S,B=h*S,U=c*f,D=c*v,H=c*S,O=this.data,O[0]=(1-(V+B))*m,O[1]=(R+H)*m,O[2]=(N-D)*m,O[3]=0,O[4]=(R-H)*d,O[5]=(1-(C+B))*d,O[6]=(q+U)*d,O[7]=0,O[8]=(N+D)*g,O[9]=(q-U)*g,O[10]=(1-(C+V))*g,O[11]=0,O[12]=s,O[13]=a,O[14]=n,O[15]=1,this}toJSON(){return Array.from(this.data)}}function js(r,t){r=r.split("."),t=t.split(".");const e=Math.max(r.length,t.length);for(;r.length<e;)r.push("0");for(;t.length<e;)t.push("0");for(let i=0;i<e;i++){const s=parseInt(r[i]),a=parseInt(t[i]);if(s>a)return 1;if(s<a)return-1}return 0}function Ws(r){return js(r,"4.3")>=0}function Xt(r,t){if(!r)throw new Error(t)}function Ks(r,t,e){let i=0;return function(...s){if(Date.now()-i>t)return i=Date.now(),r.apply(e,s)}}const Ut={globalUrl:"https://global.easyar.cn",arocUrl:"https://aroc-api.easyar.com",clsUrl:"https://cls-api.easyar.com",uacUrl:"https://uac.easyar.com",clsV3Url:"https://clsv3-api.easyar.com",emaUrl:"https://large-spatialmaps.easyar.com"};function Ys(r,t){return t&&[Ut.clsV3Url,Ut.clsUrl].indexOf(t)<0?t:Ws(r)?Ut.clsV3Url:Ut.clsUrl}var $t=null;function $i(r){$t=r}function Js(r){return $t(`${Ut.globalUrl}/anonymous/cls/${r}`,"GET",{},null,null)}function Xs(r,t,e){return $t(`${r}/cls/arannotations`,"GET",{appId:t,pageNum:1,pageSize:100},{authorization:e},null)}function Qs(r,t,e,i){return $t(`${r}/cls/arannotation/${t}`,"GET",{appId:e},{authorization:i},null)}function Zs(r){let t=JSON.stringify(r);return $t("https://posefusion.easyar.com/pose/v1","POST",null,null,t)}async function tr(r,t,e,i,s){let a=Object.keys(e||{}),n=a.length?a.map(h=>`${h}=${encodeURIComponent(e[h])}`).join("&"):void 0,l={url:r+(n?`?${n}`:""),method:t,headers:{},data:void 0};return i&&(l.headers=i),s&&(l.data=s),new Promise((h,c)=>{my.request({...l,success:m=>h(m.data),fail:m=>c(m)})})}async function er(r,t,e,i,s){let a=Object.keys(e||{}),n=a.length?a.map(h=>`${h}=${encodeURIComponent(e[h])}`).join("&"):void 0,l={url:r+(n?`?${n}`:""),method:t,header:{},data:void 0};return i&&(l.header=i),s&&(l.data=s),new Promise((h,c)=>{wx.request({...l,success:m=>h(m.data),fail:m=>c(m)})})}class de{constructor(){this._callbacks={},this._callbackActive={}}initEventHandler(){this._callbacks={},this._callbackActive={}}_addCallback(t,e,i,s=!1){!t||typeof t!="string"||!e||(this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:i||this,once:s}))}on(t,e,i){return this._addCallback(t,e,i,!1),this}off(t,e,i){if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(const s in this._callbackActive)!this._callbacks[s]||this._callbacks[s]===this._callbackActive[s]&&(this._callbackActive[s]=this._callbackActive[s].slice());if(!t)this._callbacks={};else if(!e)this._callbacks[t]&&(this._callbacks[t]=[]);else{const s=this._callbacks[t];if(!s)return this;let a=s.length;for(let n=0;n<a;n++)s[n].callback===e&&(i&&s[n].scope!==i||(s[n--]=s[--a]));s.length=a}return this}fire(t,...e){if(!t||!this._callbacks[t])return this;let i;this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),i=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(let s=0;(i||this._callbackActive[t])&&s<(i||this._callbackActive[t]).length;s++){const a=(i||this._callbackActive[t])[s];if(a.callback.call(a.scope,...e),a.once){const n=this._callbacks[t],o=n?n.indexOf(a):-1;o!==-1&&(this._callbackActive[t]===n&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(o,1))}}return i||(this._callbackActive[t]=null),this}once(t,e,i){return this._addCallback(t,e,i,!0),this}hasEvent(t){return this._callbacks[t]&&this._callbacks[t].length!==0||!1}}function ir(r){let t=new qe("SHA-256","TEXT");return t.update(r),t.getHash("HEX")}let Ie={},ei={};function sr(r,t,e){if(!r)return Promise.reject("apiKey undefined");if(!t)return Promise.reject("apiSecret undefined");if(!e)return Promise.reject("appId undefined");let i=new Date().getTime();if(ei[r]&&i<ei[r]&&Ie[r])return Promise.resolve(Ie[r]);const s=3600;ei[r]=i+s*1e3;const a=`[{"service":"ecs:cls","effect":"Allow","resource":["${e}"],"permission":["READ","WRITE"]}]`;let n={expires:s,timestamp:i,apiKey:r,acl:a},o=Object.keys(n).sort().map(l=>`${l}${n[l]}`).concat(t).join("");return n.signature=ir(o),$t(`${Ut.uacUrl}/token/v2`,"POST",null,null,n).then(l=>l.result&&l.result.token?(Ie[r]=l.result.token,Ie[r]):(console.error("token error"),"TOKEN_ERROR"))}class Gi extends de{constructor(t){super(),this.clsdata={},Xt(t.apiKey,"apiKey \u4E0D\u4E3A\u7A7A"),Xt(t.apiSecret,"apiSecret \u4E0D\u4E3A\u7A7A"),Xt(t.clsAppId,"clsAppId \u4E0D\u4E3A\u7A7A"),this.config=t,this.config.useCache===void 0&&(this.config.useCache=!0),t.serverConfig&&Object.assign(Ut,t.serverConfig),this.clsdata={}}setConfig(t,e){e=e||this.config.clsAppId!=t.clsAppId,Xt(t.apiKey,"apiKey \u4E0D\u4E3A\u7A7A"),Xt(t.apiSecret,"apiSecret \u4E0D\u4E3A\u7A7A"),Xt(t.clsAppId,"clsAppId \u4E0D\u4E3A\u7A7A"),Object.assign(this.config,t),t.serverConfig&&Object.assign(Ut,t.serverConfig),e&&(this.clsdata={})}getConfig(){return this.config}async getToken(){return this.token=await sr(this.config.apiKey,this.config.apiSecret,this.config.clsAppId),this.token}async getVersion(){if(this.config.useCache&&this.clsdata.clsVersion)return this.clsdata.clsVersion;const t=await Js(this.config.clsAppId);return this.clsdata.clsVersion=t.version,this.clsdata.clsVersion}async getClsHost(){return this.config.useCache&&this.clsdata.clsHost?this.clsdata.clsHost:(await this.getVersion(),this.clsdata.clsHost=Ys(this.clsdata.clsVersion),this.clsdata.clsHost)}async getArannotations(){if(this.config.useCache&&this.clsdata.arannotations)return this.clsdata.arannotations;await this.getToken(),await this.getClsHost();let t=await Xs(this.clsdata.clsHost,this.config.clsAppId,this.token),{arannotations:e}=t.result;return this.clsdata.arannotations=e,this.clsdata.arannotations}async getArannotationsDetail(){if(this.config.useCache&&this.clsdata.arannotationsDetail)return this.clsdata.arannotationsDetail;const t=await this.getArannotations(),e=await Promise.all(t.map(i=>this._getEmaByArannotaionId(i.arannotationId)));return Object.assign(this.clsdata,{arannotationsDetail:e}),this.clsdata}async getArannotationDetail(t,e){e||(e={ema:!0,meta:!0});const i=await this.getArannotations();t=t!=null?t:this.config.arannotationId,Xt(t,"arannotationId\u4E0D\u80FD\u4E3A\u7A7A");let s=i.find(n=>n.arannotationId==t);if(!s)return Promise.reject("arannotationId\u4E0D\u5B58\u5728");let a=await this._getEmaByArannotaionId(s.arannotationId,e);return Object.assign(this.clsdata,a),this.clsdata}async _getEmaByArannotaionId(t,e){e||(e={ema:!0,meta:!0});let i=await Qs(this.clsdata.clsHost,t,this.config.clsAppId,this.token),s={ema:null,meta:null,emaClusters:null,emaBlocks:null,emaMaps:null,emaRelationships:null};const a=e.ema&&i.result.emaUrl?$t(i.result.emaUrl.replace("https://large-spatialmaps.easyar.com",Ut.emaUrl||"/api/large-spatialmaps"),"GET",null,{"content-type":" "},null).then(o=>(s.ema=o,o)):Promise.resolve(),n=e.meta&&i.result.metaUrl?$t(i.result.metaUrl,"GET",null,{"content-type":" "},null).then(o=>(s.meta=o,o)):Promise.resolve();return await Promise.all([a,n]),s}destroy(){this.off(),this.clsdata=null}}const ee=class{constructor(){this._isAC=!1,this.frames=[],this.debugFusions=[],this.lastFrameTs=0,this.lastVio=[],this._enable=!0,this.poseFusions=[],this.localFusion=null,this.currentFusion=null,this.lastFusion=null,this.poseFusionResult=null}static get instance(){return this._instance||(this._instance=new ee),this._instance}get isAC(){return this._isAC}set isAC(r){this._isAC!=r&&(this.currentFusion=null,this.poseFusionResult=null,this._isAC=r,this._enable=!r)}get enable(){return this._enable}set enable(r){this._isAC||this._enable!=r&&(r?(this.currentFusion=null,this.poseFusionResult=null,this._updateCurrentFusion()):this._updateLocalFusion(),this._enable=r)}insertData(r,t,e){let i={localTwc:{data:r},mapTcw:{data:t},timestamp:e};this.poseFusions.push(i);let s=0;for(;i.timestamp-this.poseFusions[s].timestamp>90;)s++;return s>0&&(this.poseFusions=this.poseFusions.slice(s)),this._isAC?this._updateACFusion():this._enable?this._updateCurrentFusion():this._updateLocalFusion()}_updateLocalFusion(){return this.poseFusions.length<1?Promise.reject("poseFusion empty"):new Promise((r,t)=>{const e=this.poseFusions[this.poseFusions.length-1],{localTwc:i,mapTcw:s}=e;this.localFusion=new at().mul2(new at().set(i.data).transpose(),new at().set(s.data).transpose()),r(null)})}_updateCurrentFusion(){return this.poseFusions.length<1?Promise.reject("poseFusion empty"):Zs(this.poseFusions).then(r=>{const t=this.poseFusionResult?this.poseFusionResult:r.result;if(this.poseFusionResult=r.result,this.poseFusionResult.status<t.status||this.poseFusionResult.timestamp<t.timestamp)return;const i=new at().set(this.poseFusionResult.transform.data).transpose().clone().getInverse(),s=this.currentFusion?this.currentFusion:i,a=i;this.isSlerp=!ee.sim3DifferenceIsTooBig(s,a),this.isSlerp&&(this.sFusion=this.sFusion?this.sFusion:s,this.lastFusion=this.sFusion,this.slerpTimestamp=new Date().getTime()),this.currentFusion=a})}_updateACFusion(){return this.poseFusions.length<1?Promise.reject("poseFusion empty"):new Promise((r,t)=>{const{localTwc:e,mapTcw:i}=this.poseFusions[this.poseFusions.length-1];this.localFusion=new at().mul2(new at().set(e.data).transpose(),new at().set(i.data).transpose()),this.sFusion=this.sFusion||this.localFusion,this.lastFusion=this.sFusion,r(null)})}getPoseInMap(r,t,e=0){if(this._isAC)return this.getACPose(r,t,e);const i=this._enable&&this.currentFusion?this.currentFusion:this.localFusion;if(!i)return null;if(this._enable&&this.isSlerp){const a=(new Date().getTime()-this.slerpTimestamp)/1e3,n=Math.min(1,a);this.sFusion=ee.averageResult(this.lastFusion,i,n)}else this.sFusion=i;let s=new at().mul2(new at().set(r),this.sFusion.clone()).getInverse();return this.norm(s.data)}getACPose(r,t,e=0){const i=Array.from(new at().set(r).transpose().getInverse().data);this.insertFrames(t,e,i);const s=this.localFusion;if(!s)return null;let a=null;if(this.poseFusions.length<2||ee.sim3DifferenceIsTooBig(this.lastFusion,s))this.sFusion=s;else{const n=this.poseFusions[this.poseFusions.length-1].timestamp,o=t-n,l=Math.min(1,o);this.sFusion=ee.averageResult(this.lastFusion,s,l)}return a=new at().mul2(new at().set(r),this.sFusion.clone()).getInverse(),this.norm(a.data)}norm(r){const t=Math.sqrt(r[0]*r[0]+r[4]*r[4]+r[8]*r[8]),e=r.map((i,s)=>s<12&&s%4<3?i/t:i);return e[15]=1,e}clearFusion(){this.poseFusions=[],this.debugFusions=[],this.frames=[],this.poseFusionResult=null,this.lastFrameTs=0,this.lastVio=[],this.currentFusion=null,this.localFusion=null}clearFrames(){this.frames=[]}getFrames(){return this.frames}insertFrames(r,t,e){this.frames.push({rotate:`${t}`,frameTimestamp:`${r}`,vioPose:e.map(i=>`${i}`),trackingStatus:"2"}),this.frames.length>120&&(this.frames=this.frames.slice(120))}insertDebug(r,t,e,i,s=""){this.debugFusions.push({localTwc:r,mapTcw:t,timestamp:e,cameraParam:`${JSON.stringify(i)}}`,base64:s,fusionPoses:[]})}getDebug(){return this.debugFusions}detectVioJumps(r,t){if(this.lastFrameTs==0||this.lastVio.length==0)return this.lastFrameTs=t,this.lastVio=r,!1;let e=!0;const i={x:this.lastVio[3],y:this.lastVio[7],z:this.lastVio[11]},s={x:r[3],y:r[7],z:r[11]},a={x:i.x-s.x,y:i.y-s.y,z:i.z-s.z},n=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z),o=t-this.lastFrameTs;return o<1e-7&&(e=!1),e&&(n/o>6||n>3)&&this.clearFusion(),this.lastFrameTs=t,this.lastVio=r,e}static sim3DifferenceIsTooBig(r,t){const e=r.decompose(),i=t.decompose(),s=e.rotation.getInverse().mul(i.rotation).data;let a=(s[0]+s[5]+s[10]+s[15]-1.000001)/2;a>=1&&(a=1),a<=-1&&(a=-1);const n=Math.acos(a)*180/Math.PI,o={x:e.position.x-i.position.x,y:e.position.y-i.position.y,z:e.position.z-i.position.z};return Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z)>5||n>90}static averageResult(r,t,e){const i=r.decompose(),s=t.decompose(),a=new ti().setFromMat4(r),n=new ti().setFromMat4(t),o=new Bt(i.position.x*(1-e)+s.position.x*e,i.position.y*(1-e)+s.position.y*e,i.position.z*(1-e)+s.position.z*e),l=new Bt(i.scale.x*(1-e)+s.scale.x*e,i.scale.y*(1-e)+s.scale.y*e,i.scale.z*(1-e)+s.scale.z*e),h=new ti().slerp(a,n,e);return h.w=-h.w,new at().setTRS(o,h,l)}};let pe=ee;pe._instance=null;class ii extends Gi{constructor(t){super(t),this._interval=1e3,this._curLocalizerRes=null,t.arannotationId&&this.getArannotationDetail(t.arannotationId,{ema:!0,meta:!1}).then(e=>{this.fire("emaLoaded",e)}),this.fire("clsLoaded",this),t.autoStart&&this.start()}get currentBlockId(){var t;return(t=this._curLocalizerRes)==null?void 0:t.blockId}get offsetMatrix(){return pe.instance.currentFusion.data}get worldMatrix(){return this._worldMatrix}get currentBlockName(){var t;return this._curLocalizerRes?(t=this._curLocalizerRes)==null?void 0:t.name:null}updateFrame(t){const{camera:e,timestamp:i,results:s}=t;if(this._inLoop&&this._request&&this._request(t),e.trackingStatus!=-1&&s&&s.length>0){const a=this.parseMegaResult(s);if(a){this._curLocalizerRes===null?this._curLocalizerRes=a:this._curLocalizerRes.name!=a.name&&(this._curLocalizerRes=a);let n=new at().set(a.pose).getInverse();n.mul2(new at().set([0,-1,0,0,1,0,0,0,0,0,1,0,0,0,0,1]),n),this._worldMatrix=n.transpose().data}}}setGPS(t){}setConfig(t,e){super.setConfig(t,e),this.clearFusion(),t.arannotationId&&this.getArannotationDetail(t.arannotationId,{ema:!0,meta:!1}).then(i=>{this.fire("emaLoaded",i)})}clearFusion(){pe.instance.clearFusion()}start(t){this._inLoop||(this._inLoop=!0,t&&(this._interval=t),this._request=Ks(this.localizeOnce,this._interval,this))}stop(){this._inLoop=!1}resume(){this._inLoop||(this._request||this.start(),this._inLoop=!0)}pause(){!this._inLoop||(this._inLoop=!1)}getPoseInBlock(t){let e=new at().set(t).getInverse().data;return pe.instance.getPoseInMap(e)}async localizeOnce(t){this._busy||(this._busy=!0,this._curLocalizerRes?this.fire("localize_sucess",{statusCode:0,msg:"Localization Scc",result:[this._curLocalizerRes]}):this.fire("localize_fail",{statusCode:17,msg:"Localization failed"}),this._busy=!1)}parseMegaResult(t){const e=t.length;for(let i=0;i<e;i++){const s=t[i].instances,a=s.length;for(let n=0;n<a;n++)return s[n]}return null}}var mt=(r=>(r[r.Small=640]="Small",r[r.Normal=960]="Normal",r[r.Big=1280]="Big",r))(mt||{}),ht=(r=>(r[r.Portrait=0]="Portrait",r[r.LandscapeLeft=90]="LandscapeLeft",r[r.PortraitUpsideDown=180]="PortraitUpsideDown",r[r.LandscapeRight=270]="LandscapeRight",r))(ht||{});class si{constructor(t,e,i){this.imageLongsideLength=960,this.deviceOrientation=0,this.remoteDebugFlag=!1,this.imageLongsideLength=t,this.deviceOrientation=e,this.remoteDebugFlag=i}static copyConstruct(t){return new si(t.imageLongsideLength,t.deviceOrientation,t.remoteDebugFlag)}}class rr extends ke{constructor(t,e,i){super(),this._imageLongsideLength=mt.Normal,this._deviceOrientation=ht.Portrait,this._legacyBlockServiceFlag=!1,this._vkframe=null,this._calibData=null,this.captureCanvas=null,this.captureCTX=null,this._capturePixelRatio=null,this._imageLongsideLength=e,this._deviceOrientation=i,this._arSessionCtrl=t,(()=>new Promise((a,n)=>{this.captureCanvas=wx.createOffscreenCanvas({type:"2d",width:720,height:960});const o=setInterval(()=>{if(this.captureCanvas){this.captureCTX=this.captureCanvas.getContext("2d"),clearInterval(o),a(null);return}console.warn("try create capture canvas"),this.captureCanvas=wx.createOffscreenCanvas({type:"2d",width:720,height:960})},60)}))(),tt.instance.getCalibData().then(a=>{this._calibData=a})}set imageLongsideLength(t){if(t!=mt.Small&&t!=mt.Normal&&t!=mt.Big){console.error(`Invalid imageLongsideLength : ${t}; It must be 640 or 960 or 1280`);return}this._imageLongsideLength=t}initialize(){this._initFlag=!0}dispose(){this._onFrameInput.dispose(),this.captureCanvas=null,this.captureCTX=null,this._initFlag=!1}onLegacyBlockService(){this._legacyBlockServiceFlag=!0}onFrameUpdate(...t){if(this._vkframe==null)return;let e=null;this._arSessionCtrl.trackMode==P.Dof6?e=Y.SixDof:this._arSessionCtrl.trackMode==P.Dof5||this._arSessionCtrl.trackMode==P.Dof3?e=Y.ThreeDofRotOnly:this._arSessionCtrl.trackMode==P.Camera&&(e=Y.ZeroDof);const i=this._arSessionCtrl.curARSession.state==1&&e==Y.SixDof?Gt.Tracking:Gt.NotTracking,s=this._arSessionCtrl.curARSession.cameraSize.width,a=this._arSessionCtrl.curARSession.cameraSize.height;if(!this._capturePixelRatio){this._capturePixelRatio=this._imageLongsideLength/this._arSessionCtrl.curARSession.cameraSize.height;let d=this._arSessionCtrl.curARSession.cameraSize.width*this._capturePixelRatio;d%16!=0&&(d=Math.ceil(d/16)*16,this._capturePixelRatio=d/this._arSessionCtrl.curARSession.cameraSize.width,this._imageLongsideLength=this._arSessionCtrl.curARSession.cameraSize.height*this._capturePixelRatio)}const n=this._capturePixelRatio;this.captureCanvas.width!=s*n&&(this.captureCanvas.width=s*n,this.captureCanvas.height=a*n);const o=this._vkframe.camera.intrinsics;let l;if(o){const d={width:s,height:a,fx:o[4],fy:o[0],cx:o[7],cy:o[6]};l=ft.createFromCalibData(d,this._deviceOrientation,s*n,a*n),l.cameraOrientation=0}else this._calibData?l=ft.createFromCalibData(this._calibData,this._deviceOrientation,s*n,a*n):l=ft.createDefault(s*n,a*n,this._imageLongsideLength,this._deviceOrientation),l.cameraOrientation=0;const h=this._vkframe.timestamp/1e9;Ve.copyArrayBufferToNumbers(this._vkframe.camera.viewMatrix);let c=new K().setFromEulerAngles(0,0,-l.getImageOrientation()),m=null;if(e==Y.SixDof||e==Y.ThreeDofRotOnly){let d=new K().set(this._arSessionCtrl._worldMatrix.data);m=new K().mul2(d,c)}else e==Y.ZeroDof&&(m=null);if(this._imageFlag){this._imageFlag=!1;const d=this._onFrameInput;if(this._vkframe.getCameraJpgBuffer){const g=this._vkframe.getCameraJpgBuffer(this.captureCanvas.width,this.captureCanvas.height,70),f=new Vt(i,e,l,h,m,null,g);d.fire(f)}else{const g=this.captureCanvas,f=this._vkframe.getCameraBuffer(this.captureCanvas.width,this.captureCanvas.height);let v=this.captureCTX,S=g.createImageData(new Uint8ClampedArray(f),this.captureCanvas.width,this.captureCanvas.height);v.putImageData(S,0,0),new Promise(C=>{setTimeout(()=>{C(g.toDataURL("image/jpeg",.7))})}).then(C=>{const R=new Vt(i,e,l,h,m,C);d.fire(R)}),console.warn("\u8BF7\u5347\u7EA7\u5FAE\u4FE1\u4EE5\u83B7\u53D6\u66F4\u597D\u7684\u6027\u80FD")}}else{const d=new Vt(i,e,l,h,m);this._onFrameInput.fire(d)}}onDeviceOrientationChange(t){if(t!=ht.Portrait&&t!=ht.PortraitUpsideDown&&t!=ht.LandscapeLeft&&t!=ht.LandscapeRight)throw new Error(`Invalid deviceOrientation : ${t}; It must be 0, 90, 180 or 270`);this._deviceOrientation=t}setVKFrame(t){this._vkframe=t}}class ar{constructor(t){this.gl=t,this._dt=null,this._program=null,this._vao=null,this._vao_ext=null}get program(){return this._program}set program(t){this._program=t}initGL(){this.initShader(),this.initVAO()}initShader(){const t=this.gl,e=t.getParameter(t.CURRENT_PROGRAM),i=`
        attribute vec2 a_position;
        attribute vec2 a_texCoord;
        uniform mat3 displayTransform;
        varying vec2 v_texCoord;
        void main() {
          vec3 p = displayTransform * vec3(a_position, 0.0);
          gl_Position = vec4(p, 1.0);
          v_texCoord = a_texCoord;
        }
      `,s=`
        precision highp float;

        uniform sampler2D y_texture;
        uniform sampler2D uv_texture;
        varying vec2 v_texCoord;
        void main() {
          vec4 y_color = texture2D(y_texture, v_texCoord);
          vec4 uv_color = texture2D(uv_texture, v_texCoord);

          float Y, U, V;
          float R ,G, B;
          Y = y_color.r;
          U = uv_color.r - 0.5;
          V = uv_color.a - 0.5;
          
          R = Y + 1.402 * V;
          G = Y - 0.344 * U - 0.714 * V;
          B = Y + 1.772 * U;
          
          gl_FragColor = vec4(R, G, B, 1.0);
        }
      `,a=t.createShader(t.VERTEX_SHADER);t.shaderSource(a,i),t.compileShader(a);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,s),t.compileShader(n);const o=this._program=t.createProgram();this._program.gl=t,t.attachShader(o,a),t.attachShader(o,n),t.deleteShader(a),t.deleteShader(n),t.linkProgram(o),t.useProgram(o);const l=t.getUniformLocation(o,"y_texture");t.uniform1i(l,5);const h=t.getUniformLocation(o,"uv_texture");t.uniform1i(h,6),this._dt=t.getUniformLocation(o,"displayTransform"),t.useProgram(e)}initVAO(){const t=this.gl,e=t.getExtension("OES_vertex_array_object");this._vao_ext=e;const i=t.getParameter(t.VERTEX_ARRAY_BINDING),s=e.createVertexArrayOES();e.bindVertexArrayOES(s);const a=t.getAttribLocation(this._program,"a_position"),n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),t.STATIC_DRAW),t.vertexAttribPointer(a,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(a),s.posBuffer=n;const o=t.getAttribLocation(this._program,"a_texCoord"),l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,0,1,1,0,0,0]),t.STATIC_DRAW),t.vertexAttribPointer(o,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(o),s.texcoordBuffer=l,e.bindVertexArrayOES(i),this._vao=s}renderGL(t){const e=this.gl;e.disable(e.DEPTH_TEST);const{yTexture:i,uvTexture:s}=t.getCameraTexture(e),a=t.getDisplayTransform();if(i&&s){const n=e.getParameter(e.CURRENT_PROGRAM),o=e.getParameter(e.ACTIVE_TEXTURE),l=e.getParameter(e.VERTEX_ARRAY_BINDING);e.useProgram(this._program),this._vao_ext.bindVertexArrayOES(this._vao),e.uniformMatrix3fv(this._dt,!1,a),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.activeTexture(e.TEXTURE0+5);const h=e.getParameter(e.TEXTURE_BINDING_2D);e.bindTexture(e.TEXTURE_2D,i),e.activeTexture(e.TEXTURE0+6);const c=e.getParameter(e.TEXTURE_BINDING_2D);e.bindTexture(e.TEXTURE_2D,s),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.bindTexture(e.TEXTURE_2D,c),e.activeTexture(e.TEXTURE0+5),e.bindTexture(e.TEXTURE_2D,h),e.useProgram(n),e.activeTexture(o),this._vao_ext.bindVertexArrayOES(l)}}clearGL(){const t=this.gl;t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.clear(t.DEPTH_BUFFER_BIT),t.clear(t.STENCIL_BUFFER_BIT)}destroy(){this._program&&this._program.gl&&(this.clearGL(),this._program.gl.deleteProgram(this._program),this._program=null,this.gl=null)}}/**
* KalmanFilter
* @class
* @see {@link http://github.com/wouterbulten/kalmanjs}
* @version Version: 1.0.0-beta
* @copyright Copyright 2015-2018 Wouter Bulten
* @license MIT License
* @preserve
*/class ri{constructor({R:t=1,Q:e=1,A:i=1,B:s=0,C:a=1}={}){this.R=t,this.Q=e,this.A=i,this.B=s,this.C=a,this.cov=void 0,this.x=void 0}filter(t,e=0){if(this.x===void 0)this.x=1/this.C*t,this.cov=1/this.C*this.Q*(1/this.C);else{const i=this.predict(e),s=this.uncertainty(),a=s*this.C*(1/(this.C*s*this.C+this.Q));this.x=i+a*(t-this.C*i),this.cov=s-a*this.C*s}return this.x}predict(t=0){if(this.x===void 0)throw new Error("Prediction cannot be made without initial measurement.");return this.A*this.x+this.B*t}uncertainty(){if(this.cov===void 0)throw new Error("Uncertainty cannot be calculated without initial measurement.");return this.A*this.cov*this.A+this.R}lastMeasurement(){return this.x}setMeasurementNoise(t){this.Q=t}setProcessNoise(t){this.R=t}}class Ee{constructor(t){this.BUFFER_SIZE=30,this.MIN_STEP_INTERVAL=250,this.WINDOW_SIZE=4,this.handleAccelerometerData=e=>{let i=this.kalmanFilters[0].filter(e.x),s=this.kalmanFilters[1].filter(e.y),a=this.kalmanFilters[2].filter(e.z);this.detectStep({x:i,y:s,z:a})&&(this.stepCount++,I.log("step count:",this.stepCount),this.updatePosition())},this.lashHandleAccelerometerDataTime=0,this.pc=t,this.localPosition=new this.pc.Vec3,this.localRotation=new this.pc.Quat,this.localScale=new this.pc.Vec3(1,1,1),this.localPose=new this.pc.Mat4().setTRS(this.localPosition,this.localRotation,this.localScale),this.lastUpdateTime=Date.now(),this.stepCount=0,this.stepLength=.7,this.externalRotation=null,this.accelerationBuffer=[],this.lastStepTime=0,this.stepThreshold=.001,this.kalmanFilters=[new ri({R:.01,Q:.1}),new ri({R:.01,Q:.1}),new ri({R:.01,Q:.1})],this.initSensors()}initSensors(){wx.onAccelerometerChange(this.handleAccelerometerData)}destroy(){wx.offAccelerometerChange(this.handleAccelerometerData)}detectStep(t){const e=Date.now();if(e-this.lashHandleAccelerometerDataTime<20)return this.lashHandleAccelerometerDataTime=e,!1;const i=Math.abs(Math.sqrt(t.x**2+t.y**2+t.z**2)-1);for(this.accelerationBuffer.push(i);this.accelerationBuffer.length>this.BUFFER_SIZE;)this.accelerationBuffer.shift();if(this.accelerationBuffer.length===this.BUFFER_SIZE&&this.checkLocalMaximum(this.accelerationBuffer)){const a=this.accelerationBuffer.reduce((o,l)=>o+l)/this.BUFFER_SIZE;if(this.accelerationBuffer.reduce((o,l)=>o+(l-a)**2,0)/this.BUFFER_SIZE>this.stepThreshold&&e-this.lastStepTime>this.MIN_STEP_INTERVAL)return this.lastStepTime=e,!0}return!1}checkLocalMaximum(t){const e=Math.floor(this.BUFFER_SIZE/2),i=t[e],s=t.slice(e-this.WINDOW_SIZE,e).reduce((h,c)=>h+c)/this.WINDOW_SIZE,a=t.slice(e+1,e+1+this.WINDOW_SIZE).reduce((h,c)=>h+c)/this.WINDOW_SIZE,n=i>s&&i>a,o=t[e-1]-t[e-2],l=t[e+1]-t[e];return n&&o>0&&l<0}updatePosition(){const t=new this.pc.Vec3(0,0,-this.stepLength);this.localRotation.clone().transformVector(t,t),t.y=0,this.lastLocalPosition||(this.lastLocalPosition=this.localPosition.clone()),this.localPosition.add(t.normalize().mulScalar(this.stepLength))}updateWithExternalRotation(t){this.localRotation=t.clone()}updateWithWorldPose(t){}getLocalPose(){if(!this.lastLocalPosition)return this.localPose.setTRS(this.localPosition,this.localRotation,this.localScale),this.localPose;const t=this.lastLocalPosition.lerp(this.lastLocalPosition,this.localPosition,.03);return this.localPose.setTRS(t,this.localRotation,this.localScale),this.localPose}}function nr(r,t,e){const i=e,s=[i[0],i[1],i[2]],a=ie(Fe(s,t),ji(i[3],t)),n=Fe(s,a),o=ie(ie(n,n),t),l=ie(Fe(s,r),ji(i[3],r)),h=Fe(s,l);return[...ie(ie(h,h),r),...o]}function Fe(r,t){return[r[1]*t[2]-r[2]*t[1],r[2]*t[0]-r[0]*t[2],r[0]*t[1]-r[1]*t[0]]}function ie(r,t){return r.map((e,i)=>e+t[i])}function ji(r,t){return t.map(e=>e*r)}function or(r){const[t,e,i]=r.map(v=>-v*Math.PI/180),s=Math.cos(t/2),a=Math.sin(t/2),n=Math.cos(e/2),o=Math.sin(e/2),l=Math.cos(i/2),h=Math.sin(i/2),c=l*n*s+h*o*a,m=l*o*s+h*n*a,d=h*n*s-l*o*a,g=l*n*a-h*o*s;return[-m,-d,-g,c]}class ai extends Error{constructor(t,e){super(e),this.type=t,this.name="SensorError"}}class ni extends de{constructor(){super(...arguments),this.gyroDatas=[],this.accelDatas=[],this.orientationDatas=[],this.orientationQuatDatas=[],this.onAccelUpdate=t=>{const e=Date.now();this.fire("accelUpdate",t,e),this.accelDatas.push({timestamp:e,data:[t.x*-10,t.y*-10,t.z*-10]}),this.accelDatas=this.accelDatas.filter(i=>i.timestamp>=e-2e3)},this.onGyroUpdate=t=>{const e=Date.now();this.fire("gyroUpdate",t,e),this.gyroDatas.push({timestamp:e,data:[t.x,t.y,t.z]}),this.gyroDatas=this.gyroDatas.filter(i=>i.timestamp>=e-2e3)},this.onOriUpdate=t=>{const e=Date.now();tt.instance.isWeChat&&tt.instance.isAndroid&&(t.alpha=-t.alpha,t.beta=-t.beta,t.gamma=-t.gamma),this.fire("orientationUpdate",t,e),this.orientationDatas.push({timestamp:e,data:[t.alpha,t.beta,t.gamma]}),this.orientationDatas=this.orientationDatas.filter(s=>s.timestamp>=e-2e3);const i=or([t.alpha,t.beta,t.gamma]);Math.abs(i[0])<.01||(this.orientationQuatDatas.push({timestamp:e,data:i}),this.orientationQuatDatas=this.orientationQuatDatas.filter(s=>s.timestamp>=e-2e3))}}start(){wx.startAccelerometer({interval:"game",success:()=>{wx.onAccelerometerChange(this.onAccelUpdate)},fail:t=>{this.fire("error",new ai("NOT_ALLOWED",t.errMsg))}}),wx.startGyroscope({interval:"game",success:()=>{wx.onGyroscopeChange(this.onGyroUpdate)},fail:t=>{this.fire("error",new ai("NOT_ALLOWED",t.errMsg))}}),wx.startDeviceMotionListening({interval:"game",success:()=>{wx.onDeviceMotionChange(this.onOriUpdate)},fail:t=>{this.fire("error",new ai("NOT_ALLOWED",t.errMsg))}})}stop(){wx.offAccelerometerChange(this.onAccelUpdate),wx.offGyroscopeChange(this.onGyroUpdate),wx.offDeviceMotionChange(this.onOriUpdate),wx.stopAccelerometer(),wx.stopGyroscope(),wx.stopDeviceMotionListening()}}class ge extends de{constructor(){super(),this.session=null,this.modelLoaded=!1,this.sensors=null,this.running=!1,this.position=[0,0],this.velocity=[0,0],this.inferenceIntervalTime=100,this.inferenceTime=0,this._modelInfo={modelUrl:"https://sightp-tour-tiny-app.sightp.com/onnxModel/ronin_resnet.onnx",inputName:"x.3",inputShape:[1,6,200],outputName:"192",ouputShape:[1,2]},this.rotationData=[],this._inferenceIntvalId=-1,this._lastDebugTime=0}static get instance(){return this._instance||(this._instance=new ge),this._instance}init(t,e){if(this.pc=t,e)this.sensors=e;else{this.sensors=new ni;try{this.sensors.start(),this.fire("debug-msg",`sensor start
`)}catch(i){throw this.fire("debug-msg",`Error in starting sensors
`),new Error(i)}}this.fire("inited",this)}async loadModel(t){t||(t=this._modelInfo.modelUrl);const e=t.split("/").pop();let i=wx.env.USER_DATA_PATH+"/"+e,s=await new Promise((a,n)=>{wx.getFileSystemManager().access({path:i,success:()=>{s=!0,a(!0)},fail:()=>{s=!1,a(!1)}})});s?I.info("modelExist"):await new Promise((a,n)=>{this.fire("debug-msg",`Downloading model
`),wx.downloadFile({url:t,filePath:i,success:o=>{o.statusCode===200?(this.fire("debug-msg",`Model downloaded
`),I.info("Model downloaded"),a(null)):(this.fire("debug-msg",`Model download error
`),I.warn("Model download error",o),n(o))},fail:o=>{this.fire("debug-msg",`Model download error
`),I.error("Model download error",o),n(o)}})}),await new Promise((a,n)=>{this.session=wx.createInferenceSession({model:i,precesionLevel:4}),this.session.onLoad(()=>{this.fire("debug-msg",`Model loaded
`),this.modelLoaded=!0,a(null)}),this.session.onError(o=>{I.error("model load error",o),this.fire("debug-msg",`Model load error
`),n(o)})})}startInference(){this.running||(this.running=!0,this._inferenceIntvalId=setInterval(()=>{!this.session||!this.modelLoaded||this.singleInference()},this.inferenceIntervalTime))}stopInference(){!this.running||(this.running=!1,clearInterval(this._inferenceIntvalId))}async singleInference(){if(!!this.running)try{const t=Date.now();let e=this.getData(t-1e3,t);if(!e)return;const i=this._modelInfo.inputName,s=this._modelInfo.inputShape,a=this._modelInfo.outputName,n=this._modelInfo.ouputShape,o=new Float32Array(e),l={shape:s,data:o.buffer,type:"float32"},h=await this.session.run({[i]:l}),c=new Float32Array(h[a].data);if(this._modelInfo.ouputShape.length==2&&this._modelInfo.ouputShape[1]==2){const d=c[0],g=c[1];this.velocity=[d,g]}else if(this._modelInfo.ouputShape.length==3&&this._modelInfo.ouputShape[1]==200){const d=c.reduce((f,v,S)=>S%2===0?f+v:f,0)/200,g=c.reduce((f,v,S)=>S%2===1?f+v:f,0)/200;this.velocity=[d,g]}else if(this._modelInfo.ouputShape.length==3&&this._modelInfo.ouputShape[1]==2){const d=c[199],g=c[399];this.velocity=[d,g]}const m=[this.velocity[0]*this.inferenceIntervalTime/1e3,this.velocity[1]*this.inferenceIntervalTime/1e3];this.position=[this.position[0]+m[0],this.position[1]+m[1]],this.inferenceTime=Date.now()-t,this.fire("velocityUpdate",this.velocity,t),this.fire("positionUpdate",this.position,t),this.fire("inferenceTimeUpdate",this.inferenceTime,t),this.fire("inferenceResult",{velocity:this.velocity,position:this.position,inferenceTime:this.inferenceTime,timestamp:t}),Date.now()-this._lastDebugTime>1e3}catch(t){I.error(t),this.fire("error",t)}}getData(t,e=Date.now(),i=200){let s=[];const a=this.sensors,n=a.gyroDatas.filter(h=>h.timestamp>=t-500),o=a.accelDatas.filter(h=>h.timestamp>=t-500),l=a.orientationQuatDatas.filter(h=>h.timestamp>=t-500);if(n.length===0||o.length===0||l.length===0)return null;for(let h=0;h<i;h++){const c=t+h*(e-t)/i,m=this._interpolateData(n,c),d=this._interpolateData(o,c),g=this._interpolateData(l,c,!0);s.push(nr(m,d,g))}return Date.now()-this._lastDebugTime>1100&&(this._lastDebugTime=Date.now()),this._modelInfo.inputShape[1]===6&&(s=this._transpose(s)),s.flat()}_interpolateData(t,e,i=!1){if(t.length===0&&console.warn("No data available---"),t.length<2)return t[0].data;let s=0;for(s=0;s<t.length&&!(t[s].timestamp>e);s++);if(s===0)return t[0].data;if(s===t.length)return t[t.length-1].data;const a=t[s-1],n=t[s],o=(e-a.timestamp)/(n.timestamp-a.timestamp);if(i){let l=new this.pc.Quat(...a.data),h=new this.pc.Quat(...n.data),c=new this.pc.Quat().slerp(l,h,o);return[c.x,c.y,c.z,c.w]}else return a.data.map((l,h)=>l+o*(n.data[h]-l))}_interpolateRotationData(t,e){if(t.length===0&&console.warn("No data available---"),t.length<2)return t[0].data;let i=0;for(i=0;i<t.length&&!(t[i].timestamp>e);i++);if(i===0)return t[0].data;if(i===t.length)return t[t.length-1].data;const s=t[i-1],a=t[i],n=(e-s.timestamp)/(a.timestamp-s.timestamp);return new this.pc.Quat().slerp(s.data,a.data,n)}_processSensorData(t,e,i){const s=i.transformVector(t),a=i.transformVector(e);return[s.x,s.y,s.z,a.x,a.y,a.z]}_transpose(t){return t[0].map((e,i)=>t.map(s=>s[i]))}destroy(){var t,e,i;(t=this.session)==null||t.offError(),(e=this.session)==null||e.offLoad(),(i=this.session)==null||i.destroy(),this.session=null,this.modelLoaded=!1,this.off(),ge._instance=null}}class Wi{constructor(){this.data={},this.recodeing=!1}start(){this.data={},this.recodeing=!0,this.sensors&&(this.sensors.on("accelUpdate",this.onAccelUpdate,this),this.sensors.on("gyroUpdate",this.onGyroUpdate,this),this.sensors.on("orientationUpdate",this.onOriUpdate,this)),this.inferenceSessionManager&&this.inferenceSessionManager.on("inferenceResult",this.onInferenceResult,this),this.app&&(this.app.on("vioUpdate",this.onVioUpdate,this),this.app.on("inertailUpdate",this.onInertailUpdate,this),this.app.on("beaconUpdate",this.onBeaconUpdate,this))}onAccelUpdate(t,e){!this.recodeing||(this.data.accel||(this.data.accel=[]),this.data.accel.push({timestamp:e,data:t}))}onGyroUpdate(t,e){!this.recodeing||(this.data.gyro||(this.data.gyro=[]),this.data.gyro.push({timestamp:e,data:t}))}onOriUpdate(t,e){!this.recodeing||(this.data.ori||(this.data.ori=[]),this.data.ori.push({timestamp:e,data:t}))}onInferenceResult(t){!this.recodeing||(this.data.inference||(this.data.inference=[]),this.data.inference.push(t))}onVioUpdate(t){!this.recodeing||(this.data.vio||(this.data.vio=[]),this.data.vio.push(t))}onInertailUpdate(t){!this.recodeing||(this.data.inertail||(this.data.inertail=[]),this.data.inertail.push(t))}onBeaconUpdate(t){!this.recodeing||(this.data.beacon||(this.data.beacon=[]),this.data.beacon.push(t))}reportData(t,e){!this.recodeing||(this.data[t]||(this.data[t]=[]),this.data[t].push(e))}stop(){this.sensors&&(this.sensors.off("accelUpdate",this.onAccelUpdate,this),this.sensors.off("gyroUpdate",this.onGyroUpdate,this),this.sensors.off("orientationUpdate",this.onOriUpdate,this)),this.inferenceSessionManager&&this.inferenceSessionManager.off("inferenceResult",this.onInferenceResult,this),this.app&&(this.app.off("vioUpdate",this.onVioUpdate,this),this.app.off("inertailUpdate",this.onInertailUpdate,this)),this.recodeing=!1;const t=JSON.parse(JSON.stringify(this.data));return this.data={},t}}class Qt{constructor(t,e,i){this.preferPDR=!1,this._cameraRenderMode="towCanvas",this.pc=t,this.app=e,this._worldMatrix=new t.Mat4,this._projectMatrix=new t.Mat4,this._curPosition=new t.Vec3,this._targetPosition=new t.Vec3,this._viewWidth=i?i.width:e.graphicsDevice.canvas.width,this._viewHeight=i?i.height:e.graphicsDevice.canvas.height,this._near=.1,this._far=1e3,i&&this._cameraRenderMode=="towCanvas"?this._cameraCanvas3d=i:(I.warn("\u4F7F\u7528 oneCanvas \u6A21\u5F0F\u5C06\u4F1A\u964D\u4F4E\u6027\u80FD,\u8BF7\u4F20\u5165\u7528\u4E8E\u7ED8\u5236\u76F8\u673A\u753B\u9762\u7684 canvas"),this._cameraRenderMode="oneCanvas",this._cameraCanvas3d=wx.createOffscreenCanvas({type:"webgl",width:this._viewWidth,height:this._viewHeight})),this._cameraCanvasGl=this._cameraCanvas3d.getContext("webgl")}static canIUse(t=P.Dof6){console.warn("\u8BE5\u63A5\u53E3\u5DF2\u542F\u7528\uFF0C\u8BF7\u4F7F\u7528 queryARSupport \u4EE3\u66FF\uFF0C\u5E76\u4F9D\u636E\u8FD4\u56DE\u503C\u8FDB\u884C\u5224\u5B9A");let e=null;switch(t){case P.Camera:e="v1";break;case P.Dof3:e="v1";break;case P.Dof6:e="v2";break}return Promise.resolve(wx.isVKSupport(e))}static async queryARSupport(){return tt.instance.isIos?(this.supportTrackMode=P.Dof6,Promise.resolve({arBaseMode:Q.VKSession,arTrackMode:P.Dof6})):tt.instance.isSystemNotLessAndriod9?wx.isVKSupport("v2")?(this.supportTrackMode=P.Dof6,Promise.resolve({arBaseMode:Q.VKSession,arTrackMode:P.Dof6})):(this.supportTrackMode=wx.createInferenceSession!==void 0?P.Dof5:P.Dof3,Promise.resolve({arBaseMode:Q.VKSession,arTrackMode:this.supportTrackMode})):(this.supportTrackMode=P.Dof3,Promise.resolve({arBaseMode:Q.BaseCamera,arTrackMode:P.Dof3}))}create(t,e,i){let s=null;const a=wx.isVKSupport("v2");switch(this.trackMode=t.trackMode,t.trackMode){case P.Camera:s="v1";break;case P.Dof3:s="v1";break;case P.Dof5:s="v1";break;case P.Dof6:s="v2";break}if(s==="v2"&&!a&&(s="v1",I.warn("\u5F53\u524D\u8BBE\u5907\u4E0D\u652F\u6301 v2 \u7248\u672C\u7684 AR,\u5DF2\u964D\u7EA7\u4E3A v1 3dof \u7248\u672C"),this.trackMode=P.Dof5,!wx.isVKSupport("v1"))){I.warn("\u5F53\u524D\u8BBE\u5907\u4E0D\u652F\u6301 v1 \u7248\u672C\u7684 AR,\u65E0\u6CD5\u4F7F\u7528 AR \u529F\u80FD"),i&&i();return}if(this.curARSession=wx.createVKSession({version:s,track:{plane:{mode:1},marker:t.trackImage,threeDof:s==="v1"&&!t.trackImage},gl:this._cameraCanvasGl}),this.sensors=new ni,this.sensors.start(),this.sensors.on("orientationUpdate",n=>{this._deviceMotion=n},this),this.trackMode===P.Dof5){this.inferenceSessionManager=ge.instance,this.inferenceSessionManager.init(this.pc,this.sensors);try{this.inferenceSessionManager.loadModel().then(()=>{this.inferenceSessionManager.startInference()}),this.inferenceSessionManager.on("positionUpdate",n=>{this._targetPosition||(this._targetPosition=new this.pc.Vec3),this._targetPosition.set(n[0],0,-n[1])},this)}catch(n){I.error("\u52A0\u8F7DNN\u6A21\u578B\u5931\u8D25",n),this.inferenceSessionManager.destroy(),this.inferenceSessionManager=null,I.warn("\u964D\u7EA7\u4E3A PDR 3Dof \u6A21\u5F0F"),this.trackMode=P.Dof3,this.pdrSystem=new Ee(this.pc)}}this.trackMode===P.Dof3&&(this.pdrSystem=new Ee(this.pc)),this.dataRecoder=new Wi,this.dataRecoder.app=this.app,this.dataRecoder.sensors=this.sensors,this.dataRecoder.inferenceSessionManager=this.inferenceSessionManager,e&&e()}start(t,e,i){this.curARSession.start(s=>{s&&(I.error("vksession start error:",s),e&&e()),t&&t(),this.yuv=new ar(this._cameraCanvasGl),this.yuv.initGL(),this.app.xr.session||(I.info("\u5173\u95ED App3d \u81EA\u52A8\u5237\u65B0"),this.app.xr={session:{requestAnimationFrame:()=>{}},end:()=>{},destroy:()=>{}});const a=()=>{this._frameRequestId=this.curARSession.requestAnimationFrame(a),this.app.tick()};a()})}update(){const t=this.curARSession.getVKFrame(this._viewWidth,this._viewHeight);t&&(this._curARFrame=t,this.updatePosition(),ot.instance.clsClient&&ot.instance.clsClient.updateFrame(t),this.updateTexutre())}updateTexutre(){if(this.yuv.renderGL(this._curARFrame),this._cameraRenderMode!="towCanvas"&&(this._textureRGBA||(this._textureRGBA=new this.pc.Texture(this.app.graphicsDevice,{width:this._viewWidth,height:this._viewHeight,format:this.pc.PIXELFORMAT_R8_G8_B8_A8,mipmaps:!1,addressU:this.pc.ADDRESS_CLAMP_TO_EDGE,addressV:this.pc.ADDRESS_CLAMP_TO_EDGE}),this._bgMaterial&&(this._bgMaterial.setParameter("rgba_texture",this._textureRGBA),this._bgMaterial.update())),this._textureRGBA)){let t=this._textureRGBA.lock();this._cameraCanvasGl.readPixels(0,0,this._viewWidth,this._viewHeight,this._cameraCanvasGl.RGBA,this._cameraCanvasGl.UNSIGNED_BYTE,t),this._textureRGBA.unlock()}}updatePosition(){if(this._deviceMotion){let t=this.rotationFromMotion(this._deviceMotion.alpha,this._deviceMotion.beta,this._deviceMotion.gamma);this._worldMatrix=new this.pc.Mat4().setTRS(new this.pc.Vec3(0,0,0),t,new this.pc.Vec3(1,1,1)),this.matrixFromDiveceMotion=this._worldMatrix.clone()}else this._worldMatrix.setIdentity();if(this.trackMode===P.Dof6)this.curARSession.state===1&&(this.app.fire("vioUpdate",{timestamp:Date.now(),data:Array.from(new this.pc.Mat4().set(Array.from(this._curARFrame.camera.viewMatrix)).invert().data)}),this.matrixFromDiveceMotion&&!this.offsetMatrix&&(this.offsetMatrix=new this.pc.Mat4().mul2(this.matrixFromDiveceMotion,new this.pc.Mat4().set(Array.from(this._curARFrame.camera.viewMatrix)))),this.offsetMatrix?this._worldMatrix=new this.pc.Mat4().mul2(this.offsetMatrix,new this.pc.Mat4().set(Array.from(this._curARFrame.camera.viewMatrix)).invert()):this._worldMatrix.set(Array.from(this._curARFrame.camera.viewMatrix)).invert());else{if(this.matrixFromDiveceMotion){const t=new this.pc.Mat4().mul2(this.matrixFromDiveceMotion,new this.pc.Mat4().set(Array.from(this._curARFrame.camera.viewMatrix)));if(!this.offsetMatrix)this.offsetMatrix=t;else{const e=new this.pc.Quat().setFromMat4(t),i=new this.pc.Quat().setFromMat4(this.offsetMatrix);e.x*i.x+e.y*i.y+e.z*i.z+e.w*i.w,i.slerp(i,e,1),this.offsetMatrix.setTRS(new this.pc.Vec3,i,new this.pc.Vec3(1,1,1))}}this.inferenceSessionManager?(this._curPosition.lerp(this._curPosition,this._targetPosition,.03),this._worldMatrix.set(Array.from(this._curARFrame.camera.viewMatrix)).invert(),this.offsetMatrix&&(this._worldMatrix=new this.pc.Mat4().mul2(this.offsetMatrix,this._worldMatrix)),this._worldMatrix.data[12]=this._curPosition.x,this._worldMatrix.data[13]=this._curPosition.y,this._worldMatrix.data[14]=this._curPosition.z,this.app.fire("inertailUpdate",{timestamp:Date.now(),data:Array.from(this._worldMatrix.data)})):this.pdrSystem&&(this.pdrSystem.updateWithExternalRotation(new this.pc.Quat().setFromMat4(this._worldMatrix)),this._worldMatrix=this.pdrSystem.getLocalPose())}this._projectMatrix.set(Array.from(this._curARFrame.camera.getProjectionMatrix(this._near,this._far)))}destroy(){this.pdrSystem&&(this.pdrSystem.destroy(),this.pdrSystem=null),this.inferenceSessionManager&&(this.inferenceSessionManager.destroy(),this.inferenceSessionManager=null),this.sensors&&(this.sensors.stop(),this.sensors=null),this.curARSession&&(this.curARSession.destroy(),this.curARSession=null),this.yuv&&(this.yuv.destroy(),this.yuv=null),this._bgMaterial&&(this._bgMaterial.destroy(),this._bgMaterial=null),this._curARFrame=null,this._cameraCanvas3d=null,this._cameraCanvasGl=null}pause(){!this.curARSession||(this._frameRequestId&&this.curARSession.cancelAnimationFrame(this._frameRequestId),this.curARSession.stop(),this.yuv.clearGL(),this.app.xr=null,this.app.tick())}resume(){!this.curARSession||this.curARSession.start(t=>{t&&I.error("vksession start error:",t),this.app.xr.session||(I.info("\u5173\u95ED App3d \u81EA\u52A8\u5237\u65B0"),this.app.xr={session:{requestAnimationFrame:()=>{}},end:()=>{},destroy:()=>{}});const e=()=>{this._frameRequestId=this.curARSession.requestAnimationFrame(e),this.app.tick()};e()})}onShow(){this.resume()}onHide(){this.pause()}getBackgroundMaterial(){if(this._bgMaterial)return this._bgMaterial;{const e=this.app.graphicsDevice,i=["attribute vec3 a_position;","varying vec2 v_texCoord;","void main() {","    gl_Position = vec4(a_position.xy,1.0, 1.0);","    v_texCoord = a_position.xy * 0.5 + 0.5;","}"].join(`
`),s=[`precision ${e.precision} float;`,"uniform sampler2D rgba_texture;","varying vec2 v_texCoord;","void main() {","gl_FragColor = texture2D(rgba_texture, v_texCoord);","}"].join(`
`);return this._bgShader=new this.pc.Shader(e,{attributes:{a_position:this.pc.SEMANTIC_POSITION},vshader:i,fshader:s}),this._bgMaterial=new this.pc.Material,this._bgMaterial.shader=this._bgShader,this._bgMaterial.depthTest=!1,this._bgMaterial.depthWrite=!1,this._bgMaterial.update(),this._bgMaterial}}rotationFromMotion(t,e,i){[t,e,i]=[t,e,-i];let[s,a,n]=[e,t,i].map(v=>Math.PI/180*v),[o,l,h]=[s,a,n].map(v=>Math.cos(v/2)),[c,m,d]=[s,a,n].map(v=>Math.sin(v/2)),g=new this.pc.Quat(c*l*h+o*m*d,o*m*h-c*l*d,o*l*d-c*m*h,o*l*h+c*m*d),f=new this.pc.Quat(-Math.sqrt(.5),0,0,Math.sqrt(.5));return g.mul(f)}}Qt.supportTrackMode=null,Qt.arBaseMode=Q.VKSession;class lr{constructor(t,e){this.camera={intrinsics:null,viewMatrix:null,transfrom:null},this.timestamp=t.timestamp,this.width=t.width,this.height=t.height,this.rgbaBuffer=t.data,this.camera.transfrom=e}}class Te{constructor(t,e,i){this._cameraCtxIntervalId=null,this.pc=t,this.app=e,this.curARSession=i,this._worldMatrix=new t.Mat4,this._projectMatrix=new t.Mat4,this._textureProject=new t.Mat4,this._near=.1,this._far=1e3,this._viewWidth=this.app.graphicsDevice.canvas.width,this._viewHeight=this.app.graphicsDevice.canvas.height;let s=this._viewWidth/this._viewHeight,a=70;this._projectMatrix=this.perspectiveMatrix(a,s,this._near,this._far),tt.instance.getCalibData().then(n=>{this._calibData=n}),this._curPosition=new this.pc.Vec3,this._targetPosition=new this.pc.Vec3}create(t,e,i){if(this.trackMode=t.trackMode,console.log("\u4F7F\u7528\uFF1A",P[this.trackMode],this.trackMode),this.sensors=new ni,this.sensors.start(),this.sensors.on("orientationUpdate",s=>{this._deviceMotion=s},this),this.trackMode==P.Dof5){this.inferenceSessionManager=ge.instance,this.inferenceSessionManager.init(this.pc,this.sensors);try{this.inferenceSessionManager.loadModel().then(()=>{this.inferenceSessionManager.startInference(),console.log("\u542F\u7528\u60EF\u5BFC")}),this.inferenceSessionManager.on("positionUpdate",s=>{this._targetPosition||(this._targetPosition=new this.pc.Vec3),this._targetPosition.set(s[0],0,-s[1])},this)}catch(s){console.error("\u52A0\u8F7DNN\u6A21\u578B\u5931\u8D25",s),this.inferenceSessionManager.destroy(),this.inferenceSessionManager=null,this.pdrSystem=new Ee(this.pc)}}this.trackMode==P.Dof3&&(this.pdrSystem=new Ee(this.pc)),this.dataRecoder=new Wi,this.dataRecoder.app=this.app,this.dataRecoder.sensors=this.sensors,this.dataRecoder.inferenceSessionManager=this.inferenceSessionManager,e()}start(t){if(!this.curARSession){I.error("\u76F8\u673A\u4F1A\u8BDD\u5BF9\u8C61\u4E0D\u5B58\u5728");return}if(this._running){t&&t();return}this.app.xr.session||(I.info("\u5173\u95ED App3d \u81EA\u52A8\u5237\u65B0"),this.app.xr={session:{requestAnimationFrame:()=>{}},end:()=>{},destroy:()=>{}}),this._cameraFrameLitener=this.curARSession.onCameraFrame(e=>{this._cameraFrame={timestamp:Date.now()/1e3,deviceMotion:{...this._deviceMotion},...e},this.app.tick()}),this._cameraFrameLitener.start(),this._running=!0,t&&t()}update(){if(this._cameraParams||(this._calibData?this._cameraParams=ft.createFromCalibData(this._calibData,0,this._cameraFrame.width,this._cameraFrame.height):this._cameraParams=ft.createDefault(this._cameraFrame.width,this._cameraFrame.height,this._cameraFrame.height,0)),this._cameraFrame){let t=new this.pc.Quat;this._cameraFrame.deviceMotion&&this.trackMode>=P.Dof3&&(t=this.rotationFromMotion(this._cameraFrame.deviceMotion.alpha,this._cameraFrame.deviceMotion.beta,this._cameraFrame.deviceMotion.gamma)),this.inferenceSessionManager&&this._targetPosition?(this._curPosition.lerp(this._curPosition,this._targetPosition,.03),this._worldMatrix=new this.pc.Mat4().setTRS(this._curPosition,t,new this.pc.Vec3(1,1,1)),this.app.fire("inertailUpdate",{timestamp:Date.now(),data:Array.from(this._worldMatrix.data)})):this.pdrSystem?(this.pdrSystem.updateWithExternalRotation(t),this._worldMatrix=this.pdrSystem.getLocalPose()):this._worldMatrix=new this.pc.Mat4().setTRS(new this.pc.Vec3(0,0,0),t,new this.pc.Vec3(1,1,1)),this._curARFrame=new lr(this._cameraFrame,this._worldMatrix.data),ot.instance.clsClient&&ot.instance.clsClient.updateFrame(this._curARFrame)}}destroy(){this._cameraFrame=null,this._cameraFrameLitener.stop(),this.curARSession=null,this.pdrSystem&&(this.pdrSystem.destroy(),this.pdrSystem=null),this.inferenceSessionManager&&(this.inferenceSessionManager.destroy(),this.inferenceSessionManager=null),this.sensors&&(this.sensors.stop(),this.sensors=null),this._cameraCtxIntervalId!=null&&clearInterval(this._cameraCtxIntervalId)}pause(){!this._running||(this._cameraFrameLitener.stop(),this._cameraFrameLitener=null,this.curARSession=null,this.app.xr=null,this.app.tick(),this._running=!1,this._cameraCtxIntervalId!=null&&clearInterval(this._cameraCtxIntervalId))}resume(){if(!this._running){if(!this.curARSession){this._cameraCtxIntervalId=setInterval(()=>{console.log("\u7B49\u5F85\u76F8\u673A\u4F1A\u8BDD\u5BF9\u8C61",this.curARSession),this.curARSession&&(clearInterval(this._cameraCtxIntervalId),this._cameraCtxIntervalId=null,this.resume())},66);return}this._cameraFrameLitener=this.curARSession.onCameraFrame(t=>{this._cameraFrame={timestamp:Date.now()/1e3,deviceMotion:{...this._deviceMotion},...t},this.app.tick()}),this._cameraFrameLitener.start(),wx.startDeviceMotionListening({interval:"game"}),this._running=!0}}onShow(){this.resume()}onHide(){this.pause()}getBackgroundMaterial(){throw new Error("Method not implemented.")}rotationFromMotion(t,e,i){[t,e,i]=[t,e,-i];let[s,a,n]=[e,t,i].map(v=>Math.PI/180*v),[o,l,h]=[s,a,n].map(v=>Math.cos(v/2)),[c,m,d]=[s,a,n].map(v=>Math.sin(v/2)),g=new this.pc.Quat(c*l*h+o*m*d,o*m*h-c*l*d,o*l*d-c*m*h,o*l*h+c*m*d),f=new this.pc.Quat(-Math.sqrt(.5),0,0,Math.sqrt(.5));return g.mul(f)}perspectiveMatrix(t,e,i,s){let a=1/Math.tan(t*Math.PI/360),n=1/(i-s),o=new this.pc.Mat4;return o.data.set([a/e,0,0,0,0,a,0,0,0,0,(s+i)*n,-1,0,0,2*s*i*n,0]),o}}class cr extends ke{constructor(t,e,i){super(),this._imageLongsideLength=mt.Normal,this._deviceOrientation=ht.Portrait,this._legacyBlockServiceFlag=!1,this._vkframe=null,this.captureCanvas=null,this.captureCTX=null,this._calibData=null,this._imageLongsideLength=e,this._deviceOrientation=i,this._arSessionCtrl=t,(()=>new Promise((a,n)=>{this.captureCanvas=wx.createOffscreenCanvas({type:"2d",width:480,height:640});const o=setInterval(()=>{if(this.captureCanvas){this.captureCTX=this.captureCanvas.getContext("2d"),clearInterval(o),a(null);return}console.warn("try create capture canvas"),this.captureCanvas=wx.createOffscreenCanvas({type:"2d",width:480,height:640})},60)}))(),tt.instance.getCalibData().then(a=>{this._calibData=a})}set imageLongsideLength(t){if(t!=mt.Small&&t!=mt.Normal&&t!=mt.Big){console.error(`Invalid imageLongsideLength : ${t}; It must be 640 or 960 or 1280`);return}this._imageLongsideLength=t}initialize(){this._initFlag=!0}dispose(){this._onFrameInput.dispose(),this.captureCanvas=null,this.captureCTX=null,this._initFlag=!1}onLegacyBlockService(){this._legacyBlockServiceFlag=!0}onFrameUpdate(...t){if(this._vkframe==null)return;let e=null;this._arSessionCtrl.trackMode==P.Dof6?e=Y.SixDof:this._arSessionCtrl.trackMode==P.Dof5||this._arSessionCtrl.trackMode==P.Dof3?e=Y.ThreeDofRotOnly:this._arSessionCtrl.trackMode==P.Camera&&(e=Y.ZeroDof);const i=Gt.NotTracking,s=this._vkframe.width,a=this._vkframe.height,n=1;this._imageLongsideLength=Math.max(s,a),(this.captureCanvas.width!=s*n||this.captureCanvas.height!=a*n)&&(this.captureCanvas.width=s*n,this.captureCanvas.height=a*n);const o=this._vkframe.camera.intrinsics;let l,h="";if(o){h="\u5FAE\u4FE1\u7CFB\u7EDF\u76F8\u673A\u5185\u53C2";const g={width:s,height:a,fx:o[4],fy:o[0],cx:o[7],cy:o[6]};l=ft.createFromCalibData(g,this._deviceOrientation,s*n,a*n),l.cameraOrientation=0}else this._calibData?(h="easyar \u6807\u6CE8\u76F8\u673A\u5185\u53C2",l=ft.createFromCalibData(this._calibData,this._deviceOrientation,s*n,a*n)):(h="\u9ED8\u8BA4\u76F8\u673A\u5185\u53C2",l=ft.createDefault(s*n,a*n,this._imageLongsideLength,this._deviceOrientation)),l.cameraOrientation=0;const c=this._vkframe.timestamp;let m=new K().setFromEulerAngles(0,0,-l.getImageOrientation()),d=null;if(e==Y.SixDof||e==Y.ThreeDofRotOnly){let g=new K().set(this._vkframe.camera.transfrom);d=new K().mul2(g,m)}else e==Y.ZeroDof&&(d=null);if(this._imageFlag){I.log(h),I.log("\u5F53\u524D\u6A21\u5F0F\uFF1A",Y[e]),this._imageFlag=!1;const g=this._onFrameInput,f=this.captureCanvas,v=this._vkframe.rgbaBuffer;let S=this.captureCTX,C=f.createImageData(new Uint8ClampedArray(v),this.captureCanvas.width,this.captureCanvas.height);S.putImageData(C,0,0),new Promise(R=>{setTimeout(()=>{R(f.toDataURL("image/jpeg",.7))})}).then(R=>{const N=new Vt(i,e,l,c,d,R);g.fire(N)})}else{const g=new Vt(i,e,l,c,d);this._onFrameInput.fire(g)}}onDeviceOrientationChange(t){if(t!=ht.Portrait&&t!=ht.PortraitUpsideDown&&t!=ht.LandscapeLeft&&t!=ht.LandscapeRight)throw new Error(`Invalid deviceOrientation : ${t}; It must be 0, 90, 180 or 270`);this._deviceOrientation=t}setVKFrame(t){this._vkframe=t}}class hr extends ke{constructor(t,e,i){super(),this._imageLongsideLength=mt.Normal,this._deviceOrientation=ht.Portrait,this._legacyBlockServiceFlag=!1,this._vkframe=null,this._capturePixelRatio=null,this._imageLongsideLength=e,this._deviceOrientation=i,this._arSessionCtrl=t}set imageLongsideLength(t){if(t!=mt.Small&&t!=mt.Normal&&t!=mt.Big){console.error(`Invalid imageLongsideLength : ${t}; It must be 640 or 960 or 1280`);return}this._imageLongsideLength=t}initialize(){this._initFlag=!0}dispose(){this._onFrameInput.dispose(),this._initFlag=!1}onLegacyBlockService(){this._legacyBlockServiceFlag=!0}onFrameUpdate(...t){if(this._vkframe==null)return;let e=null;this._arSessionCtrl.trackMode==P.Dof6?e=Y.SixDof:this._arSessionCtrl.trackMode==P.Dof3?e=Y.ThreeDofRotOnly:this._arSessionCtrl.trackMode==P.Camera&&(e=Y.ZeroDof);const i=this._vkframe.camera.trackingState==="normal"?Gt.Tracking:Gt.NotTracking,s=this._vkframe.width,a=this._vkframe.height;this._capturePixelRatio||(this._capturePixelRatio=this._imageLongsideLength/this._vkframe.width);const n=this._capturePixelRatio,o=this._vkframe.camera.intrinsics;let l;if(o){const d={width:a,height:s,fx:o[4],fy:o[0],cx:o[7],cy:o[6]};l=ft.createFromCalibData(d,this._deviceOrientation,a*n,s*n),l.cameraOrientation=0}const h=Date.now()/1e3;let c=new K().setFromEulerAngles(0,0,-l.getImageOrientation()),m=null;if(e==Y.SixDof||e==Y.ThreeDofRotOnly){let d=new K().set(this._arSessionCtrl._worldMatrix.data);m=new K().mul2(d,c)}else e==Y.ZeroDof&&(m=null);if(this._imageFlag){this._imageFlag=!1;const d=this._onFrameInput,g=new Vt(i,e,l,h,m,null,this._vkframe.capturedImage);d.fire(g)}else{const d=new Vt(i,e,l,h,m);this._onFrameInput.fire(d)}}onDeviceOrientationChange(t){if(t!=ht.Portrait&&t!=ht.PortraitUpsideDown&&t!=ht.LandscapeLeft&&t!=ht.LandscapeRight)throw new Error(`Invalid deviceOrientation : ${t}; It must be 0, 90, 180 or 270`);this._deviceOrientation=t}setVKFrame(t){this._vkframe=t}}class ur extends Li{constructor(){super(),this.app=null}start(){}stop(){this._currentProximityLocation=null}setProximityLocation(t){this._currentProximityLocation=t,this._onProximityUpdate.fire(t),this.app.fire("beaconUpdate",{timestamp:t.timestamp*1e3,data:[t.x,t.y,t.z]})}dispose(){var t;this.stop(),(t=this._onProximityUpdate)==null||t.dispose()}}class mr extends de{constructor(t,e,i,s){super(),this._arAssembly=null,this._serviceHandler=null,this._isReady=!1,this._changeDeviceOrientation=new Dt.Emitter,this._frameSource=null,this._worldMatrix=null,this._currentBlockId=null,this._currentBlockName=null,this._stoped=!0,this._paused=!0,this._arSessionCtrl=null,this.mocProximityLocationProvider=new ur,this.config=null,I.info("\u521B\u5EFA EasyARSession"),this.config=e,this._arSessionCtrl=t;let a=null;t instanceof Qt?(I.info("\u521B\u5EFA VKFrameSource"),a=new rr(t,i.imageLongsideLength,i.deviceOrientation)):t instanceof Te?(I.info("\u521B\u5EFA CameraFrameSource"),a=new cr(t,i.imageLongsideLength,i.deviceOrientation)):t instanceof te&&(I.info("\u521B\u5EFA ARsessionFrameSource"),a=new hr(t,i.imageLongsideLength,i.deviceOrientation)),this.mocProximityLocationProvider.app=t.app,this._frameSource=a;let n=null;if(s=="block")this._serviceHandler=new Se(e,At.Wechat),n=new Qe.WxBlockTracker(this._serviceHandler,Ht.Accelerometer,this.mocProximityLocationProvider),I.info("\u521B\u5EFA WxBlockTracker");else if(s=="landmark")this._serviceHandler=new Si(e,At.Wechat),n=new Qe.WxLandmarkTracker(this._serviceHandler,Ht.Accelerometer,this.mocProximityLocationProvider),I.info("\u521B\u5EFA WxLandmarkTracker");else{I.error(`Invalid service type: ${s}`);return}this._arAssembly=new Pi,this._arAssembly.assemble(a,n),this._intergrate(a,n,s)}initialize(){return new Promise(async(t,e)=>{this._isReady||(this._serviceHandler.initFlag||(I.info("\u521D\u59CB\u5316 serviceHandler"),await this._serviceHandler.initialize()),this._arAssembly.isReady||(I.info("\u521D\u59CB\u5316 arAssembly"),this._arAssembly.initialize()),this._isReady=!0,this.fire("clsLoaded",this)),t()})}dispose(){var t,e;this._changeDeviceOrientation.dispose(),(t=this._serviceHandler)==null||t.reset(),(e=this._arAssembly)==null||e.dispose(),this._isReady=!1}pause(){!this._checkArComponents()||(this._paused=!0,this._arAssembly.tracker.toggleContinuousLocalization(!1))}start(){!this._checkArComponents()||(this._stoped=!1,this._paused=!1,this._arAssembly.tracker.start(),this._arAssembly.tracker.toggleContinuousLocalization(!0))}resume(){!this._checkArComponents()||(this._paused=!1,this._arAssembly.tracker.toggleContinuousLocalization(!0))}_stop(){!this._checkArComponents()||(this._stoped=!0,this._currentBlockId=null,this._worldMatrix=null,this._arAssembly.tracker.stop())}setDeviceOrientation(t){this._changeDeviceOrientation.fire(t)}setProximityLocation(t){this.mocProximityLocationProvider.setProximityLocation(t)}setRequestConfig(t){if(!!this._checkArComponents())try{this._arAssembly.tracker.serviceType=="block"?this._serviceHandler.setRequestConfig(t):this._arAssembly.tracker.serviceType=="landmark"&&this._serviceHandler.setRequestConfig(t)}catch(e){this.fire("localize_error",e)}}setContinuousLocalization(t){!this._checkArComponents()||this._arAssembly.tracker.toggleContinuousLocalization(t)}setLocalizationOnly(t){!this._checkArComponents()||this._arAssembly.tracker.toggleLocalizationOnly(t)}setStablize(t){!this._checkArComponents()||this._arAssembly.tracker.toggleStablize(t)}setGeoLocationInput(t,e){if(!!this._checkArComponents()){if(this._arAssembly.tracker.serviceType=="block"){const i=this._arAssembly.tracker;try{i.setGeoLocationInput(t,e),t=="Simulator"&&e&&(!e.longitude||!e.latitude)&&this.fire("localize_error","Invalid Simulator GPS: "+JSON.stringify(e))}catch(s){this.fire("localize_error","Fail to set geo location input mode to "+t+" because of "+s.message)}return}else if(this._arAssembly.tracker.serviceType=="landmark"){const i=this._arAssembly.tracker;try{t=="Simulator"&&(!e||!e.longitude||!e.latitude)&&this.fire("localize_error","Invalid Simulator GPS: "+JSON.stringify(e)),i.setGeoLocationInput(t,e)}catch(s){this.fire("localize_error","Fail to set geo location input mode to "+t+" because of "+s.message)}return}}}switchBlockService(t){var i;const e=this._serviceHandler;try{this._stop(),this.fire("switchBlockService",t.blockClsConfig),e.switchBlockService(t.blockClsConfig).then(()=>{var s;(s=t.success)==null||s.call(t)}).catch(s=>{throw s})}catch(s){this.fire("localize_error",s),(i=t.fail)==null||i.call(t,s.message)}}localizeOnce(){if(!!this._checkArComponents())return this._arAssembly.tracker.localizeOnce()}async loadAnnotation(t){try{return await this._serviceHandler.getEmaRawData(t)}catch(e){I.error(e)}}recordData(t){return j.getInstance().platform||(j.getInstance().platform=At.Wechat),j.getInstance().isRecordingData&&!t?(j.getInstance().isRecordingData=!1,j.getInstance().preserveRequest()):(!j.getInstance().isRecordingData&&t&&(j.getInstance().isRecordingData=!0),"")}async onFrameUpdate(t){this._isReady&&this._arAssembly.onFrameUpdate()}setPriorBlockId(t){!this._arAssembly.tracker||this._arAssembly.tracker.setPriorBlockIds(t)}_intergrate(t,e,i){if(Dt.makeSubscription(this._changeDeviceOrientation.event,s=>{t.onDeviceOrientationChange(s)}),Dt.makeSubscription(e.errorEvent,s=>{I.error("localize_error",s),this.fire("localize_error",s)}),Dt.makeSubscription(e.blockLocalizedEvent,s=>{this._currentBlockId=s.blockId,this._currentBlockName=s.name}),Dt.makeSubscription(e.updateCameraTransformEvent,s=>{this._stoped||(this._worldMatrix=new Float32Array(s))}),i=="block"){const s=e;Dt.makeSubscription(s.geoLocationStatus,a=>{}),this._makeBlockSubscriptions(s)}else if(i=="landmark"){const s=e;this._makeLandmarkSubscriptions(s)}else I.error(`Invalid service type: ${i}`)}_makeBlockSubscriptions(t){Dt.makeSubscription(t.localizationResponseEvent,i=>{this._stoped||(I.info("clsresult",{...i,localizationStatus:rt[i.localizationStatus]}),i.localizationStatus==rt.Found?this.fire("localize_sucess",{statusCode:0,result:i.blockInstances,clsresult:i}):this.fire("localize_fail",{statusCode:-1,result:i.blockInstances,clsresult:i}))});const e=this._serviceHandler;Dt.makeSubscription(e.switchBlockServiceEvent,()=>{t.stop(),this._paused||this.start()})}_makeLandmarkSubscriptions(t){Dt.makeSubscription(t.localizationResponseEvent,e=>{I.log("clsresult",e),this._arSessionCtrl instanceof Te||this._arSessionCtrl.curARSession.state==1?e.localizationStatus==rt.Found?this.fire("localize_sucess",{statusCode:0,result:e.blockInstances,clsresult:e}):this.fire("localize_fail",{statusCode:-1,result:e.blockInstances,clsresult:e}):this.fire("localize_error",{msg:"arSession not ready",state:this._arSessionCtrl.curARSession.state})})}_checkArComponents(){return!(!this._arAssembly||!this._arAssembly.tracker)}}class se extends mr{constructor(t,e){const i=t.serviceType==="landmark"?"https://landmark-api.easyar.com":"https://clsv3-api.easyar.com";super(e,{apiKey:t.apiKey,apiSecret:t.apiSecret,appId:t.clsAppId,serverAddress:t.serverAddress||i},new si(mt.Normal,0,!1),t.serviceType||"block"),this.clsdata={},this._offsetMatrix=null,super.initialize().then(()=>{t.arannotationId?super.loadAnnotation(t.arannotationId).then(s=>{this.clsdata.ema=s,this.fire("emaLoaded",s)}):this.fire("emaLoaded",null),t.autoStart?super.start():super._stop()})}get currentBlockId(){return this._currentBlockId}get currentBlockName(){return this._currentBlockName}get offsetMatrix(){return this._offsetMatrix}get worldMatrix(){return!this._currentBlockId||this._stoped?null:this._worldMatrix}updateFrame(t){this._frameSource&&(this._frameSource.setVKFrame(t),super.onFrameUpdate(.3))}setGPS(t){}clearFusion(){I.log("clearFusion \u88AB\u8C03\u7528\uFF0C\u4E0D\u505A\u4EFB\u4F55\u5904\u7406")}start(t){this._stoped?super.start():super.resume()}stop(){super.pause()}getPoseInBlock(t){return I.log("getPoseInBlock \u88AB\u8C03\u7528\uFF0C\u8FD4\u56DE\u7A7A\u6570\u7EC4"),new Float32Array}setConfig(t,e){super.switchBlockService({blockClsConfig:{apiKey:t.apiKey,apiSecret:t.apiSecret,appId:t.clsAppId,serverAddress:t.serverAddress||"https://clsv3-api.easyar.com"},success:()=>{t.arannotationId?super.loadAnnotation(t.arannotationId).then(i=>{this.clsdata.ema=i,this.fire("emaLoaded",i)}):(this.clsdata.ema=null,this.fire("emaLoaded",null))}})}destroy(){super.dispose()}}typeof wx<"u"&&!wx.isMy?$i(er):typeof my<"u"&&(Gs(),$i(tr));class re{constructor(t,e){this.pc=null,this.app=null,this._currentActiveBlockId=null,this._update=null,this.pc=t,this.app=e,this.blockTransformMap=new Map,this.blockEntityMap=new Map,this.app.on("rejesterBlock",(s,a)=>{this.rigesterBlock(s,a)});let i=0;this.app.on("update",this._update=s=>{this._updateVIOBlocks(),i+=s,i>5&&(i=0,this._checkUnsedBlock())})}set currentAcriveBlockId(t){this._currentActiveBlockId!=t&&(this._currentActiveBlockId!=null&&this._setBlockActive(this._currentActiveBlockId,!1),this._currentActiveBlockId=t,this._currentActiveBlockId!=null&&this._setBlockActive(this._currentActiveBlockId,!0),this.app.fire("activeBlockChange",this._currentActiveBlockId))}get currentAcriveBlockId(){return this._currentActiveBlockId}setBlockInfo(t){I.log("[BlockController]:setBlockInfo:",t);for(let e=0;e<t.length;e++){let i=t[e];if(i.keepTransform){let s=i.id,a=this._mackTransformMat(i.transform);if(this.blockTransformMap.set(s,a),this.blockEntityMap.has(s)){let n=this.blockEntityMap.get(s);for(let o=0;o<n.length;o++)this._applyTransform(a,n[o]),I.log("[BlockController]:---------------------------"),I.log(`apply block Transform,entity:${n[o].name}`),I.log(`position:${n[o].getPosition().toString()}`),I.log(`rotation:${n[o].getRotation().toString()}`),I.log(`scale:${n[o].getLocalScale().toString()}`),I.log("[BlockController]:---------------------------")}}}}getBlockTransform(t){return this.blockTransformMap.has(t)||this.blockTransformMap.set(t,new this.pc.Mat4),this.blockTransformMap.get(t)}rigesterBlock(t,e){I.log(`[BlockController]:regesterBlock,id:${t},entity:${e.name}`),this.blockEntityMap.has(t)||this.blockEntityMap.set(t,[]),this.blockEntityMap.get(t).push(e),this._applyTransform(this.getBlockTransform(t),e),I.log("[BlockController]:---------------------------"),I.log(`apply block Transform,entity:${e.name}`),I.log(`position:${e.getPosition().toString()}`),I.log(`rotation:${e.getRotation().toString()}`),I.log(`scale:${e.getLocalScale().toString()}`),I.log("[BlockController]:---------------------------"),this.currentAcriveBlockId==t||t=="VIO"?e.enabled=!0:e.enabled=!1}_updateVIOBlocks(){if(this.blockEntityMap.has("VIO")){let t=this.blockEntityMap.get("VIO");for(let e=0;e<t.length;e++){let i=t[e],s=ot.instance.vioToClsMatrix;this._applyTransform(s,i)}}}_applyTransform(t,e){e.setPosition(t.getTranslation()),e.setRotation(new this.pc.Quat().setFromMat4(t)),e.setLocalScale(t.getScale())}destroy(){this.blockTransformMap.clear(),this.blockEntityMap.clear(),this.app.off("rejesterBlock"),this.app.off("update",this._update)}_checkUnsedBlock(){let t=this.blockEntityMap.keys();for(let e in t){let i=e,s=this.blockEntityMap.get(i);s=s.filter(a=>a.parent!=null),this.blockEntityMap.set(i,s)}}local2worldByBlockId(t,e){if(this.blockTransformMap.has(t)){let i=this.blockTransformMap.get(t);return new this.pc.Mat4().mul2(i,e)}else return e}world2localByBlockId(t,e){if(this.blockTransformMap.has(t)){let i=this.blockTransformMap.get(t);return new this.pc.Mat4().mul2(i.clone().invert(),e)}else return e}transforAnnotations(t){!t||t.forEach(e=>{if(e.type!="node")return;e.localTransform||(e.localTransform=JSON.parse(JSON.stringify(e.transform)));let i=e.localTransform,s=this._mackTransformMat(i),a=this.local2worldByBlockId(e.parent.id,s),{x:n,y:o,z:l}=a.getTranslation();if(e.transform.position={x:n,y:o,z:l},e.geometry=="cube"){let{x:h,y:c,z:m,w:d}=new this.pc.Quat().setFromMat4(a);e.transform.rotation={x:h,y:c,z:m,w:d};let{x:g,y:f,z:v}=a.getScale();e.transform.scale={x:g,y:f,z:v}}})}_setBlockActive(t,e){if(this.blockEntityMap.has(t)){let i=this.blockEntityMap.get(t);for(let s=0;s<i.length;s++)i[s].enabled=e}}_mackTransformMat(t){let e=new this.pc.Mat4,i=new this.pc.Vec3(t.position.x,t.position.y,t.position.z),s=new this.pc.Quat,a=new this.pc.Vec3(1,1,1);return t.rotation&&(s=new this.pc.Quat(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w)),t.scale&&(a=new this.pc.Vec3(t.scale.x,t.scale.y,t.scale.z)),e.setTRS(i,s,a),e}}const fr={vk6Dof:["ABR-AL60"],vk5Dof:[],vk3Dof:[],camera5Dof:[],camera3Dof:["MIX","SM-G9550","OPPO R9m"],camera0Dof:[]};function dr(r,t){var e,i,s,a,n,o;return I.log("\u5F00\u59CB\u5224\u5B9A\u9ED1\u540D\u5355",t,r),((e=r.camera0Dof)==null?void 0:e.length)>0&&r.camera0Dof.includes(t)?(I.log("\u89E6\u53D1\u9ED1\u540D\u5355 camera0Dof"),{arBaseMode:Q.BaseCamera,arTrackMode:P.None}):((i=r.camera3Dof)==null?void 0:i.length)>0&&r.camera3Dof.includes(t)?(I.log("\u89E6\u53D1\u9ED1\u540D\u5355 camera3Dof,\u9700\u964D\u7EA7\u5230 camera0Dof"),{arBaseMode:Q.BaseCamera,arTrackMode:P.Camera}):((s=r.camera5Dof)==null?void 0:s.length)>0&&r.camera5Dof.includes(t)?(I.log("\u89E6\u53D1\u9ED1\u540D\u5355 camera5Dof,\u9700\u964D\u7EA7\u5230 camera3Dof"),{arBaseMode:Q.BaseCamera,arTrackMode:P.Dof3}):((a=r.vk3Dof)==null?void 0:a.length)>0&&r.vk3Dof.includes(t)?(I.log("\u89E6\u53D1\u9ED1\u540D\u5355 vk3Dof,\u9700\u964D\u7EA7\u5230 camera5Dof"),{arBaseMode:Q.BaseCamera,arTrackMode:P.Dof5}):((n=r.vk5Dof)==null?void 0:n.length)>0&&r.vk5Dof.includes(t)?(I.log("\u89E6\u53D1\u9ED1\u540D\u5355 vk5Dof,\u9700\u964D\u7EA7\u5230 vk3Dof"),{arBaseMode:Q.VKSession,arTrackMode:P.Dof3}):((o=r.vk6Dof)==null?void 0:o.length)>0&&r.vk6Dof.includes(t)?(I.log("\u89E6\u53D1\u9ED1\u540D\u5355 vk6Dof,\u9700\u964D\u7EA7\u5230 vk3Dof"),{arBaseMode:Q.VKSession,arTrackMode:P.Dof5}):null}const ae=class{constructor(){this.logger=I,this.pc=null,this.app=null,this.clsClient=null,this._initialized=!1,this._arCtrl=null,this._arSdk=null,this.blockController=null,this._blockInfo=null,this._isrecoding=!1}static get instance(){return this._instance==null&&(this._instance=new ae,this._instance.logger=I),this._instance}get sdk(){return this._arSdk}get arCtrl(){return this._arCtrl}get arSession(){return this._arCtrl.curARSession}get arFrame(){return this._arCtrl._curARFrame}get worldMatrix(){return this.clsClient?this.clsClient.worldMatrix?this.blockController?this.blockController.local2worldByBlockId(this.clsClient.currentBlockId,new this.pc.Mat4().set(Array.from(this.clsClient.worldMatrix))):new this.pc.Mat4().set(Array.from(this.clsClient.worldMatrix)):null:this._arCtrl._worldMatrix}get blockMatrix(){return this.clsClient?new this.pc.Mat4().set(Array.from(this.clsClient.worldMatrix)):this._arCtrl._worldMatrix}get vioMatrix(){return this._arCtrl._worldMatrix}get vioToClsMatrix(){return this.clsClient?this.worldMatrix?new this.pc.Mat4().mul2(this.worldMatrix.clone(),this.vioMatrix.clone().invert()):new this.pc.Mat4:new this.pc.Mat4}get projectMatrix(){return this._arCtrl._projectMatrix}get bgMaterial(){return this._arCtrl&&this._arCtrl.getBackgroundMaterial()}async create(r,t,e,i,s){if(this._initialized)return;this.pc=r,this.app=t,this._initialized=!0;let a=await this.queryARSupport(!1);if(e.sdk?e.sdk<a.arBaseMode&&I.warn(`\u5224\u5B9A\u7CFB\u7EDF\u652F\u6301 ARBaseMode \u4E3A${Q[a.arBaseMode]}\uFF0C\u5F53\u524D\u4F20\u5165\u6A21\u5F0F\u4E3A${Q[e.sdk]}\uFF0C\u8BF7\u68C0\u67E5\u4F20\u5165\u7684 sdk \u662F\u5426\u6B63\u786E`):e.sdk=a.arBaseMode,e.sdk==Q.BaseCamera&&!e.cameraContext){I.error("\u8BF7\u4F20\u5165 cameraContext");return}return e.trackMode?e.trackMode>a.arTrackMode&&I.warn(`\u5224\u5B9A\u7CFB\u7EDF\u652F\u6301 ARTrackMode \u4E3A${P[a.arTrackMode]}\uFF0C\u5F53\u524D\u4F20\u5165\u6A21\u5F0F\u4E3A${P[e.trackMode]}\uFF0C\u8BF7\u68C0\u67E5\u4F20\u5165\u7684 trackMode \u662F\u5426\u6B63\u786E`):e.trackMode=a.arTrackMode,this._arSdk=e.sdk,e.sdk==Q.ARSession?(this._arCtrl=new te(r,t),e.useCls&&e.clsConfig&&(this.clsClient=new se(e.clsConfig,this._arCtrl),this.blockController=new re(r,t),this._blockInfo&&this.blockController.setBlockInfo(this._blockInfo))):e.sdk==Q.EasyAR?(this._arCtrl=new _t(r,t),e.useCls&&e.clsConfig&&(this.clsClient=new ii(e.clsConfig),this.blockController=new re(r,t),this._blockInfo&&this.blockController.setBlockInfo(this._blockInfo))):e.sdk==Q.VKSession?(this._arCtrl=new Qt(r,t,e.canvas),this._arCtrl.trackMode=e.trackMode,e.useCls&&e.clsConfig&&(this.clsClient=new se(e.clsConfig,this._arCtrl),this.blockController=new re(r,t),this._blockInfo&&this.blockController.setBlockInfo(this._blockInfo))):e.sdk==Q.BaseCamera&&(this._arCtrl=new Te(r,t,e.cameraContext),this._arCtrl.trackMode=e.trackMode,e.useCls&&e.clsConfig&&(I.log("base camera cls"),this.clsClient=new se(e.clsConfig,this._arCtrl),this.blockController=new re(r,t),this._blockInfo&&this.blockController.setBlockInfo(this._blockInfo))),this._arCtrl?(this._arCtrl.create(e,i,s),this._initScripts(r,t),this.app.fire("ARSessionCreated",this._arCtrl)):s&&s(),this.clsClient&&(this.clsClient.on("localize_sucess",(...n)=>{this.blockController&&(this.blockController.currentAcriveBlockId=this.clsClient.currentBlockId),this.app.once("frameend",()=>{this.app.fire("localize_sucess",...n)})},this),this.clsClient.on("localize_fail",(...n)=>{this.app.once("frameend",()=>{this.app.fire("localize_fail",...n)})},this),this.clsClient.on("localize_error",(...n)=>{this.app.once("frameend",()=>{this.app.fire("localize_error",...n)})},this),this.clsClient.on("emaLoaded",(...n)=>{this.blockController&&this.clsClient&&this.clsClient.clsdata&&this.clsClient.clsdata.ema&&this.blockController.transforAnnotations(this.clsClient.clsdata.ema.annotations),this.app.fire("emaLoaded",...n)},this),this.clsClient.on("clsLoaded",(...n)=>{this.app.fire("clsLoaded",...n)},this),this.clsClient.on("switchBlockService",(...n)=>{this.blockController.currentAcriveBlockId=null,this.app.fire("switchBlockService")},this),this.app.fire("clsClientCreated",this.clsClient)),{arBaseMode:this._arSdk,arTrackMode:this._arCtrl.trackMode}}start(r){if(this._arCtrl){const t=()=>{r&&r(),this.app.fire("ARSessionStart",this._arCtrl)};this._arCtrl.start(t),this.app.on("frameupdate",this.update,this),wx.startAccelerometer({interval:"game",success:()=>I.log("\u52A0\u901F\u5EA6\u8BA1\u542F\u52A8\u6210\u529F"),fail:e=>I.warn("\u52A0\u901F\u5EA6\u8BA1\u542F\u52A8\u5931\u8D25",e)})}}update(){this._arCtrl&&this._arCtrl.update()}stop(){this._arCtrl&&(this._arCtrl.pause(),this.app.off("frameupdate",this.update,this)),this.clsClient,this.app.fire("arStop"),wx.stopAccelerometer({success:()=>I.log("\u52A0\u901F\u5EA6\u8BA1\u505C\u6B62\u6210\u529F"),fail:r=>I.log("\u52A0\u901F\u5EA6\u8BA1\u505C\u6B62\u5931\u8D25",r)})}restart(){this._arCtrl&&(this._arCtrl.resume(),this.app.on("frameupdate",this.update,this)),this.clsClient,this.app.fire("arRestart"),wx.startAccelerometer({interval:"game",success:()=>I.log("\u52A0\u901F\u5EA6\u8BA1\u542F\u52A8\u6210\u529F"),fail:r=>I.log("\u52A0\u901F\u5EA6\u8BA1\u542F\u52A8\u5931\u8D25",r)})}onLocalizeSuccess(r,t){if(!this._initialized){I.warn("ARManager not initialized");return}this.app.on("localize_sucess",r,t)}onLocalizeFail(r,t){if(!this._initialized){I.warn("ARManager not initialized");return}this.app.on("localize_fail",r,t)}onLocalizeError(r,t){if(!this._initialized){I.warn("ARManager not initialized");return}this.app.on("localize_error",r,t)}onEmaLoaded(r,t){if(!this._initialized){I.warn("ARManager not initialized");return}this.app.on("emaLoaded",r,t)}destroy(){var r,t,e,i,s;wx.stopAccelerometer({success:()=>I.log("\u52A0\u901F\u5EA6\u8BA1\u505C\u6B62\u6210\u529F"),fail:a=>I.warn("\u52A0\u901F\u5EA6\u8BA1\u505C\u6B62\u5931\u8D25",a)});try{(r=this.app)==null||r.off("frameupdate",this.update,this),(t=this.app)==null||t.off("localize_sucess"),(e=this.app)==null||e.off("localize_fail"),(i=this.app)==null||i.off("localize_error"),(s=this.app)==null||s.off("emaLoaded"),this.clsClient&&this.clsClient.destroy(),this._arCtrl&&this._arCtrl.destroy(),this.blockController&&this.blockController.destroy()}catch(a){I.error(a)}this._arCtrl=null,this._initialized=!1,ae._instance=null}_initScripts(r,t){if(!(this._arCtrl instanceof Qt&&this._arCtrl._cameraRenderMode=="towCanvas")&&!(this._arCtrl instanceof Te)){class i extends r.ScriptType{initialize(){let a=t.scene.layers.getLayerByName("arBg");a||(a=new r.Layer({name:"arBg",opaqueSortMode:r.SORTMODE_NONE,enabled:!0}),t.scene.layers.insert(a,0));let n=ae.instance.bgMaterial;var o=new r.VertexFormat(t.graphicsDevice,[{semantic:r.SEMANTIC_POSITION,components:2,type:r.ELEMENTTYPE_FLOAT32}]),l=new r.VertexBuffer(t.graphicsDevice,o,4,r.BUFFER_STATIC),h=l.lock(),c=new Float32Array(h);c.set([-1,-1,1,-1,-1,1,1,1]),l.unlock();var m=new r.Mesh;m.vertexBuffer=l,m.primitive[0]={type:r.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1};var d=new r.GraphNode,g=new r.MeshInstance(m,n,d),f=new r.Model;f.graph=d,f.meshInstances=[g],this.entity.addComponent("model",{type:"asset",castShadows:!1}),this.entity.model.model=f,this.entity.model.enabled=!0,this.entity.model.layers=[a.id];let v=this.entity.camera.layers.slice(0);v.push(a.id),this.entity.camera.layers=v,this.on("destroy",()=>{this.entity.model&&this.entity.removeComponent("model")})}}r.registerScript(i,"sdsArBg")}class e extends r.ScriptType{constructor(){super(...arguments),this.camera=null,this._triggeredLocalize=!1}initialize(){this.camera=this.entity.camera}update(s){const{worldMatrix:a,vioMatrix:n,projectMatrix:o}=ae.instance;a&&o?(this.entity.setPosition(a.getTranslation()),this.entity.setRotation(new r.Quat().setFromMat4(a)),this.entity.setLocalScale(a.getScale()),ae.instance.reportRecodData("camera",{timestamp:Date.now(),data:Array.from(a.data)}),this.camera.projectionMatrix.set(Array.from(o.data)),this._triggeredLocalize||(this._triggeredLocalize=!0,this.app.fire("firstLocalize"))):n&&o&&(this._triggeredLocalize=!1,this.entity.setPosition(n.getTranslation()),this.entity.setRotation(new r.Quat().setFromMat4(n)),this.entity.setLocalScale(n.getScale()),this.camera.projectionMatrix.set(Array.from(o.data)))}}r.registerScript(e,"sdsArCamera")}setClsConfig(r,t=!0){this.clsClient?this.clsClient.setConfig(r,t):(this._arSdk==Q.ARSession?this.clsClient=new se(r,this._arCtrl):this._arSdk==Q.EasyAR?this.clsClient=new ii(r):this._arSdk==Q.VKSession&&(this.clsClient=new se(r,this._arCtrl)),this.blockController||(this.blockController=new re(this.pc,this.app),this._blockInfo&&this.blockController.setBlockInfo(this._blockInfo)),this.clsClient.on("localize_sucess",(...e)=>{this.blockController&&(this.blockController.currentAcriveBlockId=this.clsClient.currentBlockId),this.app.fire("localize_sucess",...e)},this),this.clsClient.on("localize_fail",(...e)=>{this.app.fire("localize_fail",...e)},this),this.clsClient.on("localize_error",(...e)=>{this.app.fire("localize_error",...e)},this),this.clsClient.on("emaLoaded",(...e)=>{this.blockController&&this.clsClient&&this.clsClient.clsdata&&this.clsClient.clsdata.ema&&this.blockController.transforAnnotations(this.clsClient.clsdata.ema.annotations),this.app.fire("emaLoaded",...e)},this),this.app.fire("clsClientCreated",this.clsClient)),this._arCtrl instanceof _t&&this._arCtrl.setClsConfig(r)}setBlockInfo(r){r.forEach(t=>{t.keepTransform||(t.keepTransform=!0,I.warn(`block ${t.id} keepTransform is false, set to true`))}),this.blockController?(this.blockController.setBlockInfo(r),this.clsClient&&this.clsClient.clsdata&&this.clsClient.clsdata.ema&&this.blockController.transforAnnotations(this.clsClient.clsdata.ema.annotations)):this._blockInfo=r}setProximityLocation(r){this.clsClient&&this.clsClient.setProximityLocation&&this.clsClient.setProximityLocation(r)}startRecodData(){this._isrecoding||(this._isrecoding=!0,this._arCtrl.dataRecoder&&this._arCtrl.dataRecoder.start(),this.clsClient.recordData&&this.clsClient.recordData(!0))}reportRecodData(r,t){this._arCtrl.dataRecoder&&this._arCtrl.dataRecoder.reportData(r,t)}stopRecodData(r=!0,t=!0){if(!this._isrecoding)return;const e={};let i=null;const s=wx.getFileSystemManager();if(this._arCtrl.dataRecoder&&t){const a=this._arCtrl.dataRecoder.stop();Object.assign(e,a)}if(typeof wx<"u"&&this.clsClient.recordData){i=this.clsClient.recordData(!1);const a=s.readFileSync(i,"utf-8"),n=JSON.parse(a);if(!r){const o=n.requestArgs.map(l=>(delete l.base64,l));n.requestArgs=o}Object.assign(e,n)}return i&&s.writeFileSync(i,JSON.stringify(e)),this._isrecoding=!1,{data:e,path:i}}takePhoto(r="buffer"){return new Promise((t,e)=>{tt.instance.isAliPay?this.app.once("frameend",()=>{const i=this.app.graphicsDevice.canvas,s=this.app.graphicsDevice.gl,a=i.width,n=i.height;if(r=="buffer"){const o=new Uint8Array(a*n*4);s.readPixels(0,0,a,n,s.RGBA,s.UNSIGNED_BYTE,o),t([{width:a,height:n,data:this._flip(o,a,n,4)}])}else{const o=i.toDataURL("image/png");t([{width:a,height:n,data:o}])}}):tt.instance.isWeChat&&this.app.once("frameend",()=>{const i=this.app.graphicsDevice.canvas,s=this.app.graphicsDevice.gl,a=this._arCtrl._cameraCanvasGl,n=i.width,o=i.height;if(r=="buffer"){const l=new Uint8Array(n*o*4);if(s.readPixels(0,0,n,o,s.RGBA,s.UNSIGNED_BYTE,l),this._arCtrl._cameraRenderMode=="towCanvas"){const h=new Uint8Array(n*o*4);a.readPixels(0,0,n,o,a.RGBA,a.UNSIGNED_BYTE,h),t([{width:n,height:o,data:this._flip(h,n,o,4)},{width:n,height:o,data:this._flip(l,n,o,4)}])}else t([{width:n,height:o,data:this._flip(l,n,o,4)}])}else e("\u5FAE\u4FE1\u5E73\u53F0\u6682\u4E0D\u652F\u6301 base64 \u683C\u5F0F")})})}async isSupport(){if(console.warn("isSupport \u65B9\u6CD5\u5DF2\u5E9F\u5F03\uFF0C\u8BF7\u4F7F\u7528 queryARSupport \u65B9\u6CD5"),tt.instance.isAliPay){if(tt.instance.isAndroid)return await _t.canIUse();if(tt.instance.isIos)return await te.canIUse()}else if(tt.instance.isWeChat)return await Qt.canIUse();return!1}async queryARSupport(r,t){if(tt.instance.isAliPay){if(r&&I.log("\u652F\u4ED8\u5B9D\u5E73\u53F0\u65E0\u6CD5\u4F7F\u7528\u9ED1\u540D\u5355\u529F\u80FD"),tt.instance.isAndroid)return await _t.queryARSupport();if(tt.instance.isIos)return await te.queryARSupport()}else if(tt.instance.isWeChat){let e=null;I.info("---deviceModel---"),I.info(tt.instance.deviceModel),r&&(e=dr(t||fr,tt.instance.deviceModel));let i=await Qt.queryARSupport();return e?{arBaseMode:Math.max(e.arBaseMode,i.arBaseMode),arTrackMode:Math.min(e.arTrackMode,i.arTrackMode)}:i}}_flip(r,t,e,i){if(!t||!e)throw Error("Bad dimensions");i||(i=r.length/(t*e));for(var s=e>>1,a=t*i,n=new Uint8Array(t*i),o=0;o<s;++o){var l=o*a,h=(e-o-1)*a;n.set(r.subarray(l,l+a)),r.copyWithin(l,h,h+a),r.set(n,h)}return r}};let ot=ae;ot._instance=null;function pr(r){const t=r.getContext("webgl",{antialias:!1,useDevicePixelRatio:!0,alpha:!0,preserveDrawingBuffer:!1,preferWebGl2:!1});t&&(t.clear(t.COLOR_BUFFER_BIT),t.clear(t.DEPTH_BUFFER_BIT),t.clear(t.STENCIL_BUFFER_BIT))}class gr{constructor(t){this.name="TinyARPlugin",this._arConfig=null,this.onSessionCreate=null,this.onSessionStart=null,this.onSessionCreateFail=null,this._arConfig=t,this._arConfig.clsConfig&&(this._arConfig.trackMode=P.Dof6)}onTinyLuncherInited(t,e){ot.instance.create(t.pc,t.app,this._arConfig,()=>{t.camera.script||t.camera.addComponent("script"),t.camera.script.has("sdsArBg")||t.camera.script.create("sdsArBg"),t.camera.script.has("sdsArCamera")||t.camera.script.create("sdsArCamera"),this.onSessionCreate&&this.onSessionCreate(),ot.instance.start(()=>{this.onSessionStart&&this.onSessionStart()})},()=>{console.error("ARManager create fail"),this.onSessionCreateFail&&this.onSessionCreateFail()})}onDestroy(t,e){ot.instance.destroy()}}nt.ARManager=ot,nt.ARSdk=Q,nt.ARTrackMode=P,nt.BlockController=re,nt.CLSClient=Gi,nt.EventHandler=de,nt.PoseFusion=pe,nt.Recognizer_alipay_android=ii,nt.Recognizer_wx_easyar=se,nt.TinyARPlugin=gr,nt.clearWebglCanvas=pr,nt.easyar=$s,nt.systemInfo=tt,Object.defineProperties(nt,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});

 console.log("use tiny-ar-plugin v1.5.2-dev1");